# 山东省思政课一体化中心 - 辅助开发上下文指南

## 🎯 项目概览

### 核心信息

- **域名**: https://horsduroot.com
- **服务器**: 阿里云ECS (60.205.124.67)
- **技术栈**: Ubuntu 20.04 + Nginx + Node.js + MongoDB + PM2
- **SSL**: Let's Encrypt (自动续期)

### 技术栈详细规范

#### 前端技术栈

- **核心框架**: Vue 3.3.4 + TypeScript 5.2.0
- **构建工具**: Vite 4.4.9
- **UI组件库**: Element Plus 2.3.14 + Ant Design Vue 4.0.3
- **状态管理**: Pinia 2.1.6 + 持久化插件
- **路由**: Vue Router 4.2.4
- **HTTP客户端**: Axios 1.9.0
- **开发工具**: ESLint + Prettier + Husky

#### 后端技术栈

- **运行环境**: Node.js (ES Modules)
- **Web框架**: Express 4.18.2
- **数据库**: MongoDB + Mongoose 8.1.1
- **认证**: JWT + bcrypt
- **安全**: helmet, cors, rate-limit
- **文件上传**: multer
- **进程管理**: PM2

#### ES Modules规范

- **模块类型**: `"type": "module"` 完全使用ES模块
- **导入语法**: `import { ... } from '...'`
- **导出语法**: `export default` / `export const`
- **文件扩展名**: `.js`, `.ts`, `.vue` 需明确指定
- **路径别名**: `@/*` 映射到 `./src/*`

#### TypeScript配置

- **编译目标**: ESNext
- **模块系统**: ESNext + bundler解析
- **严格模式**: 启用
- **路径映射**: `@/*` → `./src/*`
- **JSX支持**: 保留模式，支持Vue SFC

## 📁 项目结构和文件组织

### 前端目录结构

```
src/
├── api/          # API接口定义和HTTP请求
├── assets/       # 静态资源(图片、字体等)
├── components/   # 公共组件
├── composables/  # Vue3组合式函数
├── config/       # 应用配置文件
├── directives/   # 自定义Vue指令
├── router/       # Vue Router路由配置
├── stores/       # Pinia状态管理
├── styles/       # 全局样式和主题
├── types/        # TypeScript类型定义
├── utils/        # 工具函数和辅助方法
└── views/        # 页面组件
```

### 后端目录结构

```
server/
├── controllers/  # 控制器层(业务逻辑)
├── models/       # 数据模型(Mongoose Schema)
├── routes/       # 路由定义
├── middleware/   # 中间件(认证、验证、错误处理)
├── utils/        # 服务端工具函数
├── scripts/      # 数据库脚本和工具
├── uploads/      # 文件上传存储目录
├── migrations/   # 数据库迁移文件
└── seeds/        # 数据库种子数据
```

### 文件引用规范

- **模块导入**: 使用ES Modules语法
- **路径别名**: `@/` 指向 `src/` 目录
- **相对路径**: 同级目录使用 `./`，父级目录使用 `../`
- **组件导入**: 支持自动导入(unplugin-auto-import)
- **静态资源**: 通过 `import` 或 `/src/assets/` 路径引用

## 🔧 环境配置详解

### 📋 环境配置文件结构

项目使用4个核心环境配置文件，分别服务于不同的开发和部署场景：

```
.env.development          # 前端开发环境配置
.env.aliyun               # 前端生产环境配置（阿里云部署）
server/.env               # 后端开发环境配置
server/.env.production    # 后端生产环境配置
server-dist/.env          # 自动生成（部署时从.env.production复制）
```

### 🎯 前端环境变量配置

#### 开发环境 (`.env.development`)

**用途**: 本地开发时使用，配合 `npm run dev` 命令

```bash
# 开发环境配置
NODE_ENV=development

# API配置 - 开发环境使用相对路径，让Vite代理处理
VITE_API_BASE_URL=
VITE_API_MOCK=false

# 调试配置
VITE_APP_DEBUG=true
VITE_ENABLE_LOGGER=true

# 缓存配置
VITE_CACHE_ENABLED=true
VITE_CACHE_TTL=60 # 开发环境缓存1分钟
```

**特点**:

- API_BASE_URL 为空，利用Vite开发服务器代理
- 启用调试和日志功能
- 短缓存时间，便于开发调试

#### 生产环境 (`.env.aliyun`)

**用途**: 阿里云生产部署，配合 `npm run build:aliyun` 命令

```bash
# 阿里云生产环境配置
NODE_ENV=production

# API配置 - 使用相对路径（前后端同域）
VITE_API_BASE_URL=/api
VITE_API_MOCK=false

# 调试配置
VITE_APP_DEBUG=false
VITE_ENABLE_LOGGER=false

# 缓存配置
VITE_CACHE_ENABLED=true
VITE_CACHE_TTL=3600

# 性能配置
VITE_ENABLE_COMPRESSION=true
VITE_COMPRESSION_THRESHOLD=1024

# 项目配置
VITE_APP_TITLE=山东省思想政治理论课
VITE_APP_VERSION=1.0.0
```

**特点**:

- 使用相对路径 `/api`，前后端同域部署
- 禁用调试功能，优化性能
- 启用压缩和长时间缓存

### 🖥️ 后端环境变量配置

#### 开发环境 (`server/.env`)

**用途**: 本地后端开发，配合 `npm run server:dev` 命令

```properties
# 服务器配置
PORT=3000
NODE_ENV=development
BASE_URL=http://localhost:3000

# MongoDB配置
MONGODB_URI=mongodb://localhost:27017/sdszk

# JWT配置
JWT_SECRET=sdszk_2025_secure_jwt_secret_key
JWT_EXPIRES_IN=7d

# 上传配置
UPLOAD_DIR=uploads
MAX_FILE_SIZE=10485760

# 跨域配置
ALLOWED_ORIGINS=http://localhost:5173
FRONTEND_URL=https://horsduroot.com,https://www.horsduroot.com
```

**特点**:

- 数据库名称：`sdszk`（开发环境）
- 允许本地前端开发服务器跨域访问
- 使用开发专用JWT密钥

#### 生产环境 (`server/.env.production`)

**用途**: 阿里云服务器部署，由部署脚本自动使用

```bash
# 生产环境配置
PORT=3000
NODE_ENV=production

# MongoDB配置
MONGODB_URI=mongodb://localhost:27017/sdszk-db

# JWT配置
JWT_SECRET=Q7+tBMc9VDon0Fya0WSUxsmQIrSFcL2KzK4SNp4axnM=
JWT_EXPIRES_IN=7d

# 跨域配置
FRONTEND_URL=https://horsduroot.com,https://www.horsduroot.com
ALLOWED_ORIGINS=https://horsduroot.com,https://www.horsduroot.com

# 上传文件存储路径
UPLOAD_PATH=./uploads

# 日志配置
LOG_LEVEL=error
LOG_FILE=./logs/app.log

# 限流配置
RATE_LIMIT_WINDOW_MS=3600000
RATE_LIMIT_MAX=100

# 缓存配置
CACHE_ENABLED=true
CACHE_TTL=3600

# 服务器公共路径
SERVER_PUBLIC_URL=https://horsduroot.com
```

**特点**:

- 数据库名称：`sdszk-db`（生产环境）
- 使用安全的JWT密钥
- 配置生产域名和严格的CORS策略
- 启用限流和缓存优化

### 🔄 配置文件使用流程

#### 开发流程

```bash
# 前端开发
npm run dev                    # 使用 .env.development

# 后端开发
npm run server:dev             # 使用 server/.env
```

#### 部署流程

```bash
# 前端部署
npm run build:aliyun           # 使用 .env.aliyun
./scripts/deploy.sh

# 后端部署
./scripts/deploy-backend.sh    # 自动使用 server/.env.production
                              # 复制为 server-dist/.env
```

### ⚠️ 配置注意事项

1. **数据库名称差异**:

   - 开发环境：`sdszk`
   - 生产环境：`sdszk-db`

2. **JWT密钥管理**:

   - 开发环境：使用简单密钥便于调试
   - 生产环境：使用高强度密钥确保安全

3. **CORS策略**:

   - 开发环境：允许本地开发服务器
   - 生产环境：仅允许正式域名

4. **自动化部署**:
   - `server-dist/.env` 由部署脚本自动生成
   - 不需要手动编辑

### 🏗️ 构建配置差异

项目使用不同的构建配置来适应不同的部署环境：

#### 开发构建

- **命令**: `npm run build`
- **配置文件**: `vite.config.ts`
- **环境变量**: 自动加载 `.env.development`
- **特点**: 包含调试信息，未压缩

#### 生产构建（阿里云）

- **命令**: `npm run build:aliyun`
- **配置文件**: `vite.config.aliyun.ts`
- **环境变量**: 明确指定使用 `.env.aliyun`
- **特点**: 代码分割、压缩、性能优化

#### 部署脚本对应关系

```bash
# 前端部署（使用.env.aliyun）
./scripts/deploy.sh
└── npm run build:aliyun
    └── vite.config.aliyun.ts
    └── .env.aliyun

# 后端部署（使用server/.env.production）
./scripts/deploy-backend.sh
└── cp server/.env.production → server-dist/.env
```

## 🚀 部署脚本约定

项目提供三种不同的部署方式，适用于不同的场景和需求：

### 1. 前端部署脚本 - `scripts/deploy.sh` ✅

**用途**: 专门用于前端静态文件部署

**特点**:

- 使用 `.env.aliyun` 环境配置
- 使用 `vite.config.aliyun.ts` 构建配置
- 执行 `npm run build:aliyun` 进行阿里云专用构建
- 不生成新的 nginx 配置，只重载现有配置
- 包含备份机制和权限设置

**使用场景**:

- 前端代码更新
- UI界面调整
- 静态资源更新
- 日常迭代部署

**执行命令**:

```bash
./scripts/deploy.sh
```

**关键配置**:

- 构建命令: `npm run build:aliyun`
- 部署路径: `/var/www/frontend`
- 健康检查: `https://horsduroot.com`

### 2. 后端部署脚本 - `scripts/deploy-backend.sh` ✅

**用途**: 专门用于后端API服务部署

**特点**:

- 使用 PM2 进程管理
- 支持生产环境配置覆盖
- 包含服务重启和健康检查
- 自动处理依赖安装和文件权限

**使用场景**:

- 后端API更新
- 数据库配置修改
- 服务器端逻辑变更
- CORS配置更新

**执行命令**:

```bash
./scripts/deploy-backend.sh
```

**关键配置**:

- 源目录: `./server/`
- 构建目录: `./server-dist/`
- PM2应用名: `sdszk-backend`
- 健康检查: `http://localhost:3000/api/health`

### 3. Docker容器部署脚本 - `scripts/deploy-prod.sh` 🐳

**用途**: 完整的容器化部署方案

**特点**:

- 使用 Docker Compose 编排
- 包含数据库、缓存、应用等完整栈
- 支持环境变量配置
- 适合新环境搭建或完整重部署

**使用场景**:

- 新服务器环境搭建
- 完整系统重新部署
- 开发环境快速搭建
- 灾难恢复

**执行命令**:

```bash
# 需要先设置环境变量
export MONGO_PASSWORD="your_password"
export REDIS_PASSWORD="your_password"
export JWT_SECRET="your_secret"

./scripts/deploy-prod.sh
```

**关键配置**:

- 配置文件: `docker-compose.prod.yml`
- 健康检查: `http://localhost:3000/api/health`
- 日志目录: `./logs/`

### 📋 部署脚本选择指南

| 更新类型     | 推荐脚本                    | 说明               |
| ------------ | --------------------------- | ------------------ |
| 前端UI更新   | `deploy.sh`                 | 只需更新静态文件   |
| 后端API更新  | `deploy-backend.sh`         | 只需重启后端服务   |
| 配置文件修改 | `deploy-backend.sh`         | 重新加载配置       |
| 数据库迁移   | `migrate-database-clean.sh` | 本地数据同步到云端 |
| 完整重部署   | `deploy-prod.sh`            | 容器化完整部署     |
| 新环境搭建   | `deploy-prod.sh`            | 包含所有依赖服务   |

### ⚠️ 部署注意事项

1. **前端部署** (`deploy.sh`):

   - 会检查 Git 状态，建议部署前提交代码
   - 支持备份现有文件（10秒超时选择）
   - 构建时会显示文件大小警告（正常现象）

2. **后端部署** (`deploy-backend.sh`):

   - 需要确保 `./server/.env.production` 文件存在
   - 部署过程中服务会短暂中断
   - 自动处理 PM2 进程管理

3. **Docker部署** (`deploy-prod.sh`):
   - 需要设置必要的环境变量
   - 会清理旧容器和镜像
   - 启动时间较长（约30秒）

### 🔄 Git工作流和版本管理

#### 分支策略

```bash
main          # 主分支，生产环境代码
origin/main   # 远程主分支
origin/gh-pages # GitHub Pages分支(如果有)
```

#### 提交规范

```bash
# Commit Message格式
feat: 新功能
fix: 修复bug
docs: 文档更新
style: 代码格式
refactor: 重构
test: 测试相关
chore: 构建/工具相关

# 示例
feat: 添加用户权限管理功能
fix: 修复登录状态异常问题
docs: 更新API文档
```

#### Git Hooks自动化

```bash
# 提交前自动执行 (husky + lint-staged)
1. ESLint代码检查
2. Prettier代码格式化
3. TypeScript类型检查
4. 测试用例执行(可选)
```

#### 发布流程

```bash
# 日常开发
git add .
git commit -m "feat: 添加新功能"
git push origin main

# 前端部署
./scripts/deploy.sh

# 后端部署
./scripts/deploy-backend.sh

# 数据库迁移
./scripts/migrate-database-clean.sh
```

## 🎯 开发最佳实践总结

### 代码规范

- **命名约定**: 使用驼峰命名法，组件使用PascalCase
- **文件组织**: 按功能模块分组，保持目录结构清晰
- **类型安全**: 充分利用TypeScript类型系统
- **组件设计**: 遵循单一职责原则，提高复用性

### 性能优化

- **代码分割**: 利用Vite的自动代码分割
- **懒加载**: 路由和组件按需加载
- **缓存策略**: 合理配置前端缓存
- **API优化**: 使用频率限制和数据分页

### 安全考虑

- **认证授权**: JWT令牌 + 角色权限控制
- **输入验证**: 前后端双重验证
- **CORS配置**: 严格的跨域策略
- **敏感信息**: 环境变量管理

### 调试技巧

- **分层调试**: 前端→API→数据库逐层排查
- **日志记录**: 合理使用console.log和morgan
- **错误处理**: 统一的错误处理机制
- **监控工具**: 利用开发者工具和扩展

---

## 📚 相关文档索引

### 技术文档

- [Vue3基础架构技术文档.md](./Vue3基础架构技术文档.md)
- [Vue3组件层架构技术文档.md](./Vue3公共组件层架构技术文档.md)
- [Vue3状态管理层架构技术文档.md](./Vue3状态管理层架构技术文档.md)
- [Vue3路由与导航层架构技术文档.md](./Vue3路由与导航层架构技术文档.md)
- [Vue3工具与复用层架构技术文档.md](./Vue3工具与复用层架构技术文档.md)

### 部署文档

- [阿里云部署调试指南.md](./aliyun-tools/阿里云部署调试指南.md)
- [API参数说明.md](./server/docs/API参数说明-20240613.md)

### 快速参考

- **管理员登录**: https://horsduroot.com/login/admin
- **API健康检查**: https://horsduroot.com/api/health
- **服务器地址**: 60.205.124.67
- **数据库**: 本地`sdszk` → 生产`sdszk-db`

---

**最后更新**: 2025-06-20  
**版本**: v1.0.0  
**状态**: ✅ 完整的开发上下文指南，包含技术栈、环境配置、部署流程和最佳实践  
**适用范围**: Vue3 + Node.js + MongoDB技术栈的全栈开发项目

---

## 🛠️ 部署调试技巧补充

### 环境文件部署验证流程

当遇到环境变量配置问题时，使用以下完整验证流程：

1. **本地验证**：检查源文件存在性和内容

   ```bash
   ls -la server/.env.production
   cat server/.env.production
   ```

2. **打包验证**：确认环境文件被包含在部署包中

   ```bash
   unzip -l server-deploy.zip | grep -E "\\.env"
   ```

3. **服务器文件验证**：确认文件已上传

   ```bash
   ssh user@server "ls -la /var/www/sdszk-backend/.env"
   ```

4. **服务器内容验证**：确认文件内容正确

   ```bash
   ssh user@server "cat /var/www/sdszk-backend/.env"
   ```

5. **应用加载验证**：确认环境变量生效
   ```bash
   ssh user@server "curl -s http://localhost:3000/api/health"
   ```

### zip打包隐藏文件注意事项

- ❌ **错误写法**：`zip -r package.zip ./` 或 `zip -r package.zip ./*` (不包含隐藏文件)
- ✅ **正确写法**：`zip -r package.zip .` (包含所有文件包括隐藏文件)
- **验证方法**：`unzip -l package.zip | grep -E "^\\s*[0-9]+.*\\."` 查看隐藏文件

### PM2环境变量诊断命令

```bash
# 查看进程详情
pm2 show <app-name>

# 查看环境变量
pm2 env <process-id>

# 测试dotenv加载
node -e "require('dotenv').config(); console.log('KEY:', process.env.KEY);"

# 检查应用端口
netstat -tlnp | grep <port>
```

### 应用配置生效验证方法

```bash
# 健康检查端点验证环境信息
curl -s http://localhost:3000/api/health

# CORS验证
curl -H 'Origin: https://horsduroot.com' -I http://localhost:3000/api/health | grep access-control

# 数据库连接验证：通过健康检查API确认数据库状态
# 端口验证：确认应用监听正确端口
```

### 部署脚本调试技巧

- **分步验证**：每个关键步骤后添加验证命令
- **文件时间戳**：`ls -la` 确认文件更新时间
- **进程重启确认**：`pm2 status` 查看重启时间和状态
- **备份验证**：确认备份目录创建成功

### 常见环境文件问题排查清单

- □ 源文件是否存在且内容正确
- □ 复制命令是否正确执行
- □ zip打包是否包含隐藏文件
- □ 服务器解压是否成功
- □ 应用是否正确加载dotenv
- □ 环境变量是否在运行时生效
- □ PM2进程是否使用了正确的工作目录
