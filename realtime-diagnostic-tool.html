<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>实时诊断工具 - 重启后问题分析</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #333;
        min-height: 100vh;
      }
      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        overflow: hidden;
      }
      .header {
        background: linear-gradient(135deg, #ff6b6b, #4ecdc4);
        color: white;
        padding: 20px;
        text-align: center;
      }
      .header h1 {
        margin: 0;
        font-size: 2em;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }
      .main-content {
        padding: 30px;
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-bottom: 30px;
      }
      .panel {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        border: 1px solid #e9ecef;
      }
      .panel h3 {
        margin-top: 0;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
        padding-bottom: 10px;
      }
      .status {
        padding: 12px;
        border-radius: 6px;
        margin: 8px 0;
        font-weight: 500;
      }
      .status.success {
        background: #d4edda;
        color: #155724;
        border-left: 4px solid #28a745;
      }
      .status.error {
        background: #f8d7da;
        color: #721c24;
        border-left: 4px solid #dc3545;
      }
      .status.warning {
        background: #fff3cd;
        color: #856404;
        border-left: 4px solid #ffc107;
      }
      .status.info {
        background: #d1ecf1;
        color: #0c5460;
        border-left: 4px solid #17a2b8;
      }
      .buttons {
        text-align: center;
        margin: 20px 0;
      }
      .btn {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        margin: 5px;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
      }
      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }
      .btn.danger {
        background: linear-gradient(135deg, #ff6b6b, #ee5a24);
      }
      .btn.success {
        background: linear-gradient(135deg, #00b894, #00a085);
      }
      .log-container {
        grid-column: 1 / -1;
        background: #2d3748;
        color: #e2e8f0;
        border-radius: 8px;
        padding: 20px;
        font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
        font-size: 13px;
        max-height: 400px;
        overflow-y: auto;
        line-height: 1.5;
      }
      .timestamp {
        color: #68d391;
        font-weight: bold;
      }
      .error-text {
        color: #fc8181;
      }
      .success-text {
        color: #68d391;
      }
      .warning-text {
        color: #f6e05e;
      }
      .info-text {
        color: #63b3ed;
      }
      .section-divider {
        border-top: 2px solid #e9ecef;
        margin: 30px 0;
        padding-top: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>🔍 实时诊断工具</h1>
        <p>重启后问题分析 - 检查新闻管理功能状态</p>
      </div>

      <div class="main-content">
        <div class="buttons">
          <button class="btn" onclick="runQuickDiagnosis()">🚀 快速诊断</button>
          <button class="btn" onclick="runDetailedAnalysis()">🔬 详细分析</button>
          <button class="btn" onclick="runFrontendTest()">💻 前端测试</button>
          <button class="btn" onclick="runBackendTest()">🔧 后端测试</button>
          <button class="btn danger" onclick="clearLogs()">清空日志</button>
        </div>

        <div class="grid">
          <div class="panel">
            <h3>🎯 测试状态</h3>
            <div id="test-status"></div>
          </div>

          <div class="panel">
            <h3>📊 问题总结</h3>
            <div id="issue-summary"></div>
          </div>

          <div class="log-container">
            <div id="log">等待开始诊断...\n点击上方按钮开始测试</div>
          </div>
        </div>

        <div class="section-divider">
          <div class="panel">
            <h3>🛠️ 手动测试指南</h3>
            <div id="manual-guide">
              <div class="status info">
                <strong>测试步骤：</strong><br />
                1. 使用 admin/admin123 登录管理后台<br />
                2. 访问新闻列表页面 (/admin/news/list)<br />
                3. 尝试创建新新闻<br />
                4. 检查新闻是否在列表中显示<br />
                5. 查看浏览器控制台是否有错误信息
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let state = {
        loginToken: '',
        categories: [],
        testResults: {},
        issues: [],
      }

      function log(message, type = 'info') {
        const logElement = document.getElementById('log')
        const timestamp = new Date().toLocaleTimeString()
        const typeClass = `${type}-text`
        const icon =
          {
            error: '❌',
            success: '✅',
            warning: '⚠️',
            info: 'ℹ️',
          }[type] || 'ℹ️'

        logElement.innerHTML += `<span class="timestamp">[${timestamp}]</span> <span class="${typeClass}">${icon} ${message}</span>\n`
        logElement.scrollTop = logElement.scrollHeight
        updateUI()
      }

      function clearLogs() {
        document.getElementById('log').innerHTML = ''
        state.testResults = {}
        state.issues = []
        updateUI()
      }

      function updateUI() {
        updateTestStatus()
        updateIssueSummary()
      }

      function updateTestStatus() {
        const statusDiv = document.getElementById('test-status')
        let html = ''

        const tests = [
          { key: 'serverConnection', name: '服务器连接' },
          { key: 'login', name: '管理员登录' },
          { key: 'categories', name: '获取分类' },
          { key: 'newsList', name: '新闻列表' },
          { key: 'createNews', name: '创建新闻' },
          { key: 'dataFormat', name: '数据格式' },
        ]

        tests.forEach(test => {
          const result = state.testResults[test.key]
          let statusClass = 'info'
          let icon = '⏳'

          if (result === true) {
            statusClass = 'success'
            icon = '✅'
          } else if (result === false) {
            statusClass = 'error'
            icon = '❌'
          }

          html += `<div class="status ${statusClass}">${icon} ${test.name}</div>`
        })

        statusDiv.innerHTML = html
      }

      function updateIssueSummary() {
        const summaryDiv = document.getElementById('issue-summary')

        if (state.issues.length === 0) {
          summaryDiv.innerHTML = '<div class="status success">🎉 暂无发现问题</div>'
        } else {
          let html = `<div class="status error">🚨 发现 ${state.issues.length} 个问题：</div>`
          state.issues.forEach((issue, index) => {
            html += `<div class="status warning">${index + 1}. ${issue}</div>`
          })
          summaryDiv.innerHTML = html
        }
      }

      async function testServerConnection() {
        log('检查服务器连接状态...')

        try {
          // 测试后端连接
          const backendResponse = await fetch('http://localhost:3000/api/auth/me', {
            method: 'GET',
          })

          if (backendResponse.status === 401) {
            log('后端服务器连接正常 (返回401认证错误是正常的)', 'success')
            state.testResults.serverConnection = true
          } else {
            log(`后端服务器响应异常: ${backendResponse.status}`, 'warning')
          }

          // 测试前端连接
          const frontendResponse = await fetch('http://localhost:5173/')
          if (frontendResponse.ok) {
            log('前端服务器连接正常', 'success')
          } else {
            log('前端服务器连接异常', 'error')
            state.issues.push('前端服务器连接失败')
          }
        } catch (error) {
          log(`服务器连接测试失败: ${error.message}`, 'error')
          state.testResults.serverConnection = false
          state.issues.push('服务器连接失败')
        }
      }

      async function testLogin() {
        log('测试管理员登录...')

        try {
          const response = await fetch('http://localhost:3000/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              username: 'admin',
              password: 'admin123',
            }),
          })

          const data = await response.json()

          if (response.ok && data.status === 'success') {
            state.loginToken = data.data.token
            state.testResults.login = true
            log(`登录成功！Token: ${state.loginToken.substring(0, 20)}...`, 'success')
          } else {
            state.testResults.login = false
            log(`登录失败: ${data.message || '未知错误'}`, 'error')
            state.issues.push('管理员登录失败')
          }
        } catch (error) {
          state.testResults.login = false
          log(`登录请求异常: ${error.message}`, 'error')
          state.issues.push('登录请求异常')
        }
      }

      async function testCategories() {
        log('测试获取新闻分类...')

        try {
          const response = await fetch('http://localhost:3000/api/news-categories')
          const data = await response.json()

          if (response.ok && data.status === 'success') {
            state.categories = data.data
            state.testResults.categories = true
            log(`获取分类成功，共 ${state.categories.length} 个分类`, 'success')

            state.categories.forEach((cat, index) => {
              log(`  ${index + 1}. ${cat.name} (ID: ${cat._id})`, 'info')
            })
          } else {
            state.testResults.categories = false
            log(`获取分类失败: ${data.message || '未知错误'}`, 'error')
            state.issues.push('获取新闻分类失败')
          }
        } catch (error) {
          state.testResults.categories = false
          log(`获取分类异常: ${error.message}`, 'error')
          state.issues.push('获取分类请求异常')
        }
      }

      async function testNewsList() {
        if (!state.loginToken) {
          log('跳过新闻列表测试：需要先登录', 'warning')
          return
        }

        log('测试获取新闻列表...')

        try {
          const response = await fetch('http://localhost:3000/api/admin/news?page=1&limit=5', {
            headers: { Authorization: `Bearer ${state.loginToken}` },
          })

          const data = await response.json()

          if (response.ok && data.status === 'success') {
            const newsList = data.data.data
            const pagination = data.data.pagination

            state.testResults.newsList = true
            log(`获取新闻列表成功！`, 'success')
            log(`总数: ${pagination.total}, 当前页: ${newsList.length} 条`, 'info')

            if (newsList.length > 0) {
              const news = newsList[0]
              log(`第一条新闻: "${news.title}"`, 'info')
              log(`分类数据: ${JSON.stringify(news.category)}`, 'info')
              log(`作者数据: ${JSON.stringify(news.author)}`, 'info')

              // 检查数据格式
              let formatIssues = []
              if (!news._id) formatIssues.push('缺少_id字段')
              if (!news.title) formatIssues.push('缺少title字段')
              if (typeof news.category !== 'object' && typeof news.category !== 'string') {
                formatIssues.push('分类字段格式异常')
              }
              if (typeof news.author !== 'object') {
                formatIssues.push('作者字段格式异常')
              }

              if (formatIssues.length === 0) {
                state.testResults.dataFormat = true
                log('数据格式检查通过', 'success')
              } else {
                state.testResults.dataFormat = false
                log(`数据格式问题: ${formatIssues.join(', ')}`, 'error')
                state.issues.push('新闻数据格式异常')
              }
            } else {
              log('新闻列表为空', 'warning')
            }
          } else {
            state.testResults.newsList = false
            log(`获取新闻列表失败: ${data.message || '未知错误'}`, 'error')
            state.issues.push('获取新闻列表失败')
          }
        } catch (error) {
          state.testResults.newsList = false
          log(`获取新闻列表异常: ${error.message}`, 'error')
          state.issues.push('新闻列表请求异常')
        }
      }

      async function testCreateNews() {
        if (!state.loginToken || state.categories.length === 0) {
          log('跳过创建新闻测试：需要先登录并获取分类', 'warning')
          return
        }

        log('测试创建新闻...')

        try {
          const newsData = {
            title: `实时诊断测试新闻 - ${new Date().toLocaleString()}`,
            content: '这是实时诊断工具创建的测试新闻，用于验证重启后的功能状态。',
            summary: '实时诊断测试新闻摘要',
            category: state.categories[0]._id,
            status: 'published',
            tags: ['实时诊断', '重启测试'],
            isTop: false,
            isFeatured: false,
          }

          log(`创建新闻数据: ${JSON.stringify(newsData, null, 2)}`, 'info')

          const response = await fetch('http://localhost:3000/api/admin/news', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${state.loginToken}`,
            },
            body: JSON.stringify(newsData),
          })

          const data = await response.json()

          if (response.ok && data.status === 'success') {
            state.testResults.createNews = true
            log(`创建新闻成功！`, 'success')
            log(`新闻ID: ${data.data._id}`, 'info')
            log(`新闻标题: ${data.data.title}`, 'info')

            // 立即验证是否出现在列表中
            setTimeout(() => {
              log('等待1秒后验证新闻是否出现在列表中...', 'info')
              testNewsList()
            }, 1000)

            return data.data._id
          } else {
            state.testResults.createNews = false
            log(`创建新闻失败: ${data.message || '未知错误'}`, 'error')
            state.issues.push('创建新闻失败')
          }
        } catch (error) {
          state.testResults.createNews = false
          log(`创建新闻异常: ${error.message}`, 'error')
          state.issues.push('创建新闻请求异常')
        }
      }

      async function runQuickDiagnosis() {
        log('🚀 开始快速诊断...', 'info')
        log('====================================', 'info')

        clearLogs()
        state.issues = []

        await testServerConnection()
        await sleep(300)
        await testLogin()
        await sleep(300)
        await testCategories()
        await sleep(300)
        await testNewsList()

        log('====================================', 'info')
        log('🚀 快速诊断完成', 'success')

        generateSummary()
      }

      async function runDetailedAnalysis() {
        log('🔬 开始详细分析...', 'info')
        log('====================================', 'info')

        clearLogs()
        state.issues = []

        await testServerConnection()
        await sleep(500)
        await testLogin()
        await sleep(500)
        await testCategories()
        await sleep(500)
        await testNewsList()
        await sleep(500)
        await testCreateNews()

        log('====================================', 'info')
        log('🔬 详细分析完成', 'success')

        generateSummary()
      }

      async function runFrontendTest() {
        log('💻 开始前端测试...', 'info')
        log('检查前端特定的问题...', 'info')

        // 这里可以添加前端特定的测试
        log('提示：请打开浏览器开发者工具查看Console和Network面板', 'warning')
        log('前端测试完成', 'success')
      }

      async function runBackendTest() {
        log('🔧 开始后端测试...', 'info')

        await testServerConnection()
        await testLogin()
        await testCategories()

        log('🔧 后端测试完成', 'success')
      }

      function generateSummary() {
        const totalTests = Object.keys(state.testResults).length
        const passedTests = Object.values(state.testResults).filter(Boolean).length

        log('', 'info')
        log('📋 测试总结报告', 'info')
        log('====================================', 'info')
        log(`总测试项: ${totalTests}`, 'info')
        log(`通过测试: ${passedTests}`, 'success')
        log(
          `失败测试: ${totalTests - passedTests}`,
          passedTests === totalTests ? 'success' : 'error'
        )
        log(`发现问题: ${state.issues.length}`, state.issues.length === 0 ? 'success' : 'error')

        if (state.issues.length > 0) {
          log('', 'info')
          log('🚨 问题列表:', 'error')
          state.issues.forEach((issue, index) => {
            log(`${index + 1}. ${issue}`, 'error')
          })
        } else {
          log('', 'info')
          log('🎉 所有测试通过，系统运行正常！', 'success')
        }

        log('====================================', 'info')
      }

      function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms))
      }

      // 初始化
      window.onload = function () {
        log('🔍 实时诊断工具已加载', 'success')
        log('点击上方按钮开始测试', 'info')
        updateUI()
      }
    </script>
  </body>
</html>
