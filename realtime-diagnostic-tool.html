<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å®æ—¶è¯Šæ–­å·¥å…· - é‡å¯åé—®é¢˜åˆ†æ</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #333;
        min-height: 100vh;
      }
      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        overflow: hidden;
      }
      .header {
        background: linear-gradient(135deg, #ff6b6b, #4ecdc4);
        color: white;
        padding: 20px;
        text-align: center;
      }
      .header h1 {
        margin: 0;
        font-size: 2em;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }
      .main-content {
        padding: 30px;
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-bottom: 30px;
      }
      .panel {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        border: 1px solid #e9ecef;
      }
      .panel h3 {
        margin-top: 0;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
        padding-bottom: 10px;
      }
      .status {
        padding: 12px;
        border-radius: 6px;
        margin: 8px 0;
        font-weight: 500;
      }
      .status.success {
        background: #d4edda;
        color: #155724;
        border-left: 4px solid #28a745;
      }
      .status.error {
        background: #f8d7da;
        color: #721c24;
        border-left: 4px solid #dc3545;
      }
      .status.warning {
        background: #fff3cd;
        color: #856404;
        border-left: 4px solid #ffc107;
      }
      .status.info {
        background: #d1ecf1;
        color: #0c5460;
        border-left: 4px solid #17a2b8;
      }
      .buttons {
        text-align: center;
        margin: 20px 0;
      }
      .btn {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        margin: 5px;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
      }
      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }
      .btn.danger {
        background: linear-gradient(135deg, #ff6b6b, #ee5a24);
      }
      .btn.success {
        background: linear-gradient(135deg, #00b894, #00a085);
      }
      .log-container {
        grid-column: 1 / -1;
        background: #2d3748;
        color: #e2e8f0;
        border-radius: 8px;
        padding: 20px;
        font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
        font-size: 13px;
        max-height: 400px;
        overflow-y: auto;
        line-height: 1.5;
      }
      .timestamp {
        color: #68d391;
        font-weight: bold;
      }
      .error-text {
        color: #fc8181;
      }
      .success-text {
        color: #68d391;
      }
      .warning-text {
        color: #f6e05e;
      }
      .info-text {
        color: #63b3ed;
      }
      .section-divider {
        border-top: 2px solid #e9ecef;
        margin: 30px 0;
        padding-top: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸ” å®æ—¶è¯Šæ–­å·¥å…·</h1>
        <p>é‡å¯åé—®é¢˜åˆ†æ - æ£€æŸ¥æ–°é—»ç®¡ç†åŠŸèƒ½çŠ¶æ€</p>
      </div>

      <div class="main-content">
        <div class="buttons">
          <button class="btn" onclick="runQuickDiagnosis()">ğŸš€ å¿«é€Ÿè¯Šæ–­</button>
          <button class="btn" onclick="runDetailedAnalysis()">ğŸ”¬ è¯¦ç»†åˆ†æ</button>
          <button class="btn" onclick="runFrontendTest()">ğŸ’» å‰ç«¯æµ‹è¯•</button>
          <button class="btn" onclick="runBackendTest()">ğŸ”§ åç«¯æµ‹è¯•</button>
          <button class="btn danger" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
        </div>

        <div class="grid">
          <div class="panel">
            <h3>ğŸ¯ æµ‹è¯•çŠ¶æ€</h3>
            <div id="test-status"></div>
          </div>

          <div class="panel">
            <h3>ğŸ“Š é—®é¢˜æ€»ç»“</h3>
            <div id="issue-summary"></div>
          </div>

          <div class="log-container">
            <div id="log">ç­‰å¾…å¼€å§‹è¯Šæ–­...\nç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•</div>
          </div>
        </div>

        <div class="section-divider">
          <div class="panel">
            <h3>ğŸ› ï¸ æ‰‹åŠ¨æµ‹è¯•æŒ‡å—</h3>
            <div id="manual-guide">
              <div class="status info">
                <strong>æµ‹è¯•æ­¥éª¤ï¼š</strong><br />
                1. ä½¿ç”¨ admin/admin123 ç™»å½•ç®¡ç†åå°<br />
                2. è®¿é—®æ–°é—»åˆ—è¡¨é¡µé¢ (/admin/news/list)<br />
                3. å°è¯•åˆ›å»ºæ–°æ–°é—»<br />
                4. æ£€æŸ¥æ–°é—»æ˜¯å¦åœ¨åˆ—è¡¨ä¸­æ˜¾ç¤º<br />
                5. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let state = {
        loginToken: '',
        categories: [],
        testResults: {},
        issues: [],
      }

      function log(message, type = 'info') {
        const logElement = document.getElementById('log')
        const timestamp = new Date().toLocaleTimeString()
        const typeClass = `${type}-text`
        const icon =
          {
            error: 'âŒ',
            success: 'âœ…',
            warning: 'âš ï¸',
            info: 'â„¹ï¸',
          }[type] || 'â„¹ï¸'

        logElement.innerHTML += `<span class="timestamp">[${timestamp}]</span> <span class="${typeClass}">${icon} ${message}</span>\n`
        logElement.scrollTop = logElement.scrollHeight
        updateUI()
      }

      function clearLogs() {
        document.getElementById('log').innerHTML = ''
        state.testResults = {}
        state.issues = []
        updateUI()
      }

      function updateUI() {
        updateTestStatus()
        updateIssueSummary()
      }

      function updateTestStatus() {
        const statusDiv = document.getElementById('test-status')
        let html = ''

        const tests = [
          { key: 'serverConnection', name: 'æœåŠ¡å™¨è¿æ¥' },
          { key: 'login', name: 'ç®¡ç†å‘˜ç™»å½•' },
          { key: 'categories', name: 'è·å–åˆ†ç±»' },
          { key: 'newsList', name: 'æ–°é—»åˆ—è¡¨' },
          { key: 'createNews', name: 'åˆ›å»ºæ–°é—»' },
          { key: 'dataFormat', name: 'æ•°æ®æ ¼å¼' },
        ]

        tests.forEach(test => {
          const result = state.testResults[test.key]
          let statusClass = 'info'
          let icon = 'â³'

          if (result === true) {
            statusClass = 'success'
            icon = 'âœ…'
          } else if (result === false) {
            statusClass = 'error'
            icon = 'âŒ'
          }

          html += `<div class="status ${statusClass}">${icon} ${test.name}</div>`
        })

        statusDiv.innerHTML = html
      }

      function updateIssueSummary() {
        const summaryDiv = document.getElementById('issue-summary')

        if (state.issues.length === 0) {
          summaryDiv.innerHTML = '<div class="status success">ğŸ‰ æš‚æ— å‘ç°é—®é¢˜</div>'
        } else {
          let html = `<div class="status error">ğŸš¨ å‘ç° ${state.issues.length} ä¸ªé—®é¢˜ï¼š</div>`
          state.issues.forEach((issue, index) => {
            html += `<div class="status warning">${index + 1}. ${issue}</div>`
          })
          summaryDiv.innerHTML = html
        }
      }

      async function testServerConnection() {
        log('æ£€æŸ¥æœåŠ¡å™¨è¿æ¥çŠ¶æ€...')

        try {
          // æµ‹è¯•åç«¯è¿æ¥
          const backendResponse = await fetch('http://localhost:3000/api/auth/me', {
            method: 'GET',
          })

          if (backendResponse.status === 401) {
            log('åç«¯æœåŠ¡å™¨è¿æ¥æ­£å¸¸ (è¿”å›401è®¤è¯é”™è¯¯æ˜¯æ­£å¸¸çš„)', 'success')
            state.testResults.serverConnection = true
          } else {
            log(`åç«¯æœåŠ¡å™¨å“åº”å¼‚å¸¸: ${backendResponse.status}`, 'warning')
          }

          // æµ‹è¯•å‰ç«¯è¿æ¥
          const frontendResponse = await fetch('http://localhost:5173/')
          if (frontendResponse.ok) {
            log('å‰ç«¯æœåŠ¡å™¨è¿æ¥æ­£å¸¸', 'success')
          } else {
            log('å‰ç«¯æœåŠ¡å™¨è¿æ¥å¼‚å¸¸', 'error')
            state.issues.push('å‰ç«¯æœåŠ¡å™¨è¿æ¥å¤±è´¥')
          }
        } catch (error) {
          log(`æœåŠ¡å™¨è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error')
          state.testResults.serverConnection = false
          state.issues.push('æœåŠ¡å™¨è¿æ¥å¤±è´¥')
        }
      }

      async function testLogin() {
        log('æµ‹è¯•ç®¡ç†å‘˜ç™»å½•...')

        try {
          const response = await fetch('http://localhost:3000/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              username: 'admin',
              password: 'admin123',
            }),
          })

          const data = await response.json()

          if (response.ok && data.status === 'success') {
            state.loginToken = data.data.token
            state.testResults.login = true
            log(`ç™»å½•æˆåŠŸï¼Token: ${state.loginToken.substring(0, 20)}...`, 'success')
          } else {
            state.testResults.login = false
            log(`ç™»å½•å¤±è´¥: ${data.message || 'æœªçŸ¥é”™è¯¯'}`, 'error')
            state.issues.push('ç®¡ç†å‘˜ç™»å½•å¤±è´¥')
          }
        } catch (error) {
          state.testResults.login = false
          log(`ç™»å½•è¯·æ±‚å¼‚å¸¸: ${error.message}`, 'error')
          state.issues.push('ç™»å½•è¯·æ±‚å¼‚å¸¸')
        }
      }

      async function testCategories() {
        log('æµ‹è¯•è·å–æ–°é—»åˆ†ç±»...')

        try {
          const response = await fetch('http://localhost:3000/api/news-categories')
          const data = await response.json()

          if (response.ok && data.status === 'success') {
            state.categories = data.data
            state.testResults.categories = true
            log(`è·å–åˆ†ç±»æˆåŠŸï¼Œå…± ${state.categories.length} ä¸ªåˆ†ç±»`, 'success')

            state.categories.forEach((cat, index) => {
              log(`  ${index + 1}. ${cat.name} (ID: ${cat._id})`, 'info')
            })
          } else {
            state.testResults.categories = false
            log(`è·å–åˆ†ç±»å¤±è´¥: ${data.message || 'æœªçŸ¥é”™è¯¯'}`, 'error')
            state.issues.push('è·å–æ–°é—»åˆ†ç±»å¤±è´¥')
          }
        } catch (error) {
          state.testResults.categories = false
          log(`è·å–åˆ†ç±»å¼‚å¸¸: ${error.message}`, 'error')
          state.issues.push('è·å–åˆ†ç±»è¯·æ±‚å¼‚å¸¸')
        }
      }

      async function testNewsList() {
        if (!state.loginToken) {
          log('è·³è¿‡æ–°é—»åˆ—è¡¨æµ‹è¯•ï¼šéœ€è¦å…ˆç™»å½•', 'warning')
          return
        }

        log('æµ‹è¯•è·å–æ–°é—»åˆ—è¡¨...')

        try {
          const response = await fetch('http://localhost:3000/api/admin/news?page=1&limit=5', {
            headers: { Authorization: `Bearer ${state.loginToken}` },
          })

          const data = await response.json()

          if (response.ok && data.status === 'success') {
            const newsList = data.data.data
            const pagination = data.data.pagination

            state.testResults.newsList = true
            log(`è·å–æ–°é—»åˆ—è¡¨æˆåŠŸï¼`, 'success')
            log(`æ€»æ•°: ${pagination.total}, å½“å‰é¡µ: ${newsList.length} æ¡`, 'info')

            if (newsList.length > 0) {
              const news = newsList[0]
              log(`ç¬¬ä¸€æ¡æ–°é—»: "${news.title}"`, 'info')
              log(`åˆ†ç±»æ•°æ®: ${JSON.stringify(news.category)}`, 'info')
              log(`ä½œè€…æ•°æ®: ${JSON.stringify(news.author)}`, 'info')

              // æ£€æŸ¥æ•°æ®æ ¼å¼
              let formatIssues = []
              if (!news._id) formatIssues.push('ç¼ºå°‘_idå­—æ®µ')
              if (!news.title) formatIssues.push('ç¼ºå°‘titleå­—æ®µ')
              if (typeof news.category !== 'object' && typeof news.category !== 'string') {
                formatIssues.push('åˆ†ç±»å­—æ®µæ ¼å¼å¼‚å¸¸')
              }
              if (typeof news.author !== 'object') {
                formatIssues.push('ä½œè€…å­—æ®µæ ¼å¼å¼‚å¸¸')
              }

              if (formatIssues.length === 0) {
                state.testResults.dataFormat = true
                log('æ•°æ®æ ¼å¼æ£€æŸ¥é€šè¿‡', 'success')
              } else {
                state.testResults.dataFormat = false
                log(`æ•°æ®æ ¼å¼é—®é¢˜: ${formatIssues.join(', ')}`, 'error')
                state.issues.push('æ–°é—»æ•°æ®æ ¼å¼å¼‚å¸¸')
              }
            } else {
              log('æ–°é—»åˆ—è¡¨ä¸ºç©º', 'warning')
            }
          } else {
            state.testResults.newsList = false
            log(`è·å–æ–°é—»åˆ—è¡¨å¤±è´¥: ${data.message || 'æœªçŸ¥é”™è¯¯'}`, 'error')
            state.issues.push('è·å–æ–°é—»åˆ—è¡¨å¤±è´¥')
          }
        } catch (error) {
          state.testResults.newsList = false
          log(`è·å–æ–°é—»åˆ—è¡¨å¼‚å¸¸: ${error.message}`, 'error')
          state.issues.push('æ–°é—»åˆ—è¡¨è¯·æ±‚å¼‚å¸¸')
        }
      }

      async function testCreateNews() {
        if (!state.loginToken || state.categories.length === 0) {
          log('è·³è¿‡åˆ›å»ºæ–°é—»æµ‹è¯•ï¼šéœ€è¦å…ˆç™»å½•å¹¶è·å–åˆ†ç±»', 'warning')
          return
        }

        log('æµ‹è¯•åˆ›å»ºæ–°é—»...')

        try {
          const newsData = {
            title: `å®æ—¶è¯Šæ–­æµ‹è¯•æ–°é—» - ${new Date().toLocaleString()}`,
            content: 'è¿™æ˜¯å®æ—¶è¯Šæ–­å·¥å…·åˆ›å»ºçš„æµ‹è¯•æ–°é—»ï¼Œç”¨äºéªŒè¯é‡å¯åçš„åŠŸèƒ½çŠ¶æ€ã€‚',
            summary: 'å®æ—¶è¯Šæ–­æµ‹è¯•æ–°é—»æ‘˜è¦',
            category: state.categories[0]._id,
            status: 'published',
            tags: ['å®æ—¶è¯Šæ–­', 'é‡å¯æµ‹è¯•'],
            isTop: false,
            isFeatured: false,
          }

          log(`åˆ›å»ºæ–°é—»æ•°æ®: ${JSON.stringify(newsData, null, 2)}`, 'info')

          const response = await fetch('http://localhost:3000/api/admin/news', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${state.loginToken}`,
            },
            body: JSON.stringify(newsData),
          })

          const data = await response.json()

          if (response.ok && data.status === 'success') {
            state.testResults.createNews = true
            log(`åˆ›å»ºæ–°é—»æˆåŠŸï¼`, 'success')
            log(`æ–°é—»ID: ${data.data._id}`, 'info')
            log(`æ–°é—»æ ‡é¢˜: ${data.data.title}`, 'info')

            // ç«‹å³éªŒè¯æ˜¯å¦å‡ºç°åœ¨åˆ—è¡¨ä¸­
            setTimeout(() => {
              log('ç­‰å¾…1ç§’åéªŒè¯æ–°é—»æ˜¯å¦å‡ºç°åœ¨åˆ—è¡¨ä¸­...', 'info')
              testNewsList()
            }, 1000)

            return data.data._id
          } else {
            state.testResults.createNews = false
            log(`åˆ›å»ºæ–°é—»å¤±è´¥: ${data.message || 'æœªçŸ¥é”™è¯¯'}`, 'error')
            state.issues.push('åˆ›å»ºæ–°é—»å¤±è´¥')
          }
        } catch (error) {
          state.testResults.createNews = false
          log(`åˆ›å»ºæ–°é—»å¼‚å¸¸: ${error.message}`, 'error')
          state.issues.push('åˆ›å»ºæ–°é—»è¯·æ±‚å¼‚å¸¸')
        }
      }

      async function runQuickDiagnosis() {
        log('ğŸš€ å¼€å§‹å¿«é€Ÿè¯Šæ–­...', 'info')
        log('====================================', 'info')

        clearLogs()
        state.issues = []

        await testServerConnection()
        await sleep(300)
        await testLogin()
        await sleep(300)
        await testCategories()
        await sleep(300)
        await testNewsList()

        log('====================================', 'info')
        log('ğŸš€ å¿«é€Ÿè¯Šæ–­å®Œæˆ', 'success')

        generateSummary()
      }

      async function runDetailedAnalysis() {
        log('ğŸ”¬ å¼€å§‹è¯¦ç»†åˆ†æ...', 'info')
        log('====================================', 'info')

        clearLogs()
        state.issues = []

        await testServerConnection()
        await sleep(500)
        await testLogin()
        await sleep(500)
        await testCategories()
        await sleep(500)
        await testNewsList()
        await sleep(500)
        await testCreateNews()

        log('====================================', 'info')
        log('ğŸ”¬ è¯¦ç»†åˆ†æå®Œæˆ', 'success')

        generateSummary()
      }

      async function runFrontendTest() {
        log('ğŸ’» å¼€å§‹å‰ç«¯æµ‹è¯•...', 'info')
        log('æ£€æŸ¥å‰ç«¯ç‰¹å®šçš„é—®é¢˜...', 'info')

        // è¿™é‡Œå¯ä»¥æ·»åŠ å‰ç«¯ç‰¹å®šçš„æµ‹è¯•
        log('æç¤ºï¼šè¯·æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·æŸ¥çœ‹Consoleå’ŒNetworké¢æ¿', 'warning')
        log('å‰ç«¯æµ‹è¯•å®Œæˆ', 'success')
      }

      async function runBackendTest() {
        log('ğŸ”§ å¼€å§‹åç«¯æµ‹è¯•...', 'info')

        await testServerConnection()
        await testLogin()
        await testCategories()

        log('ğŸ”§ åç«¯æµ‹è¯•å®Œæˆ', 'success')
      }

      function generateSummary() {
        const totalTests = Object.keys(state.testResults).length
        const passedTests = Object.values(state.testResults).filter(Boolean).length

        log('', 'info')
        log('ğŸ“‹ æµ‹è¯•æ€»ç»“æŠ¥å‘Š', 'info')
        log('====================================', 'info')
        log(`æ€»æµ‹è¯•é¡¹: ${totalTests}`, 'info')
        log(`é€šè¿‡æµ‹è¯•: ${passedTests}`, 'success')
        log(
          `å¤±è´¥æµ‹è¯•: ${totalTests - passedTests}`,
          passedTests === totalTests ? 'success' : 'error'
        )
        log(`å‘ç°é—®é¢˜: ${state.issues.length}`, state.issues.length === 0 ? 'success' : 'error')

        if (state.issues.length > 0) {
          log('', 'info')
          log('ğŸš¨ é—®é¢˜åˆ—è¡¨:', 'error')
          state.issues.forEach((issue, index) => {
            log(`${index + 1}. ${issue}`, 'error')
          })
        } else {
          log('', 'info')
          log('ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Œç³»ç»Ÿè¿è¡Œæ­£å¸¸ï¼', 'success')
        }

        log('====================================', 'info')
      }

      function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms))
      }

      // åˆå§‹åŒ–
      window.onload = function () {
        log('ğŸ” å®æ—¶è¯Šæ–­å·¥å…·å·²åŠ è½½', 'success')
        log('ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•', 'info')
        updateUI()
      }
    </script>
  </body>
</html>
