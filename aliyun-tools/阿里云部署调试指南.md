# 阿里云服务器部署与调试指南

## 1. 部署准备

### 1.1 上传文件到阿里云服务器

```bash
# 将以下文件上传到阿里云服务器
- server-deploy.zip (后端代码包)
- scripts/aliyun-debug.sh (调试脚本)
- scripts/aliyun-reset-password.sh (密码重置脚本)
```

### 1.2 连接到阿里云服务器

```bash
ssh root@你的阿里云IP
```

## 2. 环境配置

### 2.1 安装Node.js (如未安装)

```bash
# 更新包管理器
apt-get update

# 安装Node.js和npm
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
apt-get install -y nodejs

# 验证安装
node --version
npm --version
```

### 2.2 设置环境变量

```bash
# 创建环境变量文件
cat > /etc/environment << 'EOF'
MONGODB_URI="你的MongoDB连接字符串"
JWT_SECRET="你的JWT密钥"
FRONTEND_URL="https://你的GitHub Pages域名"
NODE_ENV="production"
EOF

# 重新加载环境变量
source /etc/environment

# 验证环境变量
echo $MONGODB_URI
echo $JWT_SECRET
echo $FRONTEND_URL
```

## 3. 部署后端服务

### 3.1 解压并部署

```bash
# 创建部署目录
mkdir -p /var/www/sdszk-backend
cd /var/www/sdszk-backend

# 解压后端代码
unzip ~/server-deploy.zip

# 确保所有文件权限正确
chown -R www-data:www-data /var/www/sdszk-backend
chmod -R 755 /var/www/sdszk-backend

# 创建必要的目录
mkdir -p uploads/documents uploads/images uploads/videos logs
```

### 3.2 启动服务

```bash
# 进入项目目录
cd /var/www/sdszk-backend

# 启动服务
npm start

# 或者使用PM2 (推荐)
npm install -g pm2
pm2 start app.js --name "sdszk-backend"
pm2 save
pm2 startup
```

## 4. 调试登录401问题

### 4.1 运行调试脚本

```bash
# 上传调试脚本到服务器
chmod +x ~/aliyun-debug.sh

# 进入后端目录
cd /var/www/sdszk-backend

# 运行调试脚本
~/aliyun-debug.sh
```

### 4.2 查看调试输出

调试脚本会检查以下内容：

- Node.js环境
- 服务运行状态
- 端口占用情况
- 环境变量配置
- MongoDB连接
- admin用户数据
- 登录API测试
- 应用日志

### 4.3 如果发现admin用户问题

```bash
# 运行密码重置脚本
chmod +x ~/aliyun-reset-password.sh
cd /var/www/sdszk-backend
~/aliyun-reset-password.sh
```

## 5. 常见问题排查

### 5.1 MongoDB连接问题

```bash
# 检查MongoDB连接字符串格式
echo $MONGODB_URI
# 应该类似: mongodb+srv://username:password@cluster.mongodb.net/database

# 测试连接
mongosh "$MONGODB_URI" --eval "db.adminCommand('ping')"
```

### 5.2 环境变量问题

```bash
# 检查所有环境变量
env | grep -E "(MONGODB_URI|JWT_SECRET|FRONTEND_URL)"

# 如果环境变量未正确设置，重新设置
export MONGODB_URI="你的MongoDB连接字符串"
export JWT_SECRET="你的JWT密钥"
export FRONTEND_URL="https://你的GitHub Pages域名"
```

### 5.3 服务启动问题

```bash
# 检查服务日志
tail -f logs/app.log
tail -f logs/error.log

# 检查进程
ps aux | grep node

# 重启服务
pm2 restart sdszk-backend
# 或
pkill -f "node.*app.js"
npm start
```

### 5.4 CORS问题

如果前端无法访问API，检查FRONTEND_URL环境变量是否正确设置为GitHub Pages地址。

## 6. 验证部署

### 6.1 API测试

```bash
# 测试API健康检查
curl http://localhost:3000/api/health

# 测试登录接口
curl -X POST \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}' \
  http://localhost:3000/api/auth/login
```

### 6.2 前端测试

在浏览器中访问你的GitHub Pages地址，尝试登录后台管理系统。

## 7. 长期运行配置

### 7.1 使用PM2管理进程

```bash
# 安装PM2
npm install -g pm2

# 启动服务
pm2 start app.js --name "sdszk-backend"

# 保存PM2配置
pm2 save

# 设置开机自启
pm2 startup

# 查看运行状态
pm2 status
```

### 7.2 配置Nginx反向代理 (可选)

```bash
# 安装Nginx
apt-get install nginx

# 创建配置文件
cat > /etc/nginx/sites-available/sdszk-backend << 'EOF'
server {
    listen 80;
    server_name 你的域名;

    location /api {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
EOF

# 启用配置
ln -s /etc/nginx/sites-available/sdszk-backend /etc/nginx/sites-enabled/
nginx -t
systemctl reload nginx
```

## 8. 监控和维护

### 8.1 日志监控

```bash
# 查看实时日志
pm2 logs sdszk-backend

# 查看应用日志
tail -f /var/www/sdszk-backend/logs/app.log
```

### 8.2 定期备份

```bash
# 创建备份脚本
cat > /root/backup-sdszk.sh << 'EOF'
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/root/backups"
mkdir -p $BACKUP_DIR
mongodump --uri="$MONGODB_URI" --out="$BACKUP_DIR/mongo_$DATE"
tar -czf "$BACKUP_DIR/app_$DATE.tar.gz" /var/www/sdszk-backend
EOF

chmod +x /root/backup-sdszk.sh

# 设置定时备份
crontab -e
# 添加: 0 2 * * * /root/backup-sdszk.sh
```

## 联系信息

如果遇到问题，请将调试脚本的输出发送给开发团队进行分析。
