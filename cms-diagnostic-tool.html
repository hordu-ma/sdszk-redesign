<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CMSæ–°é—»ç®¡ç†è¯Šæ–­å·¥å…·</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        line-height: 1.6;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
      }
      .test-section {
        background: #f5f5f5;
        padding: 20px;
        margin: 20px 0;
        border-radius: 8px;
      }
      .result {
        background: #fff;
        padding: 15px;
        margin: 10px 0;
        border-left: 4px solid #007cba;
      }
      .success {
        border-left-color: #28a745;
      }
      .error {
        border-left-color: #dc3545;
      }
      .warning {
        border-left-color: #ffc107;
      }
      button {
        background: #007cba;
        color: white;
        border: none;
        padding: 10px 20px;
        margin: 5px;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background: #005a8b;
      }
      pre {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
      }
      .token-display {
        background: #e9ecef;
        padding: 10px;
        border-radius: 4px;
        word-break: break-all;
      }
      .form-group {
        margin: 15px 0;
      }
      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      .form-group textarea {
        height: 100px;
        resize: vertical;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ”§ CMSæ–°é—»ç®¡ç†è¯Šæ–­å·¥å…·</h1>
      <p>è¿™ä¸ªå·¥å…·å¯ä»¥å¸®åŠ©è¯Šæ–­CMSæ–°é—»åˆ›å»ºå’Œåˆ—è¡¨æ˜¾ç¤ºçš„é—®é¢˜</p>

      <!-- ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥ç™»å½•çŠ¶æ€ -->
      <div class="test-section">
        <h2>æ­¥éª¤1ï¼šæ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€</h2>
        <button onclick="checkLoginStatus()">æ£€æŸ¥ç™»å½•çŠ¶æ€</button>
        <button onclick="testLogin()">æµ‹è¯•ç™»å½•</button>
        <div id="loginResult" class="result"></div>
      </div>

      <!-- ç¬¬äºŒæ­¥ï¼šæµ‹è¯•æ–°é—»åˆ—è¡¨API -->
      <div class="test-section">
        <h2>æ­¥éª¤2ï¼šæµ‹è¯•æ–°é—»åˆ—è¡¨API</h2>
        <button onclick="testNewsListAPI()">è·å–æ–°é—»åˆ—è¡¨</button>
        <div id="newsListResult" class="result"></div>
      </div>

      <!-- ç¬¬ä¸‰æ­¥ï¼šæµ‹è¯•æ–°é—»åˆ›å»ºAPI -->
      <div class="test-section">
        <h2>æ­¥éª¤3ï¼šæµ‹è¯•æ–°é—»åˆ›å»ºAPI</h2>
        <div class="form-group">
          <label>æ–°é—»æ ‡é¢˜ï¼š</label>
          <input type="text" id="newsTitle" value="æµè§ˆå™¨æµ‹è¯•æ–°é—»" />
        </div>
        <div class="form-group">
          <label>æ–°é—»å†…å®¹ï¼š</label>
          <textarea id="newsContent">
è¿™æ˜¯é€šè¿‡æµè§ˆå™¨è¯Šæ–­å·¥å…·åˆ›å»ºçš„æµ‹è¯•æ–°é—»ï¼Œç”¨äºéªŒè¯APIåŠŸèƒ½ã€‚</textarea
          >
        </div>
        <div class="form-group">
          <label>æ–°é—»æ‘˜è¦ï¼š</label>
          <input type="text" id="newsSummary" value="æµè§ˆå™¨æµ‹è¯•æ‘˜è¦" />
        </div>
        <div class="form-group">
          <label>åˆ†ç±»ï¼š</label>
          <select id="newsCategory">
            <option value="">è¯·é€‰æ‹©åˆ†ç±»</option>
          </select>
        </div>
        <div class="form-group">
          <label>çŠ¶æ€ï¼š</label>
          <select id="newsStatus">
            <option value="draft">è‰ç¨¿</option>
            <option value="published" selected>å‘å¸ƒ</option>
          </select>
        </div>
        <button onclick="loadCategories()">åŠ è½½åˆ†ç±»åˆ—è¡¨</button>
        <button onclick="testNewsCreateAPI()">åˆ›å»ºæ–°é—»</button>
        <div id="newsCreateResult" class="result"></div>
      </div>

      <!-- ç¬¬å››æ­¥ï¼šéªŒè¯åˆ›å»ºç»“æœ -->
      <div class="test-section">
        <h2>æ­¥éª¤4ï¼šéªŒè¯æ–°é—»åˆ›å»ºç»“æœ</h2>
        <button onclick="verifyNewsCreation()">é‡æ–°è·å–æ–°é—»åˆ—è¡¨éªŒè¯</button>
        <div id="verifyResult" class="result"></div>
      </div>

      <!-- è°ƒè¯•ä¿¡æ¯ -->
      <div class="test-section">
        <h2>ğŸ” è°ƒè¯•ä¿¡æ¯</h2>
        <div id="debugInfo" class="result">
          <p>æœåŠ¡å™¨åœ°å€ï¼š<span id="serverUrl">http://localhost:3000</span></p>
          <p>å‰ç«¯åœ°å€ï¼š<span id="frontendUrl">http://localhost:5173</span></p>
          <p>å½“å‰æ—¶é—´ï¼š<span id="currentTime"></span></p>
        </div>
      </div>
    </div>

    <script>
      // é…ç½®
      const API_BASE = 'http://localhost:3000'
      let authToken = ''
      let newsCount = 0

      // æ›´æ–°æ—¶é—´æ˜¾ç¤º
      function updateTime() {
        document.getElementById('currentTime').textContent = new Date().toLocaleString('zh-CN')
      }
      setInterval(updateTime, 1000)
      updateTime()

      // å·¥å…·å‡½æ•°ï¼šæ˜¾ç¤ºç»“æœ
      function showResult(elementId, content, type = 'info') {
        const element = document.getElementById(elementId)
        element.innerHTML = content
        element.className = `result ${type}`
      }

      // å·¥å…·å‡½æ•°ï¼šAPIè¯·æ±‚
      async function apiRequest(url, options = {}) {
        const defaultOptions = {
          headers: {
            'Content-Type': 'application/json',
            ...(authToken && { Authorization: `Bearer ${authToken}` }),
          },
        }

        const finalOptions = {
          ...defaultOptions,
          ...options,
          headers: { ...defaultOptions.headers, ...options.headers },
        }

        try {
          const response = await fetch(API_BASE + url, finalOptions)
          const data = await response.json()
          return { ok: response.ok, status: response.status, data }
        } catch (error) {
          return { ok: false, error: error.message }
        }
      }

      // 1. æ£€æŸ¥ç™»å½•çŠ¶æ€
      function checkLoginStatus() {
        const token = localStorage.getItem('token')
        if (token) {
          authToken = token
          showResult(
            'loginResult',
            `âœ… æ‰¾åˆ°token: <div class="token-display">${token.substring(0, 50)}...</div>`,
            'success'
          )
        } else {
          showResult('loginResult', 'âŒ æœªæ‰¾åˆ°ç™»å½•tokenï¼Œéœ€è¦å…ˆç™»å½•', 'error')
        }
      }

      // 2. æµ‹è¯•ç™»å½•
      async function testLogin() {
        showResult('loginResult', 'ğŸ”„ æ­£åœ¨æµ‹è¯•ç™»å½•...')

        const result = await apiRequest('/api/auth/login', {
          method: 'POST',
          body: JSON.stringify({
            username: 'admin',
            password: 'admin123',
          }),
        })

        if (result.ok && result.data.token) {
          authToken = result.data.token
          localStorage.setItem('token', authToken)
          showResult(
            'loginResult',
            `âœ… ç™»å½•æˆåŠŸï¼<br>ç”¨æˆ·ï¼š${result.data.user?.username || 'admin'}<br>Token: <div class="token-display">${authToken.substring(0, 50)}...</div>`,
            'success'
          )
        } else {
          showResult(
            'loginResult',
            `âŒ ç™»å½•å¤±è´¥<br>çŠ¶æ€ç : ${result.status}<br>é”™è¯¯: ${result.data?.message || result.error}`,
            'error'
          )
        }
      }

      // 3. æµ‹è¯•æ–°é—»åˆ—è¡¨API
      async function testNewsListAPI() {
        if (!authToken) {
          showResult('newsListResult', 'âŒ è¯·å…ˆç™»å½•è·å–token', 'error')
          return
        }

        showResult('newsListResult', 'ğŸ”„ æ­£åœ¨è·å–æ–°é—»åˆ—è¡¨...')

        const result = await apiRequest('/api/admin/news?page=1&limit=10')

        if (result.ok) {
          const data = result.data
          if (data.status === 'success' && data.data && Array.isArray(data.data.data)) {
            newsCount = data.data.pagination?.total || 0
            showResult(
              'newsListResult',
              `âœ… æ–°é—»åˆ—è¡¨è·å–æˆåŠŸ<br>
                        æ€»æ•°: ${newsCount}<br>
                        å½“å‰é¡µ: ${data.data.data.length} æ¡<br>
                        æœ€æ–°æ–°é—»: ${data.data.data[0]?.title || 'æ— '}<br>
                        <pre>${JSON.stringify(data.data.pagination, null, 2)}</pre>`,
              'success'
            )
          } else {
            showResult(
              'newsListResult',
              `âš ï¸ æ•°æ®æ ¼å¼å¼‚å¸¸<br><pre>${JSON.stringify(data, null, 2)}</pre>`,
              'warning'
            )
          }
        } else {
          showResult(
            'newsListResult',
            `âŒ è¯·æ±‚å¤±è´¥<br>çŠ¶æ€ç : ${result.status}<br>é”™è¯¯: ${result.data?.message || result.error}`,
            'error'
          )
        }
      }

      // 4. åŠ è½½åˆ†ç±»åˆ—è¡¨
      async function loadCategories() {
        if (!authToken) {
          alert('è¯·å…ˆç™»å½•')
          return
        }

        const result = await apiRequest('/api/admin/news-categories')
        const select = document.getElementById('newsCategory')

        if (result.ok && result.data.data) {
          select.innerHTML = '<option value="">è¯·é€‰æ‹©åˆ†ç±»</option>'
          result.data.data.forEach(cat => {
            const option = document.createElement('option')
            option.value = cat._id
            option.textContent = cat.name
            select.appendChild(option)
          })
          showResult('newsCreateResult', 'âœ… åˆ†ç±»åˆ—è¡¨åŠ è½½æˆåŠŸ', 'success')
        } else {
          showResult('newsCreateResult', 'âŒ åˆ†ç±»åˆ—è¡¨åŠ è½½å¤±è´¥', 'error')
        }
      }

      // 5. æµ‹è¯•æ–°é—»åˆ›å»º
      async function testNewsCreateAPI() {
        if (!authToken) {
          showResult('newsCreateResult', 'âŒ è¯·å…ˆç™»å½•è·å–token', 'error')
          return
        }

        const title = document.getElementById('newsTitle').value
        const content = document.getElementById('newsContent').value
        const summary = document.getElementById('newsSummary').value
        const category = document.getElementById('newsCategory').value
        const status = document.getElementById('newsStatus').value

        if (!title || !content || !category) {
          showResult('newsCreateResult', 'âŒ è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼ˆæ ‡é¢˜ã€å†…å®¹ã€åˆ†ç±»ï¼‰', 'error')
          return
        }

        showResult('newsCreateResult', 'ğŸ”„ æ­£åœ¨åˆ›å»ºæ–°é—»...')

        const newsData = {
          title: title + ` - ${new Date().toLocaleString('zh-CN')}`,
          content,
          summary,
          category,
          status,
          tags: ['æµè§ˆå™¨æµ‹è¯•', 'è¯Šæ–­å·¥å…·'],
          isTop: false,
          isFeatured: false,
        }

        const result = await apiRequest('/api/admin/news', {
          method: 'POST',
          body: JSON.stringify(newsData),
        })

        if (result.ok) {
          showResult(
            'newsCreateResult',
            `âœ… æ–°é—»åˆ›å»ºæˆåŠŸï¼<br>
                    ID: ${result.data._id}<br>
                    æ ‡é¢˜: ${result.data.title}<br>
                    çŠ¶æ€: ${result.data.status}<br>
                    <pre>${JSON.stringify(result.data, null, 2)}</pre>`,
            'success'
          )
        } else {
          showResult(
            'newsCreateResult',
            `âŒ æ–°é—»åˆ›å»ºå¤±è´¥<br>çŠ¶æ€ç : ${result.status}<br>é”™è¯¯: ${result.data?.message || result.error}<br>
                    <pre>${JSON.stringify(result.data || result.error, null, 2)}</pre>`,
            'error'
          )
        }
      }

      // 6. éªŒè¯åˆ›å»ºç»“æœ
      async function verifyNewsCreation() {
        if (!authToken) {
          showResult('verifyResult', 'âŒ è¯·å…ˆç™»å½•è·å–token', 'error')
          return
        }

        showResult('verifyResult', 'ğŸ”„ æ­£åœ¨éªŒè¯æ–°é—»åˆ›å»ºç»“æœ...')

        const result = await apiRequest('/api/admin/news?page=1&limit=10')

        if (result.ok && result.data.status === 'success') {
          const newTotal = result.data.data.pagination?.total || 0
          const increase = newTotal - newsCount

          showResult(
            'verifyResult',
            `âœ… éªŒè¯å®Œæˆ<br>
                    ä¹‹å‰æ€»æ•°: ${newsCount}<br>
                    å½“å‰æ€»æ•°: ${newTotal}<br>
                    æ–°å¢æ•°é‡: ${increase}<br>
                    æœ€æ–°æ–°é—»: ${result.data.data.data[0]?.title || 'æ— '}<br>
                    ${increase > 0 ? 'ğŸ‰ æ–°é—»åˆ›å»ºæˆåŠŸï¼' : 'âš ï¸ å¯èƒ½åˆ›å»ºå¤±è´¥'}`,
            increase > 0 ? 'success' : 'warning'
          )

          newsCount = newTotal // æ›´æ–°è®¡æ•°
        } else {
          showResult(
            'verifyResult',
            `âŒ éªŒè¯å¤±è´¥<br>çŠ¶æ€ç : ${result.status}<br>é”™è¯¯: ${result.data?.message || result.error}`,
            'error'
          )
        }
      }

      // è‡ªåŠ¨æ£€æŸ¥ç™»å½•çŠ¶æ€
      window.onload = function () {
        checkLoginStatus()
      }
    </script>
  </body>
</html>
