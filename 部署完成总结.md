# 山东省思政课一体化中心部署总结

## 🎯 核心部署信息

- **域名**: https://horsduroot.com
- **服务器**: 阿里云ECS (60.205.124.67)
- **技术栈**: Ubuntu 20.04 + Nginx + Node.js + MongoDB + PM2
- **SSL**: Let's Encrypt (自动续期)

## 🚀 部署脚本约定

项目提供三种不同的部署方式，适用于不同的场景和需求：

### 1. 前端部署脚本 - `scripts/deploy.sh` ✅

**用途**: 专门用于前端静态文件部署

**特点**:

- 使用 `.env.aliyun` 环境配置
- 使用 `vite.config.aliyun.ts` 构建配置
- 执行 `npm run build:aliyun` 进行阿里云专用构建
- 不生成新的 nginx 配置，只重载现有配置
- 包含备份机制和权限设置

**使用场景**:

- 前端代码更新
- UI界面调整
- 静态资源更新
- 日常迭代部署

**执行命令**:

```bash
./scripts/deploy.sh
```

**关键配置**:

- 构建命令: `npm run build:aliyun`
- 部署路径: `/var/www/frontend`
- 健康检查: `https://horsduroot.com`

### 2. 后端部署脚本 - `scripts/deploy-backend.sh` ✅

**用途**: 专门用于后端API服务部署

**特点**:

- 使用 PM2 进程管理
- 支持生产环境配置覆盖
- 包含服务重启和健康检查
- 自动处理依赖安装和文件权限

**使用场景**:

- 后端API更新
- 数据库配置修改
- 服务器端逻辑变更
- CORS配置更新

**执行命令**:

```bash
./scripts/deploy-backend.sh
```

**关键配置**:

- 源目录: `./server/`
- 构建目录: `./server-dist/`
- PM2应用名: `sdszk-backend`
- 健康检查: `http://localhost:3000/api/health`

### 3. Docker容器部署脚本 - `scripts/deploy-prod.sh` 🐳

**用途**: 完整的容器化部署方案

**特点**:

- 使用 Docker Compose 编排
- 包含数据库、缓存、应用等完整栈
- 支持环境变量配置
- 适合新环境搭建或完整重部署

**使用场景**:

- 新服务器环境搭建
- 完整系统重新部署
- 开发环境快速搭建
- 灾难恢复

**执行命令**:

```bash
# 需要先设置环境变量
export MONGO_PASSWORD="your_password"
export REDIS_PASSWORD="your_password"
export JWT_SECRET="your_secret"

./scripts/deploy-prod.sh
```

**关键配置**:

- 配置文件: `docker-compose.prod.yml`
- 健康检查: `http://localhost:3000/api/health`
- 日志目录: `./logs/`

### 📋 部署脚本选择指南

| 更新类型     | 推荐脚本            | 说明             |
| ------------ | ------------------- | ---------------- |
| 前端UI更新   | `deploy.sh`         | 只需更新静态文件 |
| 后端API更新  | `deploy-backend.sh` | 只需重启后端服务 |
| 配置文件修改 | `deploy-backend.sh` | 重新加载配置     |
| 完整重部署   | `deploy-prod.sh`    | 容器化完整部署   |
| 新环境搭建   | `deploy-prod.sh`    | 包含所有依赖服务 |

### ⚠️ 部署注意事项

1. **前端部署** (`deploy.sh`):

   - 会检查 Git 状态，建议部署前提交代码
   - 支持备份现有文件（10秒超时选择）
   - 构建时会显示文件大小警告（正常现象）

2. **后端部署** (`deploy-backend.sh`):

   - 需要确保 `./server/.env.production` 文件存在
   - 部署过程中服务会短暂中断
   - 自动处理 PM2 进程管理

3. **Docker部署** (`deploy-prod.sh`):
   - 需要设置必要的环境变量
   - 会清理旧容器和镜像
   - 启动时间较长（约30秒）

## ✅ 关键配置约定

### 前端配置

- **环境文件**: `.env.aliyun` (生产环境专用)
- **构建配置**: `vite.config.aliyun.ts`
- **构建命令**: `npm run build:aliyun`
- **部署路径**: `/var/www/frontend`
- **API地址**: `https://horsduroot.com/api` (相对路径 `/api`)

### 后端配置

- **生产配置**: `./server/.env.production`
- **构建目录**: `./server-dist/`
- **进程管理**: PM2 (`sdszk-backend`)
- **内部端口**: 3000
- **CORS域名**: `https://horsduroot.com`
- **Express**: `trust proxy: true`

### Nginx配置

- **配置文件**: `/etc/nginx/sites-available/sdszk`
- **HTTP→HTTPS**: 强制重定向
- **API代理**: `/api/*` → `localhost:3000/api/`
- **静态文件**: `/var/www/frontend`
- **CORS头部**: 已配置

### � 部署流程约定

**日常开发**:

```bash
./scripts/deploy.sh          # 前端更新
./scripts/deploy-backend.sh  # 后端更新
```

**完整部署**:

```bash
./scripts/deploy-prod.sh     # Docker容器化部署
```

## 🔧 常用运维命令

```bash
# Nginx
sudo nginx -t && sudo systemctl reload nginx

# PM2后端
pm2 status
pm2 restart sdszk-backend
pm2 logs sdszk-backend

# SSL证书
sudo certbot certificates
sudo certbot renew --dry-run

# 健康检查
curl https://horsduroot.com/api/health
```

## ⚠️ 重要注意事项

### 部署前检查

- 前端: 确保使用 `.env.aliyun` 和 `build:aliyun`
- 后端: 确保 `./server/.env.production` 存在
- Docker: 设置必要环境变量 (MONGO_PASSWORD, REDIS_PASSWORD, JWT_SECRET)

### 配置关键点

- **Trust Proxy**: Express必须配置才能正确处理代理头部
- **CORS域名**: 后端必须允许 `https://horsduroot.com`
- **API路径**: 前端使用相对路径 `/api`，避免/api/api重复

### 常见问题解决

- **CORS错误**: 检查HTTPS配置、Nginx代理、后端CORS设置
- **SSL问题**: 检查证书状态和nginx配置
- **API连接**: 分层测试（本地→代理→外部）

---

**最后更新**: 2025-06-20  
**状态**: ✅ 生产就绪，三套部署脚本完整可用
