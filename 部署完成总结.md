# å±±ä¸œçœæ€æ”¿è¯¾ä¸€ä½“åŒ–ä¸­å¿ƒéƒ¨ç½²å®Œæˆæ€»ç»“

## ğŸ¯ éƒ¨ç½²æ ¸å¿ƒä¿¡æ¯

- **åŸŸå**: https://horsduroot.com
- **æœåŠ¡å™¨**: é˜¿é‡Œäº‘ECS (60.205.124.67)
- **ç¯å¢ƒ**: Ubuntu 20.04 + Nginx + Node.js + MongoDB
- **SSLè¯ä¹¦**: Let's Encrypt (è‡ªåŠ¨ç»­æœŸ)

## âœ… å·²å®Œæˆé…ç½®

### 1. HTTPS/SSL é…ç½® âœ…

```bash
# è¯ä¹¦çŠ¶æ€
sudo certbot certificates

# è¯ä¹¦è‡ªåŠ¨ç»­æœŸ
sudo systemctl status certbot.timer

# æµ‹è¯•ç»­æœŸ (æ¨èæ¯æœˆæ‰§è¡Œ)
sudo certbot renew --dry-run
```

### 2. Nginxé…ç½® âœ…

- **é…ç½®æ–‡ä»¶**: `/etc/nginx/sites-available/sdszk`
- **HTTPâ†’HTTPSè‡ªåŠ¨é‡å®šå‘**: âœ…
- **APIä»£ç†** (`/api/*` â†’ `localhost:3000`): âœ…
- **CORSå¤´éƒ¨è®¾ç½®**: âœ…
- **å®‰å…¨å¤´éƒ¨**: âœ…

**å…³é”®é…ç½®è¦ç‚¹**:

```nginx
# HTTPSé‡å®šå‘
server {
    listen 80;
    server_name horsduroot.com;
    return 301 https://$server_name$request_uri;
}

# APIä»£ç†é…ç½® (é¿å…/api/apié‡å¤)
location /api/ {
    proxy_pass http://localhost:3000/api/;
    proxy_set_header X-Forwarded-Proto $scheme;
    add_header Access-Control-Allow-Origin "https://horsduroot.com" always;
}
```

### 3. åç«¯é…ç½® âœ…

- **Expressä¿¡ä»»ä»£ç†**: `app.set('trust proxy', true)`
- **CORSå…è®¸åŸŸå**: `https://horsduroot.com`
- **ç«¯å£ç›‘å¬**: 3000 (å†…éƒ¨)
- **æ•°æ®åº“è¿æ¥**: MongoDB âœ…

### 4. å‰ç«¯é…ç½® âœ…

- **ç”Ÿäº§ç¯å¢ƒAPIåœ°å€**: `https://horsduroot.com/api`
- **å¼ºåˆ¶HTTPS**: æ‰€æœ‰APIè°ƒç”¨ä½¿ç”¨HTTPSåè®®
- **æ„å»ºéªŒè¯**: å·²ç¡®è®¤ç”Ÿäº§ç‰ˆæœ¬ä½¿ç”¨æ­£ç¡®çš„APIé…ç½®

### 5. CORSé—®é¢˜è§£å†³æ–¹æ¡ˆ âœ…

**é—®é¢˜è¯Šæ–­**:

1. âœ… HTTPâ†’HTTPSé‡å®šå‘æ­£å¸¸å·¥ä½œ
2. âœ… å‰ç«¯APIé…ç½®ä½¿ç”¨HTTPS
3. âœ… åç«¯CORSé…ç½®æ­£ç¡®
4. âœ… Nginxä»£ç†å’ŒSSLæ­£å¸¸

**è§£å†³æ­¥éª¤**:

1. ç¡®è®¤`.env.production`ä¸­APIåœ°å€ä¸º`https://horsduroot.com/api`
2. æ„å»ºå¹¶éƒ¨ç½²å‰ç«¯ï¼ŒéªŒè¯ç”Ÿäº§ç‰ˆæœ¬ä½¿ç”¨HTTPS API
3. æµ‹è¯•APIç«¯ç‚¹å“åº”æ­£å¸¸

## ğŸ”§ è¿ç»´å‘½ä»¤é€ŸæŸ¥

### Nginxæ“ä½œ

```bash
# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡è½½é…ç½®
sudo systemctl reload nginx

# æŸ¥çœ‹çŠ¶æ€
sudo systemctl status nginx

# æŸ¥çœ‹è®¿é—®æ—¥å¿—
sudo tail -f /var/log/nginx/access.log
```

### Node.jsåç«¯

```bash
# PM2çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs sdszk-backend

# é‡å¯æœåŠ¡
pm2 restart sdszk-backend

# ç›‘æ§èµ„æº
pm2 monit
```

### SSLè¯ä¹¦ç®¡ç†

```bash
# æŸ¥çœ‹è¯ä¹¦çŠ¶æ€
sudo certbot certificates

# æ‰‹åŠ¨ç»­æœŸ
sudo certbot renew

# å¼ºåˆ¶ç»­æœŸ
sudo certbot renew --force-renewal
```

### ç³»ç»Ÿç›‘æ§

```bash
# ç«¯å£ç›‘å¬çŠ¶æ€
sudo netstat -tlnp | grep -E ':(80|443|3000)'

# ç£ç›˜ä½¿ç”¨
df -h

# å†…å­˜ä½¿ç”¨
free -h

# ç³»ç»Ÿè´Ÿè½½
htop
```

## ğŸš¨ æ•…éšœæ’æŸ¥æŒ‡å—

### CORSé”™è¯¯

1. **æ£€æŸ¥å‰ç«¯APIé…ç½®**: ç¡®è®¤ä½¿ç”¨HTTPS
2. **éªŒè¯Nginxä»£ç†**: æ£€æŸ¥/apiè·¯å¾„è½¬å‘
3. **ç¡®è®¤åç«¯CORSè®¾ç½®**: æ£€æŸ¥å…è®¸çš„æºåŸŸå

### SSLè¯ä¹¦é—®é¢˜

```bash
# æ£€æŸ¥è¯ä¹¦æœ‰æ•ˆæ€§
openssl x509 -in /etc/letsencrypt/live/horsduroot.com/fullchain.pem -text -noout

# æµ‹è¯•SSLé…ç½®
openssl s_client -connect horsduroot.com:443 -servername horsduroot.com
```

### APIè¿æ¥é—®é¢˜

```bash
# æµ‹è¯•APIå¥åº·çŠ¶æ€
curl https://horsduroot.com/api/health

# æ£€æŸ¥å†…éƒ¨API
curl http://localhost:3000/api/health

# éªŒè¯ä»£ç†è½¬å‘
curl -H "X-Forwarded-Proto: https" http://localhost/api/health
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### å·²å®ç°

- âœ… Gzipå‹ç¼©
- âœ… é™æ€èµ„æºç¼“å­˜
- âœ… APIå“åº”ç¼“å­˜
- âœ… ä»£ç åˆ†å‰²å’Œæ‡’åŠ è½½

### å¾…ä¼˜åŒ–

- [ ] CDNåŠ é€Ÿ
- [ ] æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–
- [ ] å›¾ç‰‡å‹ç¼©å’ŒWebPæ”¯æŒ
- [ ] HTTP/2æ¨é€
- [ ] æœåŠ¡ç«¯æ¸²æŸ“(SSR)

## ğŸ”’ å®‰å…¨é…ç½®

### å·²å®ç°

- âœ… HTTPSå¼ºåˆ¶é‡å®šå‘
- âœ… å®‰å…¨å¤´éƒ¨è®¾ç½®
- âœ… CORSé™åˆ¶
- âœ… JWTè®¤è¯
- âœ… æ–‡ä»¶ä¸Šä¼ é™åˆ¶

### å»ºè®®åŠ å¼º

- [ ] WAFé˜²æŠ¤
- [ ] DDoSé˜²æŠ¤
- [ ] IPç™½åå•
- [ ] æ—¥å¿—ç›‘æ§å’Œå‘Šè­¦

## ğŸ“ éƒ¨ç½²ç»éªŒæ€»ç»“

### å…³é”®ç»éªŒ

1. **Nginxé…ç½®ç®¡ç†**: æœ¬åœ°ç¼–å†™é…ç½®æ–‡ä»¶ç„¶åscpä¸Šä¼ ï¼Œé¿å…å‘½ä»¤è¡Œå†™å…¥è½¬ä¹‰é—®é¢˜
2. **Trust Proxy**: Expresså¿…é¡»é…ç½®trust proxyæ‰èƒ½æ­£ç¡®å¤„ç†ä»£ç†å¤´éƒ¨
3. **CORSè°ƒè¯•**: åˆ†æ­¥éª¤æ’æŸ¥HTTPé‡å®šå‘ã€APIé…ç½®ã€Nginxä»£ç†ç­‰
4. **SSLé…ç½®**: Let's Encryptè‡ªåŠ¨ç»­æœŸæ˜¯å…³é”®ï¼Œå®šæœŸæ£€æŸ¥è¯ä¹¦çŠ¶æ€

### é¿å…çš„å‘

1. âŒ å‘½ä»¤è¡Œå†™å…¥å¤æ‚Nginxé…ç½®ï¼ˆè½¬ä¹‰é—®é¢˜ï¼‰
2. âŒ å‰ç«¯APIé…ç½®ä¸ä¸€è‡´ï¼ˆå¼€å‘ç¯å¢ƒvsç”Ÿäº§ç¯å¢ƒï¼‰
3. âŒ å¿˜è®°é…ç½®trust proxyå¯¼è‡´ä»£ç†å¤´éƒ¨ä¸¢å¤±
4. âŒ CORSé…ç½®ä¸åŒ¹é…å¯¼è‡´è·¨åŸŸé—®é¢˜

### è°ƒè¯•æŠ€å·§

1. **åˆ†å±‚æµ‹è¯•**: ä»å†…åˆ°å¤–é€å±‚æµ‹è¯•ï¼ˆæœ¬åœ°APIâ†’Nginxä»£ç†â†’å¤–éƒ¨è®¿é—®ï¼‰
2. **è¯¦ç»†æ—¥å¿—**: ç»“åˆNginxè®¿é—®æ—¥å¿—å’ŒNode.jsåº”ç”¨æ—¥å¿—
3. **curléªŒè¯**: ä½¿ç”¨curlæ¨¡æ‹Ÿå„ç§è¯·æ±‚åœºæ™¯
4. **æµè§ˆå™¨å·¥å…·**: å¼€å‘è€…å·¥å…·Networké¢æ¿åˆ†æè¯·æ±‚å“åº”

---

**æœ€åæ›´æ–°**: 2025-06-20
**éƒ¨ç½²çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª
