# 山东省思政课一体化中心部署总结

## 🎯 核心部署信息

- **域名**: https://horsduroot.com
- **服务器**: 阿里云ECS (60.205.124.67)
- **技术栈**: Ubuntu 20.04 + Nginx + Node.js + MongoDB + PM2
- **SSL**: Let's Encrypt (自动续期)

## 🚀 部署脚本约定

项目提供三种不同的部署方式，适用于不同的场景和需求：

### 1. 前端部署脚本 - `scripts/deploy.sh` ✅

**用途**: 专门用于前端静态文件部署

**特点**:

- 使用 `.env.aliyun` 环境配置
- 使用 `vite.config.aliyun.ts` 构建配置
- 执行 `npm run build:aliyun` 进行阿里云专用构建
- 不生成新的 nginx 配置，只重载现有配置
- 包含备份机制和权限设置

**使用场景**:

- 前端代码更新
- UI界面调整
- 静态资源更新
- 日常迭代部署

**执行命令**:

```bash
./scripts/deploy.sh
```

**关键配置**:

- 构建命令: `npm run build:aliyun`
- 部署路径: `/var/www/frontend`
- 健康检查: `https://horsduroot.com`

### 2. 后端部署脚本 - `scripts/deploy-backend.sh` ✅

**用途**: 专门用于后端API服务部署

**特点**:

- 使用 PM2 进程管理
- 支持生产环境配置覆盖
- 包含服务重启和健康检查
- 自动处理依赖安装和文件权限

**使用场景**:

- 后端API更新
- 数据库配置修改
- 服务器端逻辑变更
- CORS配置更新

**执行命令**:

```bash
./scripts/deploy-backend.sh
```

**关键配置**:

- 源目录: `./server/`
- 构建目录: `./server-dist/`
- PM2应用名: `sdszk-backend`
- 健康检查: `http://localhost:3000/api/health`

### 3. Docker容器部署脚本 - `scripts/deploy-prod.sh` 🐳

**用途**: 完整的容器化部署方案

**特点**:

- 使用 Docker Compose 编排
- 包含数据库、缓存、应用等完整栈
- 支持环境变量配置
- 适合新环境搭建或完整重部署

**使用场景**:

- 新服务器环境搭建
- 完整系统重新部署
- 开发环境快速搭建
- 灾难恢复

**执行命令**:

```bash
# 需要先设置环境变量
export MONGO_PASSWORD="your_password"
export REDIS_PASSWORD="your_password"
export JWT_SECRET="your_secret"

./scripts/deploy-prod.sh
```

**关键配置**:

- 配置文件: `docker-compose.prod.yml`
- 健康检查: `http://localhost:3000/api/health`
- 日志目录: `./logs/`

### 📋 部署脚本选择指南

| 更新类型     | 推荐脚本                    | 说明               |
| ------------ | --------------------------- | ------------------ |
| 前端UI更新   | `deploy.sh`                 | 只需更新静态文件   |
| 后端API更新  | `deploy-backend.sh`         | 只需重启后端服务   |
| 配置文件修改 | `deploy-backend.sh`         | 重新加载配置       |
| 数据库迁移   | `migrate-database-clean.sh` | 本地数据同步到云端 |
| 完整重部署   | `deploy-prod.sh`            | 容器化完整部署     |
| 新环境搭建   | `deploy-prod.sh`            | 包含所有依赖服务   |

### ⚠️ 部署注意事项

1. **前端部署** (`deploy.sh`):

   - 会检查 Git 状态，建议部署前提交代码
   - 支持备份现有文件（10秒超时选择）
   - 构建时会显示文件大小警告（正常现象）

2. **后端部署** (`deploy-backend.sh`):

   - 需要确保 `./server/.env.production` 文件存在
   - 部署过程中服务会短暂中断
   - 自动处理 PM2 进程管理

3. **Docker部署** (`deploy-prod.sh`):
   - 需要设置必要的环境变量
   - 会清理旧容器和镜像
   - 启动时间较长（约30秒）

## ✅ 关键配置约定

### 前端配置

- **环境文件**: `.env.aliyun` (生产环境专用)
- **构建配置**: `vite.config.aliyun.ts`
- **构建命令**: `npm run build:aliyun`
- **部署路径**: `/var/www/frontend`
- **API地址**: `https://horsduroot.com/api` (相对路径 `/api`)

### 后端配置

- **生产配置**: `./server/.env.production`
- **构建目录**: `./server-dist/`
- **进程管理**: PM2 (`sdszk-backend`)
- **内部端口**: 3000
- **数据库**: MongoDB (`sdszk-db`)
- **数据库命令**: 使用 `mongosh`（不是 `mongo`）
- **CORS域名**: `https://horsduroot.com`
- **Express**: `trust proxy: true`

### 数据库配置

- **本地数据库**: `sdszk`
- **生产数据库**: `sdszk-db`
- **MongoDB Shell**: `mongosh`（新版本命令）
- **数据迁移**: 使用 `migrate-database-clean.sh`
- **管理员账号**: `admin` / `admin@sdszk.edu.cn`
- **登录地址**: `https://horsduroot.com/login/admin`

### Nginx配置

- **配置文件**: `/etc/nginx/sites-available/sdszk`
- **HTTP→HTTPS**: 强制重定向
- **API代理**: `/api/*` → `localhost:3000/api/`
- **静态文件**: `/var/www/frontend`
- **CORS头部**: 已配置

### � 部署流程约定

**日常开发**:

```bash
./scripts/deploy.sh          # 前端更新
./scripts/deploy-backend.sh  # 后端更新
```

**完整部署**:

```bash
./scripts/deploy-prod.sh     # Docker容器化部署
```

## 🔧 常用运维命令

```bash
# Nginx
sudo nginx -t && sudo systemctl reload nginx

# PM2后端
pm2 status
pm2 restart sdszk-backend
pm2 logs sdszk-backend

# MongoDB数据库
mongosh sdszk-db --eval "db.getCollectionNames()"
mongosh sdszk-db --eval "db.users.countDocuments()"
mongosh sdszk-db --eval "db.users.findOne({username: 'admin'})"

# SSL证书
sudo certbot certificates
sudo certbot renew --dry-run

# 健康检查
curl https://horsduroot.com/api/health

# 数据库迁移
./scripts/migrate-database-clean.sh

# 管理员登录测试
curl -X POST https://horsduroot.com/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username": "admin", "password": "your_password"}'
```

## ⚠️ 重要注意事项

### 部署前检查

- 前端: 确保使用 `.env.aliyun` 和 `build:aliyun`
- 后端: 确保 `./server/.env.production` 存在
- Docker: 设置必要环境变量 (MONGO_PASSWORD, REDIS_PASSWORD, JWT_SECRET)

### 配置关键点

- **Trust Proxy**: Express必须配置才能正确处理代理头部
- **CORS域名**: 后端必须允许 `https://horsduroot.com`
- **API路径**: 前端使用相对路径 `/api`，避免/api/api重复

### 常见问题解决

- **CORS错误**: 检查HTTPS配置、Nginx代理、后端CORS设置
- **SSL问题**: 检查证书状态和nginx配置
- **API连接**: 分层测试（本地→代理→外部）
- **登录失败**: 使用数据库迁移脚本同步本地数据到云端
- **数据库连接**: 确保使用 `mongosh` 命令（不是 `mongo`）
- **管理员账号**: 通过 `/login/admin` 路径访问管理员登录

---

**最后更新**: 2025-06-20  
**状态**: ✅ 生产就绪，包含完整的部署脚本体系和数据库迁移工具  
**数据库迁移**: ✅ 本地数据已成功迁移到阿里云，管理员账号可正常登录

## 🗄️ 数据库迁移脚本

项目还提供了专门的数据库迁移工具，用于将本地MongoDB数据库完整迁移到阿里云服务器。

### 数据库迁移脚本 - `scripts/migrate-database-clean.sh` ✅

**用途**: 将本地MongoDB数据库（sdszk）完整迁移到阿里云数据库（sdszk-db）

**特点**:

- 自动导出本地数据库（使用 `mongodump`）
- 清理macOS扩展属性，避免恢复错误
- 压缩上传到服务器
- 在服务器端安全恢复数据（使用 `mongorestore`）
- 包含数据验证和服务重启

**使用场景**:

- 本地开发数据同步到生产环境
- 数据库内容不一致导致的登录问题
- 管理员账号迁移
- 完整数据迁移

**执行命令**:

```bash
./scripts/migrate-database-clean.sh
```

**关键配置**:

- 本地数据库: `sdszk`
- 远程数据库: `sdszk-db`
- MongoDB命令: 使用 `mongosh`（不是 `mongo`）
- 迁移验证: 自动检查用户、新闻、资源数量

### ⚠️ 数据库迁移注意事项

1. **MongoDB版本兼容性**:

   - 服务器使用 `mongosh` 命令（MongoDB Shell 新版本）
   - 确保 `mongorestore` 工具已安装在服务器上

2. **macOS兼容性**:

   - 自动清理 `._*` 扩展属性文件
   - 使用 `COPYFILE_DISABLE=1` 避免tar打包问题

3. **数据完整性**:

   - 迁移前自动备份现有数据库
   - 迁移后验证关键数据（用户、内容数量）
   - 确认管理员账号存在且可用

4. **服务重启**:
   - 自动重启后端服务（PM2）
   - 健康检查确保服务正常

### 📋 数据库迁移验证清单

迁移完成后，系统会自动验证：

- ✅ 数据库集合完整性
- ✅ 用户数据迁移（包括管理员账号）
- ✅ 新闻内容迁移
- ✅ 资源数据迁移
- ✅ 后端服务重启
- ✅ API健康检查

**管理员登录验证**:

- 账号: `admin`
- 邮箱: `admin@sdszk.edu.cn`
- 登录地址: `https://horsduroot.com/login/admin`

---

## 🚀 部署脚本约定
