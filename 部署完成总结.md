# 山东省思政课一体化中心部署完成总结

## 🎯 部署核心信息

- **域名**: https://horsduroot.com
- **服务器**: 阿里云ECS (60.205.124.67)
- **环境**: Ubuntu 20.04 + Nginx + Node.js + MongoDB
- **SSL证书**: Let's Encrypt (自动续期)

## ✅ 已完成配置

### 1. HTTPS/SSL 配置 ✅

```bash
# 证书状态
sudo certbot certificates

# 证书自动续期
sudo systemctl status certbot.timer

# 测试续期 (推荐每月执行)
sudo certbot renew --dry-run
```

### 2. Nginx配置 ✅

- **配置文件**: `/etc/nginx/sites-available/sdszk`
- **HTTP→HTTPS自动重定向**: ✅
- **API代理** (`/api/*` → `localhost:3000`): ✅
- **CORS头部设置**: ✅
- **安全头部**: ✅

**关键配置要点**:

```nginx
# HTTPS重定向
server {
    listen 80;
    server_name horsduroot.com;
    return 301 https://$server_name$request_uri;
}

# API代理配置 (避免/api/api重复)
location /api/ {
    proxy_pass http://localhost:3000/api/;
    proxy_set_header X-Forwarded-Proto $scheme;
    add_header Access-Control-Allow-Origin "https://horsduroot.com" always;
}
```

### 3. 后端配置 ✅

- **Express信任代理**: `app.set('trust proxy', true)`
- **CORS允许域名**: `https://horsduroot.com`
- **端口监听**: 3000 (内部)
- **数据库连接**: MongoDB ✅

### 4. 前端配置 ✅

- **生产环境API地址**: `https://horsduroot.com/api`
- **强制HTTPS**: 所有API调用使用HTTPS协议
- **构建验证**: 已确认生产版本使用正确的API配置

### 5. CORS问题解决方案 ✅

**问题诊断**:

1. ✅ HTTP→HTTPS重定向正常工作
2. ✅ 前端API配置使用HTTPS
3. ✅ 后端CORS配置正确
4. ✅ Nginx代理和SSL正常

**解决步骤**:

1. 确认`.env.production`中API地址为`https://horsduroot.com/api`
2. 构建并部署前端，验证生产版本使用HTTPS API
3. 测试API端点响应正常

## 🔧 运维命令速查

### Nginx操作

```bash
# 测试配置
sudo nginx -t

# 重载配置
sudo systemctl reload nginx

# 查看状态
sudo systemctl status nginx

# 查看访问日志
sudo tail -f /var/log/nginx/access.log
```

### Node.js后端

```bash
# PM2状态
pm2 status

# 查看日志
pm2 logs sdszk-backend

# 重启服务
pm2 restart sdszk-backend

# 监控资源
pm2 monit
```

### SSL证书管理

```bash
# 查看证书状态
sudo certbot certificates

# 手动续期
sudo certbot renew

# 强制续期
sudo certbot renew --force-renewal
```

### 系统监控

```bash
# 端口监听状态
sudo netstat -tlnp | grep -E ':(80|443|3000)'

# 磁盘使用
df -h

# 内存使用
free -h

# 系统负载
htop
```

## 🚨 故障排查指南

### CORS错误

1. **检查前端API配置**: 确认使用HTTPS
2. **验证Nginx代理**: 检查/api路径转发
3. **确认后端CORS设置**: 检查允许的源域名

### SSL证书问题

```bash
# 检查证书有效性
openssl x509 -in /etc/letsencrypt/live/horsduroot.com/fullchain.pem -text -noout

# 测试SSL配置
openssl s_client -connect horsduroot.com:443 -servername horsduroot.com
```

### API连接问题

```bash
# 测试API健康状态
curl https://horsduroot.com/api/health

# 检查内部API
curl http://localhost:3000/api/health

# 验证代理转发
curl -H "X-Forwarded-Proto: https" http://localhost/api/health
```

## 📈 性能优化建议

### 已实现

- ✅ Gzip压缩
- ✅ 静态资源缓存
- ✅ API响应缓存
- ✅ 代码分割和懒加载

### 待优化

- [ ] CDN加速
- [ ] 数据库索引优化
- [ ] 图片压缩和WebP支持
- [ ] HTTP/2推送
- [ ] 服务端渲染(SSR)

## 🔒 安全配置

### 已实现

- ✅ HTTPS强制重定向
- ✅ 安全头部设置
- ✅ CORS限制
- ✅ JWT认证
- ✅ 文件上传限制

### 建议加强

- [ ] WAF防护
- [ ] DDoS防护
- [ ] IP白名单
- [ ] 日志监控和告警

## 📝 部署经验总结

### 关键经验

1. **Nginx配置管理**: 本地编写配置文件然后scp上传，避免命令行写入转义问题
2. **Trust Proxy**: Express必须配置trust proxy才能正确处理代理头部
3. **CORS调试**: 分步骤排查HTTP重定向、API配置、Nginx代理等
4. **SSL配置**: Let's Encrypt自动续期是关键，定期检查证书状态

### 避免的坑

1. ❌ 命令行写入复杂Nginx配置（转义问题）
2. ❌ 前端API配置不一致（开发环境vs生产环境）
3. ❌ 忘记配置trust proxy导致代理头部丢失
4. ❌ CORS配置不匹配导致跨域问题

### 调试技巧

1. **分层测试**: 从内到外逐层测试（本地API→Nginx代理→外部访问）
2. **详细日志**: 结合Nginx访问日志和Node.js应用日志
3. **curl验证**: 使用curl模拟各种请求场景
4. **浏览器工具**: 开发者工具Network面板分析请求响应

---

**最后更新**: 2025-06-20
**部署状态**: ✅ 生产就绪
