# 阿里云部署配置指南与状态总结

## 📊 项目概况与现状

### 🎯 项目信息

- **项目名称**: horsduroot.com - 山东省大中小学思政课一体化指导中心
- **部署环境**: 阿里云ECS服务器
- **技术栈**: Vue3 + Node.js + MongoDB + Nginx + PM2

### ✅ 当前运行状态

- **前后端服务**: 稳定运行，联调成功
- **数据库**: MongoDB 5.0 Docker容器正常
- **Web服务**: Nginx代理配置完成
- **进程管理**: PM2自动管理和监控

### 🏗️ 系统架构

#### 服务器配置

```
服务器IP: 60.205.124.67
前端域名: https://horsduroot.com
后端API: http://60.205.124.67:3000/api
数据库: MongoDB 5.0 (Docker容器)
Web服务器: Nginx
进程管理: PM2
```

#### 数据库结构 (sdszk)

```
核心集合 (10个):
├── users (用户管理)
├── news, newscategories (新闻内容)
├── resources, resourcecategories (资源文件)
├── activities, activitylogs (活动信息)
├── favorites, viewhistories (用户行为)
└── sitesettings (系统设置)
```

## 🔧 核心配置状态

### 1. 生产环境配置

- ✅ API频率限制：200次/分钟（核心API：50次/分钟）
- ✅ 登录安全：20次/5分钟限制
- ✅ 环境变量：NODE_ENV=production, JWT密钥已设置
- ✅ PM2配置：自动重启、日志记录、内存限制

### 2. 数据库配置 (关键调试信息)

- ✅ MongoDB版本：mongo:5.0 Docker容器
- ✅ 端口映射：0.0.0.0:27017->27017/tcp (容器已暴露)
- ✅ 数据持久化：/var/lib/mongodb
- ✅ 认证状态：无认证模式运行 (开发环境)
- 🔒 安全策略：27017端口未在安全组开放 (需SSH隧道访问)

### 3. 前端部署配置

- ✅ 静态文件路径：/var/www/frontend
- ✅ Nginx配置：前端路由 + API代理
- ✅ 域名解析：https://horsduroot.com
- ✅ SPA支持：try_files配置完成

### 4. 项目结构优化记录

- ✅ 清理完成：删除48个调试脚本
- ✅ 保留核心：5个生产脚本 + 3个数据初始化脚本
- ✅ Git记录：项目清理已提交 (commit: 5e69b11)

## 🚀 部署历程关键节点

### 主要问题解决记录

1. **MongoDB认证问题** → 使用Docker无认证模式解决
2. **API频率限制过严** → 调整到合理范围 (200次/分钟)
3. **前端403错误** → 修复Nginx静态文件权限和配置
4. **前后端数据结构不一致** → 修复核心分类字段 (isCore, key)
5. **项目结构混乱** → 清理48个无用脚本，保留核心工具

### 当前可验证功能

- ✅ 前端访问: https://horsduroot.com
- ✅ API服务: `curl http://60.205.124.67:3000/`
- ✅ 健康检查: `curl http://60.205.124.67:3000/api/health`
- ✅ 数据库管理: SSH隧道 + MongoDB Compass

## � 配置清单与下一步操作

### 立即可用功能 ✅

- **前端访问**: https://horsduroot.com
- **API服务**: http://60.205.124.67:3000/api
- **数据库管理**: SSH隧道 + MongoDB Compass
- **服务监控**: PM2日志和状态监控

### 验证清单

- [ ] 前端页面正常加载
- [ ] 新闻/资源API数据正常
- [ ] 用户登录功能正常
- [ ] 文件上传功能正常
- [ ] MongoDB Compass连接成功

### 持续维护要点

1. **定期检查**: PM2服务状态、磁盘空间
2. **数据备份**: 重要操作前备份MongoDB
3. **安全更新**: 定期更新系统和Docker镜像
4. **日志清理**: 定期清理PM2和Nginx日志

## 🛠️ 运维命令手册

### 服务管理命令

```bash
# SSH连接服务器
ssh root@60.205.124.67

# PM2服务管理
pm2 status                    # 查看所有服务状态
pm2 logs sdszk-backend       # 查看应用日志
pm2 restart sdszk-backend    # 重启后端服务
pm2 stop sdszk-backend       # 停止服务
pm2 start ecosystem.config.js # 启动服务

# 系统监控
pm2 monit                    # 实时监控
htop                         # 系统资源监控
df -h                        # 磁盘使用情况
free -h                      # 内存使用情况
```

### MongoDB管理命令

```bash
# Docker容器管理
docker ps | grep mongo               # 查看MongoDB容器状态
docker logs mongodb                  # 查看容器日志
docker exec -it mongodb mongosh      # 进入MongoDB shell

# 数据库操作
docker exec mongodb mongosh sdszk --eval "db.stats()"          # 数据库统计
docker exec mongodb mongosh sdszk --eval "db.getCollectionNames()" # 查看集合

# 本地隧道连接
./scripts/mongodb-tunnel.sh          # 启动SSH隧道
./scripts/test-mongodb-tunnel.sh     # 测试隧道连接
```

### 故障排查命令

```bash
# 端口检查
netstat -tlnp | grep :3000          # 检查API端口
netstat -tlnp | grep :27017         # 检查MongoDB端口
lsof -i :27018                       # 检查隧道端口

# 服务状态验证
curl http://localhost:3000/          # 测试API服务
curl http://localhost:3000/api/health # 健康检查

# 网络连通性测试
ping 60.205.124.67                   # 服务器连通性
ssh root@60.205.124.67 "echo 'SSH正常'" # SSH连接测试
```

## 🔧 MongoDB远程连接解决方案 ⭐

### 问题分析

- **现状**: MongoDB容器已暴露端口 (0.0.0.0:27017->27017/tcp)
- **限制**: 阿里云安全组未开放27017端口 (安全策略)
- **解决**: 使用SSH隧道实现安全远程访问

### 推荐解决方案：SSH隧道连接

#### 🚀 一键启动 (推荐)

```bash
# 自动建立隧道 (本地27018 → 远程27017)
./scripts/mongodb-tunnel.sh

# MongoDB Compass连接
mongodb://localhost:27018/sdszk
```

#### 🔧 手动建立隧道

```bash
# 手动命令
ssh -L 27018:localhost:27017 root@60.205.124.67 -N

# 验证隧道
lsof -i :27018
```

#### 📱 MongoDB Compass连接

```
连接字符串: mongodb://localhost:27018/sdszk
配置信息:
- Host: localhost
- Port: 27018
- Database: sdszk
- Authentication: None
```

### 📚 详细连接指南

- `MongoDB_Compass连接详细指南.md` - 图文详细步骤
- `MongoDB_Compass快速连接卡片.md` - 一分钟快速上手
- `MongoDB_SSH隧道连接指南.md` - 完整技术参考

```bash
# 全面测试隧道连接
./scripts/test-mongodb-tunnel.sh
```

### 备选方案：安全组端口开放

```
仅在必要时使用：
1. 阿里云控制台 → ECS → 安全组
2. 添加入方向规则：27017/TCP
3. 授权对象：您的IP/32（推荐）
4. 直接连接：mongodb://60.205.124.67:27017/sdszk
```

## � 重要配置文件和工具

### 核心脚本工具

```
scripts/
├── mongodb-tunnel.sh          # MongoDB SSH隧道连接
├── test-mongodb-tunnel.sh     # 隧道连接测试
├── deploy.sh                  # 主部署脚本
├── deploy-prod.sh            # 生产环境部署
├── deploy-backend.sh         # 后端部署
├── deploy-frontend.sh        # 前端部署
└── monitor.sh                # 监控脚本
```

### 配置文档

```
部署完成总结.md               # 本文档（配置总览）
MongoDB_SSH隧道连接指南.md    # 详细连接指南
.env.production              # 生产环境变量
```

### 服务器关键路径

```
/var/www/sdszk-backend/      # 后端代码目录
/var/www/frontend/           # 前端静态文件
/var/lib/mongodb/            # MongoDB数据目录
```

## 🎯 配置总结

**✅ 部署成功状态**

- 前后端服务运行稳定
- MongoDB数据库正常运行
- SSH隧道解决方案已验证
- 项目结构已优化清理

**🔒 安全配置**

- 数据库未直接暴露公网
- 使用SSH隧道安全访问
- API频率限制已启用
- PM2进程管理稳定运行

**📈 下一阶段**

- 监控生产环境运行状况
- 根据使用情况优化性能
- 定期备份重要数据
- 持续更新此配置文档

---

**服务器信息摘要:**

- 🖥️ IP: 60.205.124.67
- 🌐 域名: https://horsduroot.com
- 🔧 API: http://60.205.124.67:3000/api
- 🗄️ 数据库: MongoDB 5.0 (Docker)
- 📊 管理: SSH隧道 + MongoDB Compass
- ⚡ 进程: PM2自动管理

_文档最后更新: 2025年6月20日_

## 🛠️ 关键运维工具与调试指南

### 📁 核心文件和工具清单

```
项目根目录:
├── scripts/
│   ├── mongodb-tunnel.sh          # MongoDB SSH隧道 ⭐
│   ├── test-mongodb-tunnel.sh     # 隧道连接测试
│   ├── deploy.sh                  # 主部署脚本
│   ├── deploy-prod.sh            # 生产环境部署
│   ├── deploy-backend.sh         # 后端部署
│   ├── deploy-frontend.sh        # 前端部署
│   └── monitor.sh                # 监控脚本
├── 部署完成总结.md               # 本配置指南 ⭐
├── MongoDB_Compass连接详细指南.md # MongoDB连接指南
└── .env.production              # 生产环境变量

服务器路径:
├── /var/www/sdszk-backend/      # 后端代码目录
├── /var/www/frontend/           # 前端静态文件
└── /var/lib/mongodb/            # MongoDB数据目录
```

### ⚡ 常用调试命令速查

#### 服务状态检查

```bash
# 快速状态检查
ssh root@60.205.124.67 "pm2 status && docker ps | grep mongo"

# 详细服务监控
ssh root@60.205.124.67 "pm2 monit"

# 查看服务日志
ssh root@60.205.124.67 "pm2 logs sdszk-backend --lines 50"
```

#### MongoDB调试

```bash
# 数据库连接测试
./scripts/test-mongodb-tunnel.sh

# 查看数据库状态
ssh root@60.205.124.67 "docker exec mongodb mongosh sdszk --eval 'db.stats()'"

# 查看集合数据
ssh root@60.205.124.67 "docker exec mongodb mongosh sdszk --eval 'db.getCollectionNames()'"
```

#### 网络和端口检查

```bash
# 端口监听状态
ssh root@60.205.124.67 "netstat -tlnp | grep -E ':(3000|27017)'"

# API服务测试
curl -I http://60.205.124.67:3000/
curl -s http://60.205.124.67:3000/api/health | jq .
```

### 🚨 故障排查清单

#### 常见问题及解决方案

**1. 前端访问失败**

```bash
# 检查Nginx状态
ssh root@60.205.124.67 "nginx -t && systemctl status nginx"

# 检查前端文件
ssh root@60.205.124.67 "ls -la /var/www/frontend/ | head -10"
```

**2. API响应异常**

```bash
# 检查PM2服务
ssh root@60.205.124.67 "pm2 describe sdszk-backend"

# 查看最新错误日志
ssh root@60.205.124.67 "pm2 logs sdszk-backend --err --lines 20"
```

**3. MongoDB连接问题**

```bash
# 检查Docker容器
ssh root@60.205.124.67 "docker inspect mongodb | grep -A 10 NetworkSettings"

# 测试数据库连接
ssh root@60.205.124.67 "docker exec mongodb mongosh --eval 'db.adminCommand(\"hello\")'"
```

## 📊 系统状态总结

### ✅ 成功部署的功能

- **Web服务**: 前端 + API + 数据库全栈运行
- **进程管理**: PM2自动重启和监控
- **数据库管理**: SSH隧道 + MongoDB Compass可视化
- **项目结构**: 清理完成，保留核心工具

### 🔧 已解决的关键问题

1. **MongoDB认证** → Docker无认证模式 + SSH隧道安全访问
2. **API限流过严** → 优化到合理范围 (200次/分钟)
3. **前端静态资源** → Nginx配置 + 文件权限修复
4. **数据结构不一致** → 修复核心分类字段
5. **项目代码混乱** → 清理48个无用脚本

### 🎯 持续维护要点

- **安全性**: 定期更新SSH密钥，监控访问日志
- **性能**: 定期清理日志文件，监控系统资源
- **数据**: 重要操作前备份，定期验证数据完整性
- **文档**: 持续更新此配置指南

---

## 📞 技术支持信息

**服务器配置摘要:**

- 🖥️ **服务器**: 60.205.124.67 (阿里云ECS)
- 🌐 **前端**: https://horsduroot.com
- 🔧 **API**: http://60.205.124.67:3000/api
- 🗄️ **数据库**: MongoDB 5.0 (Docker) + SSH隧道访问
- ⚡ **管理**: PM2 + Nginx + MongoDB Compass

**关键连接信息:**

- SSH隧道: `./scripts/mongodb-tunnel.sh`
- Compass连接: `mongodb://localhost:27018/sdszk`
- 健康检查: `http://60.205.124.67:3000/api/health`

_最后更新: 2025年6月20日 - 包含完整调试和维护指南_

### 5. 部署脚本配置 (重要)

#### 🔧 核心部署脚本清单

**保留的重要脚本：**

1. **`scripts/deploy-backend.sh`** - 后端自动化部署

   - 功能：完整的后端代码打包、上传、部署、重启
   - 使用：`./scripts/deploy-backend.sh`
   - 特点：全自动化，包含PM2服务管理

2. **`scripts/deploy.sh`** - 前端完整部署

   - 功能：前端构建、上传、Nginx配置、自动化部署
   - 使用：`./scripts/deploy.sh`
   - 特点：包含Nginx配置和API代理设置

3. **`scripts/deploy-prod.sh`** - Docker容器化部署

   - 功能：MongoDB等服务的Docker容器管理
   - 使用：`./scripts/deploy-prod.sh`
   - 特点：包含MongoDB、Redis、Nginx的容器编排

4. **`scripts/mongodb-tunnel.sh`** - MongoDB连接管理

   - 功能：建立SSH隧道连接Docker中的MongoDB
   - 使用：`./scripts/mongodb-tunnel.sh`
   - 连接串：`mongodb://localhost:27018/sdszk`

5. **`docker-compose.prod.yml`** - 容器服务配置
   - 功能：MongoDB、Redis、应用容器的完整配置
   - 包含：数据卷、网络、环境变量配置

#### 🗑️ 已清理的脚本

- **`deploy-frontend.sh`** - 功能不完整，与deploy.sh重复 ✅ 已删除

#### 📋 脚本使用指南

**后端更新部署：**

```bash
./scripts/deploy-backend.sh
```

**前端更新部署：**

```bash
./scripts/deploy.sh
```

**MongoDB管理连接：**

```bash
./scripts/mongodb-tunnel.sh
# 然后在MongoDB Compass中连接: mongodb://localhost:27018/sdszk
```

**容器化部署（备用方案）：**

```bash
# 设置环境变量
export MONGO_PASSWORD=your_password
export REDIS_PASSWORD=your_password
export JWT_SECRET=your_secret

# 执行容器化部署
./scripts/deploy-prod.sh
```

#### ⚠️ 重要说明

1. **MongoDB运行方式**：当前使用独立Docker容器（mongo:5.0）
2. **应用部署方式**：使用传统PM2+Nginx方式，非容器化
3. **数据库访问**：需通过SSH隧道或服务器本地访问
4. **脚本依赖**：deploy-backend.sh和deploy.sh可独立使用
5. **备用方案**：docker-compose.prod.yml提供完整容器化方案
