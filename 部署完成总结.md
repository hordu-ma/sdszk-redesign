# 阿里云部署配置指南与状态总结

## 📊 项目概况与现状

### 🎯 项目信息

- **项目名称**: horsduroot.com - 山东省大中小学思政课一体化指导中心
- **部署环境**: 阿里云ECS服务器
- **技术栈**: Vue3 + Node.js + MongoDB + Nginx + PM2

### ✅ 当前运行状态

- **HTTPS网站**: https://horsduroot.com ✅ SSL证书配置完成
- **API服务**: HTTPS API代理 ✅ 解决ERR_CONNECTION_RESET问题
- **数据库**: MongoDB 5.0 Docker容器正常
- **Web服务**: Nginx HTTPS/SSL + API代理配置完成
- **进程管理**: PM2自动管理和监控

### 🏗️ 系统架构

#### 服务器配置

```
服务器IP: 60.205.124.67
前端域名: https://horsduroot.com (HTTPS + SSL证书)
后端API: https://horsduroot.com/api (通过Nginx代理)
数据库: MongoDB 5.0 (Docker容器)
Web服务器: Nginx (HTTP→HTTPS重定向 + SSL终端)
进程管理: PM2
SSL证书: Let's Encrypt (自动续期)
```

#### 数据库结构 (sdszk)

```
核心集合 (10个):
├── users (用户管理)
├── news, newscategories (新闻内容)
├── resources, resourcecategories (资源文件)
├── activities, activitylogs (活动信息)
├── favorites, viewhistories (用户行为)
└── sitesettings (系统设置)
```

## 🔧 核心配置状态

### 1. HTTPS/SSL配置 (2025-06-20最新)

- ✅ **SSL证书**: Let's Encrypt自动证书，有效期至2025-09-17
- ✅ **HTTPS重定向**: HTTP→HTTPS自动重定向配置
- ✅ **TLS配置**: TLS 1.2/1.3 + HTTP/2支持
- ✅ **安全头部**: HSTS、CORS、XSS保护等完整配置
- ✅ **API代理**: HTTPS→HTTP后端代理正常工作
- ⚠️ **重要**: Nginx配置文件：`nginx-ssl.conf` (本地备份)

### 2. 生产环境配置

- ✅ API频率限制：200次/分钟（核心API：50次/分钟）
- ✅ 登录安全：20次/5分钟限制
- ✅ 环境变量：NODE_ENV=production, JWT密钥已设置
- ✅ PM2配置：自动重启、日志记录、内存限制
- ✅ Express trust proxy: 已配置，解决代理头部问题

### 3. 数据库配置

- ✅ MongoDB版本：mongo:5.0 Docker容器
- ✅ 端口映射：0.0.0.0:27017->27017/tcp (容器已暴露)
- ✅ 数据持久化：/var/lib/mongodb
- ✅ 认证状态：无认证模式运行 (开发环境)
- 🔒 安全策略：27017端口未在安全组开放 (需SSH隧道访问)

### 4. Nginx配置 (关键)

- ✅ **配置文件**: `/etc/nginx/sites-available/sdszk`
- ✅ **监听端口**: 80 (重定向) + 443 (HTTPS)
- ✅ **SSL配置**: Let's Encrypt证书路径配置
- ✅ **API代理**: `/api/` → `http://localhost:3000/api/`
- ✅ **静态文件**: `/var/www/frontend` + SPA路由支持
- ⚠️ **重要提醒**: 切勿在命令行直接写入配置文件，会导致转义问题！

## 🚀 关键问题解决记录

### 核心问题修复历史

1. **ERR_CONNECTION_RESET API错误** (2025-06-20) ✅ 已解决

   - **问题**: 前端HTTPS调用后端HTTP API被浏览器阻止
   - **解决**: 配置Nginx HTTPS终端 + API代理
   - **配置**: `nginx-ssl.conf` 完整HTTPS配置

2. **Express trust proxy配置** ✅ 已解决

   - **问题**: X-Forwarded-For头部验证失败
   - **解决**: 在`server/app.js`中设置`app.set("trust proxy", true)`

3. **MongoDB认证问题** ✅ 已解决

   - **解决**: 使用Docker无认证模式 + SSH隧道安全访问

4. **API频率限制过严** ✅ 已解决

   - **调整**: 200次/分钟（核心API：50次/分钟）

5. **项目结构混乱** ✅ 已解决
   - **清理**: 删除48个调试脚本，保留核心工具

### 部署最佳实践总结

#### ⚠️ 重要经验教训

1. **Nginx配置文件编辑**：

   - ❌ 避免：SSH命令行直接写入配置文件
   - ✅ 推荐：本地创建→scp上传→服务器应用
   - **原因**: 命令行转义问题导致配置失效

2. **SSL证书配置验证**：

   ```bash
   # 检查端口监听
   netstat -tlnp | grep nginx
   # 应显示：:80 和 :443 两个端口

   # 测试HTTPS连接
   curl -k -v https://horsduroot.com/api/health
   ```

3. **API代理调试流程**：

   ```bash
   # 1. 检查后端服务
   curl http://localhost:3000/api/health

   # 2. 检查Nginx代理
   curl -H 'Host: horsduroot.com' http://localhost/api/health

   # 3. 检查HTTPS终端
   curl -k https://horsduroot.com/api/health
   ```

## 🛠️ 部署脚本配置 (重要)

### 🔧 核心部署脚本清单

**保留的重要脚本：**

1. **`scripts/deploy-backend.sh`** - 后端自动化部署

   - 功能：完整的后端代码打包、上传、部署、重启
   - 使用：`./scripts/deploy-backend.sh`
   - 特点：全自动化，包含PM2服务管理

2. **`scripts/deploy.sh`** - 前端完整部署

   - 功能：前端构建、上传、Nginx配置、自动化部署
   - 使用：`./scripts/deploy.sh`
   - 特点：包含Nginx配置和API代理设置

3. **`scripts/mongodb-tunnel.sh`** - MongoDB连接管理

   - 功能：建立SSH隧道连接Docker中的MongoDB
   - 使用：`./scripts/mongodb-tunnel.sh`
   - 连接串：`mongodb://localhost:27018/sdszk`

4. **`nginx-ssl.conf`** - HTTPS Nginx配置文件 (本地备份)
   - 功能：完整的HTTPS配置 + API代理
   - 上传：`scp nginx-ssl.conf root@60.205.124.67:/etc/nginx/sites-available/sdszk`

### 📋 快速部署指南

**后端更新部署：**

```bash
./scripts/deploy-backend.sh
```

**前端更新部署：**

```bash
./scripts/deploy.sh
```

**MongoDB管理连接：**

```bash
./scripts/mongodb-tunnel.sh
# MongoDB Compass连接: mongodb://localhost:27018/sdszk
```

**Nginx配置更新：**

```bash
# 本地修改 nginx-ssl.conf 后
scp nginx-ssl.conf root@60.205.124.67:/tmp/
ssh root@60.205.124.67 "mv /tmp/nginx-ssl.conf /etc/nginx/sites-available/sdszk && nginx -t && systemctl reload nginx"
```

### ⚠️ 重要经验和注意事项

1. **配置文件编辑**：

   - ❌ 切勿在SSH命令行直接写入配置文件 (转义问题)
   - ✅ 本地创建配置文件→scp上传→服务器应用

2. **SSL配置验证**：

   ```bash
   # 检查端口监听
   ssh root@60.205.124.67 "netstat -tlnp | grep nginx"
   # 应显示 :80 和 :443 两个端口
   ```

3. **API调试流程**：

   ```bash
   # 测试后端服务
   ssh root@60.205.124.67 "curl http://localhost:3000/api/health"

   # 测试HTTPS API
   ssh root@60.205.124.67 "curl -k https://horsduroot.com/api/health"
   ```

## 🔧 MongoDB远程连接解决方案

### SSH隧道连接 (推荐)

```bash
# 自动建立隧道 (本地27018 → 远程27017)
./scripts/mongodb-tunnel.sh

# MongoDB Compass连接
mongodb://localhost:27018/sdszk
```

### 连接验证

```bash
# 测试隧道连接
./scripts/test-mongodb-tunnel.sh
```

## 🛠️ 运维命令手册

### 服务管理命令

```bash
# SSH连接服务器
ssh root@60.205.124.67

# PM2服务管理
pm2 status                    # 查看所有服务状态
pm2 logs sdszk-backend       # 查看应用日志
pm2 restart sdszk-backend    # 重启后端服务

# Nginx管理
nginx -t                     # 测试配置
systemctl reload nginx       # 重新加载配置
systemctl status nginx       # 查看状态
```

### 常用调试命令

```bash
# 服务状态检查
ssh root@60.205.124.67 "pm2 status && docker ps | grep mongo"

# 端口监听检查
ssh root@60.205.124.67 "netstat -tlnp | grep -E ':(80|443|3000|27017)'"

# API服务测试
curl -I https://horsduroot.com/api/health
```

## � 当前系统状态

### ✅ 成功部署的功能

- **HTTPS网站**: https://horsduroot.com ✅
- **HTTPS API**: 通过Nginx代理，解决混合内容问题 ✅
- **数据库管理**: SSH隧道 + MongoDB Compass ✅
- **自动化部署**: 后端/前端部署脚本 ✅
- **SSL安全**: Let's Encrypt证书 + HSTS ✅

### 🎯 维护要点

- **安全**: 定期检查SSL证书有效期
- **性能**: 监控PM2服务状态和系统资源
- **备份**: 重要操作前备份MongoDB数据
- **文档**: 持续更新配置变更记录

---

## 📞 重要信息摘要

**服务器配置:**

- 🖥️ **服务器**: 60.205.124.67 (阿里云ECS)
- 🌐 **网站**: https://horsduroot.com (HTTPS + SSL)
- 🔧 **API**: https://horsduroot.com/api (Nginx代理)
- 🗄️ **数据库**: MongoDB 5.0 (Docker) + SSH隧道
- ⚡ **管理**: PM2 + Nginx + Let's Encrypt

**关键文件:**

- Nginx配置: `nginx-ssl.conf` (本地备份)
- 部署脚本: `scripts/deploy-backend.sh`, `scripts/deploy.sh`
- MongoDB连接: `scripts/mongodb-tunnel.sh`

_最后更新: 2025年6月20日 - 包含HTTPS/SSL配置和重要经验总结_
