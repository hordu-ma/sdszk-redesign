# 阿里云部署问题快速修复指南

## 问题分析

根据您提供的控制台错误截图，主要有以下问题：

1. **500 Internal Server Error** - 服务器内部错误
2. **429 Too Many Requests** - 请求频率限制触发
3. **API调用失败** - 多个接口无法正常响应

## 快速修复步骤

### 第一步：上传修复文件到服务器

```bash
# 将以下文件上传到服务器的 /var/www/sdszk-backend 目录
- scripts/fix-production-issues.sh
- scripts/comprehensive-check.sh
- 更新后的 server/middleware/rateLimit.js
- 新增的 server/routes/health.js
- 更新后的 server/app.js
```

### 第二步：运行修复脚本

```bash
# 连接到阿里云服务器
ssh root@你的服务器IP

# 进入项目目录
cd /var/www/sdszk-backend

# 给脚本添加执行权限
chmod +x scripts/fix-production-issues.sh
chmod +x scripts/comprehensive-check.sh

# 运行完整检查脚本
./scripts/comprehensive-check.sh

# 运行修复脚本
./scripts/fix-production-issues.sh
```

### 第三步：验证修复结果

```bash
# 检查服务状态
pm2 status

# 查看服务日志
pm2 logs sdszk-backend --lines 20

# 测试健康检查API
curl http://localhost:3000/api/health

# 测试登录API
curl -X POST \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}' \
  http://localhost:3000/api/auth/login
```

## 主要修复内容

### 1. 频率限制优化

- 默认限制：从100次/分钟提升到200次/分钟
- 核心API限制：从15次/分钟提升到50次/分钟
- 登录API限制：从10次/5分钟提升到20次/5分钟
- 添加了健康检查和静态资源的跳过规则

### 2. 错误处理改进

- 增强了错误日志记录
- 改进了500错误的响应消息
- 添加了错误时间戳和详细信息

### 3. 健康检查功能

- 新增 `/api/health` 端点
- 新增 `/api/status` 端点
- 包含数据库连接状态、内存使用情况等信息

### 4. 服务稳定性改进

- 使用PM2管理进程
- 配置了自动重启和日志记录
- 设置了内存限制和优化参数

## 常见问题解决

### 问题1：环境变量未设置

```bash
# 设置必需的环境变量
export MONGODB_URI="你的MongoDB连接字符串"
export JWT_SECRET="你的JWT密钥"
export FRONTEND_URL="https://hordu-ma.github.io"
export NODE_ENV="production"

# 将环境变量写入系统配置
echo 'export MONGODB_URI="你的MongoDB连接字符串"' >> ~/.bashrc
echo 'export JWT_SECRET="你的JWT密钥"' >> ~/.bashrc
echo 'export FRONTEND_URL="https://hordu-ma.github.io"' >> ~/.bashrc
echo 'export NODE_ENV="production"' >> ~/.bashrc
source ~/.bashrc
```

### 问题2：MongoDB连接失败

```bash
# 测试MongoDB连接
mongosh "你的MongoDB连接字符串" --eval "db.adminCommand('ping')"

# 如果连接失败，检查：
# 1. 连接字符串格式是否正确
# 2. 网络是否可达
# 3. 用户名密码是否正确
# 4. 数据库是否允许当前IP访问
```

### 问题3：PM2服务异常

```bash
# 重启PM2服务
pm2 restart sdszk-backend

# 如果PM2异常，重新启动
pm2 delete sdszk-backend
pm2 start ecosystem.config.js
pm2 save

# 设置开机自启
pm2 startup
```

### 问题4：端口被占用

```bash
# 查看端口占用
netstat -tlnp | grep :3000

# 如果端口被占用，杀死进程
pkill -f "node.*app.js"
# 然后重新启动服务
pm2 start ecosystem.config.js
```

## 监控和维护

### 日志监控

```bash
# 实时查看应用日志
pm2 logs sdszk-backend

# 查看错误日志
tail -f logs/pm2-error.log

# 查看系统日志
journalctl -u pm2-root -f
```

### 性能监控

```bash
# 查看PM2监控
pm2 monit

# 查看系统资源
htop
# 或
top
```

### 定期检查

建议每天运行一次完整检查脚本：

```bash
# 添加到crontab
crontab -e
# 添加以下行：
# 0 2 * * * cd /var/www/sdszk-backend && ./scripts/comprehensive-check.sh >> logs/daily-check.log 2>&1
```

## 联系支持

如果问题仍然存在，请提供以下信息：

1. `./scripts/comprehensive-check.sh` 的完整输出
2. `pm2 logs sdszk-backend` 的最近日志
3. 浏览器开发者工具的网络面板截图
4. 服务器的基本信息（操作系统、内存、CPU等）

## 前端配置检查

确保前端项目中的API基础URL配置正确：

```javascript
// 检查前端配置文件中的API_BASE_URL
// 应该指向: https://你的阿里云服务器IP:3000/api
// 或者: https://你的域名/api (如果配置了反向代理)
```

如果前端是在GitHub Pages上部署的，确保：

1. CORS配置包含了GitHub Pages域名
2. API请求使用HTTPS (如果服务器支持SSL)
