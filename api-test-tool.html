<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CMS API æµ‹è¯•å·¥å…·</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .button {
        background: #1890ff;
        color: white;
        border: none;
        padding: 10px 16px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      .button:hover {
        background: #40a9ff;
      }
      .log {
        background: #f6f8fa;
        border: 1px solid #e1e4e8;
        border-radius: 4px;
        padding: 10px;
        margin: 10px 0;
        font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
        font-size: 12px;
        white-space: pre-wrap;
        max-height: 400px;
        overflow-y: auto;
      }
      .success {
        color: #28a745;
      }
      .error {
        color: #dc3545;
      }
      .info {
        color: #17a2b8;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ§ª CMS API æµ‹è¯•å·¥å…·</h1>
      <div>
        <button class="button" onclick="testLogin()">1. æµ‹è¯•ç™»å½•</button>
        <button class="button" onclick="testCategories()">2. æµ‹è¯•åˆ†ç±»</button>
        <button class="button" onclick="testNewsList()">3. æµ‹è¯•æ–°é—»åˆ—è¡¨</button>
        <button class="button" onclick="testCreateNews()">4. åˆ›å»ºæ–°é—»</button>
        <button class="button" onclick="testFullWorkflow()">ğŸš€ å®Œæ•´æµ‹è¯•</button>
        <button class="button" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
      </div>
      <div id="log" class="log"></div>
    </div>

    <script>
      let token = ''
      let categories = []

      function log(message, type = 'info') {
        const logElement = document.getElementById('log')
        const timestamp = new Date().toLocaleTimeString()
        const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info'
        logElement.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`
        logElement.scrollTop = logElement.scrollHeight
      }

      function clearLog() {
        document.getElementById('log').innerHTML = ''
      }

      async function testLogin() {
        log('ğŸ” å¼€å§‹æµ‹è¯•ç™»å½•...', 'info')
        try {
          const response = await fetch('http://localhost:3000/api/auth/login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              username: 'admin',
              password: 'admin123',
            }),
          })

          const data = await response.json()
          if (data.status === 'success') {
            token = data.data.token
            log(`âœ… ç™»å½•æˆåŠŸï¼ŒToken: ${token.substring(0, 20)}...`, 'success')
          } else {
            log(`âŒ ç™»å½•å¤±è´¥: ${data.message}`, 'error')
          }
        } catch (error) {
          log(`âŒ ç™»å½•é”™è¯¯: ${error.message}`, 'error')
        }
      }

      async function testCategories() {
        log('ğŸ“‚ å¼€å§‹æµ‹è¯•åˆ†ç±»è·å–...', 'info')
        try {
          const response = await fetch('http://localhost:3000/api/news-categories')
          const data = await response.json()

          if (data.status === 'success') {
            categories = data.data
            log(`âœ… è·å–åˆ†ç±»æˆåŠŸï¼Œå…± ${categories.length} ä¸ªåˆ†ç±»`, 'success')
            categories.forEach((cat, index) => {
              log(`   ${index + 1}. ${cat.name} (ID: ${cat._id})`, 'info')
            })
          } else {
            log(`âŒ è·å–åˆ†ç±»å¤±è´¥: ${data.message}`, 'error')
          }
        } catch (error) {
          log(`âŒ åˆ†ç±»è·å–é”™è¯¯: ${error.message}`, 'error')
        }
      }

      async function testNewsList() {
        if (!token) {
          log('âŒ è¯·å…ˆç™»å½•è·å–Token', 'error')
          return
        }

        log('ğŸ“° å¼€å§‹æµ‹è¯•æ–°é—»åˆ—è¡¨è·å–...', 'info')
        try {
          const response = await fetch('http://localhost:3000/api/admin/news?page=1&limit=5', {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          })

          const data = await response.json()

          if (data.status === 'success') {
            const newsList = data.data.data
            const pagination = data.data.pagination

            log(`âœ… è·å–æ–°é—»åˆ—è¡¨æˆåŠŸ`, 'success')
            log(
              `   æ€»æ•°: ${pagination.total}, å½“å‰é¡µ: ${pagination.page}, æ¯é¡µ: ${pagination.limit}`,
              'info'
            )

            newsList.forEach((news, index) => {
              const categoryName =
                typeof news.category === 'object' ? news.category.name : 'æœªçŸ¥åˆ†ç±»'
              log(
                `   ${index + 1}. ${news.title} | çŠ¶æ€: ${news.status} | åˆ†ç±»: ${categoryName}`,
                'info'
              )
            })
          } else {
            log(`âŒ è·å–æ–°é—»åˆ—è¡¨å¤±è´¥: ${data.message}`, 'error')
          }
        } catch (error) {
          log(`âŒ æ–°é—»åˆ—è¡¨è·å–é”™è¯¯: ${error.message}`, 'error')
        }
      }

      async function testCreateNews() {
        if (!token) {
          log('âŒ è¯·å…ˆç™»å½•è·å–Token', 'error')
          return
        }

        if (categories.length === 0) {
          log('âŒ è¯·å…ˆè·å–åˆ†ç±»ä¿¡æ¯', 'error')
          return
        }

        log('âœï¸ å¼€å§‹æµ‹è¯•æ–°é—»åˆ›å»º...', 'info')
        try {
          const newsData = {
            title: `æµè§ˆå™¨APIæµ‹è¯•æ–°é—» - ${new Date().toLocaleString()}`,
            content:
              'è¿™æ˜¯é€šè¿‡æµè§ˆå™¨APIåˆ›å»ºçš„æµ‹è¯•æ–°é—»å†…å®¹ã€‚åŒ…å«äº†å®Œæ•´çš„æ–°é—»æ­£æ–‡ï¼Œç”¨äºæµ‹è¯•æ–°é—»åˆ›å»ºåŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚',
            summary: 'è¿™æ˜¯ä¸€æ¡é€šè¿‡æµè§ˆå™¨APIåˆ›å»ºçš„æµ‹è¯•æ–°é—»',
            category: categories[0]._id,
            status: 'published',
            tags: ['æµè§ˆå™¨æµ‹è¯•', 'APIæµ‹è¯•'],
            isTop: false,
            isFeatured: false,
          }

          log(`ğŸ“ åˆ›å»ºæ–°é—»æ•°æ®: ${JSON.stringify(newsData, null, 2)}`, 'info')

          const response = await fetch('http://localhost:3000/api/admin/news', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(newsData),
          })

          const data = await response.json()

          if (data.status === 'success') {
            log(`âœ… åˆ›å»ºæ–°é—»æˆåŠŸ!`, 'success')
            log(`   æ–°é—»ID: ${data.data._id}`, 'info')
            log(`   æ–°é—»æ ‡é¢˜: ${data.data.title}`, 'info')
            log(`   æ–°é—»çŠ¶æ€: ${data.data.status}`, 'info')

            // ç«‹å³éªŒè¯æ–°é—»åˆ—è¡¨
            setTimeout(() => {
              log('ğŸ” éªŒè¯æ–°é—»æ˜¯å¦å‡ºç°åœ¨åˆ—è¡¨ä¸­...', 'info')
              testNewsList()
            }, 1000)
          } else {
            log(`âŒ åˆ›å»ºæ–°é—»å¤±è´¥: ${data.message}`, 'error')
          }
        } catch (error) {
          log(`âŒ æ–°é—»åˆ›å»ºé”™è¯¯: ${error.message}`, 'error')
        }
      }

      async function testFullWorkflow() {
        log('ğŸš€ å¼€å§‹å®Œæ•´å·¥ä½œæµç¨‹æµ‹è¯•...', 'info')
        log('================================================', 'info')

        await testLogin()
        await new Promise(resolve => setTimeout(resolve, 500))

        await testCategories()
        await new Promise(resolve => setTimeout(resolve, 500))

        await testNewsList()
        await new Promise(resolve => setTimeout(resolve, 500))

        await testCreateNews()

        log('================================================', 'info')
        log('ğŸ‰ å®Œæ•´å·¥ä½œæµç¨‹æµ‹è¯•å®Œæˆ!', 'success')
      }

      // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨å¼€å§‹æµ‹è¯•
      window.onload = function () {
        log('ğŸ§ª CMS API æµ‹è¯•å·¥å…·å·²å°±ç»ª', 'success')
        log('ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•ï¼Œæˆ–ç‚¹å‡» "å®Œæ•´æµ‹è¯•" è¿è¡Œå…¨éƒ¨æµ‹è¯•', 'info')
      }
    </script>
  </body>
</html>
