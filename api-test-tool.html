<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CMS API 测试工具</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .button {
        background: #1890ff;
        color: white;
        border: none;
        padding: 10px 16px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      .button:hover {
        background: #40a9ff;
      }
      .log {
        background: #f6f8fa;
        border: 1px solid #e1e4e8;
        border-radius: 4px;
        padding: 10px;
        margin: 10px 0;
        font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
        font-size: 12px;
        white-space: pre-wrap;
        max-height: 400px;
        overflow-y: auto;
      }
      .success {
        color: #28a745;
      }
      .error {
        color: #dc3545;
      }
      .info {
        color: #17a2b8;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>🧪 CMS API 测试工具</h1>
      <div>
        <button class="button" onclick="testLogin()">1. 测试登录</button>
        <button class="button" onclick="testCategories()">2. 测试分类</button>
        <button class="button" onclick="testNewsList()">3. 测试新闻列表</button>
        <button class="button" onclick="testCreateNews()">4. 创建新闻</button>
        <button class="button" onclick="testFullWorkflow()">🚀 完整测试</button>
        <button class="button" onclick="clearLog()">清空日志</button>
      </div>
      <div id="log" class="log"></div>
    </div>

    <script>
      let token = ''
      let categories = []

      function log(message, type = 'info') {
        const logElement = document.getElementById('log')
        const timestamp = new Date().toLocaleTimeString()
        const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info'
        logElement.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`
        logElement.scrollTop = logElement.scrollHeight
      }

      function clearLog() {
        document.getElementById('log').innerHTML = ''
      }

      async function testLogin() {
        log('🔐 开始测试登录...', 'info')
        try {
          const response = await fetch('http://localhost:3000/api/auth/login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              username: 'admin',
              password: 'admin123',
            }),
          })

          const data = await response.json()
          if (data.status === 'success') {
            token = data.data.token
            log(`✅ 登录成功，Token: ${token.substring(0, 20)}...`, 'success')
          } else {
            log(`❌ 登录失败: ${data.message}`, 'error')
          }
        } catch (error) {
          log(`❌ 登录错误: ${error.message}`, 'error')
        }
      }

      async function testCategories() {
        log('📂 开始测试分类获取...', 'info')
        try {
          const response = await fetch('http://localhost:3000/api/news-categories')
          const data = await response.json()

          if (data.status === 'success') {
            categories = data.data
            log(`✅ 获取分类成功，共 ${categories.length} 个分类`, 'success')
            categories.forEach((cat, index) => {
              log(`   ${index + 1}. ${cat.name} (ID: ${cat._id})`, 'info')
            })
          } else {
            log(`❌ 获取分类失败: ${data.message}`, 'error')
          }
        } catch (error) {
          log(`❌ 分类获取错误: ${error.message}`, 'error')
        }
      }

      async function testNewsList() {
        if (!token) {
          log('❌ 请先登录获取Token', 'error')
          return
        }

        log('📰 开始测试新闻列表获取...', 'info')
        try {
          const response = await fetch('http://localhost:3000/api/admin/news?page=1&limit=5', {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          })

          const data = await response.json()

          if (data.status === 'success') {
            const newsList = data.data.data
            const pagination = data.data.pagination

            log(`✅ 获取新闻列表成功`, 'success')
            log(
              `   总数: ${pagination.total}, 当前页: ${pagination.page}, 每页: ${pagination.limit}`,
              'info'
            )

            newsList.forEach((news, index) => {
              const categoryName =
                typeof news.category === 'object' ? news.category.name : '未知分类'
              log(
                `   ${index + 1}. ${news.title} | 状态: ${news.status} | 分类: ${categoryName}`,
                'info'
              )
            })
          } else {
            log(`❌ 获取新闻列表失败: ${data.message}`, 'error')
          }
        } catch (error) {
          log(`❌ 新闻列表获取错误: ${error.message}`, 'error')
        }
      }

      async function testCreateNews() {
        if (!token) {
          log('❌ 请先登录获取Token', 'error')
          return
        }

        if (categories.length === 0) {
          log('❌ 请先获取分类信息', 'error')
          return
        }

        log('✏️ 开始测试新闻创建...', 'info')
        try {
          const newsData = {
            title: `浏览器API测试新闻 - ${new Date().toLocaleString()}`,
            content:
              '这是通过浏览器API创建的测试新闻内容。包含了完整的新闻正文，用于测试新闻创建功能是否正常工作。',
            summary: '这是一条通过浏览器API创建的测试新闻',
            category: categories[0]._id,
            status: 'published',
            tags: ['浏览器测试', 'API测试'],
            isTop: false,
            isFeatured: false,
          }

          log(`📝 创建新闻数据: ${JSON.stringify(newsData, null, 2)}`, 'info')

          const response = await fetch('http://localhost:3000/api/admin/news', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(newsData),
          })

          const data = await response.json()

          if (data.status === 'success') {
            log(`✅ 创建新闻成功!`, 'success')
            log(`   新闻ID: ${data.data._id}`, 'info')
            log(`   新闻标题: ${data.data.title}`, 'info')
            log(`   新闻状态: ${data.data.status}`, 'info')

            // 立即验证新闻列表
            setTimeout(() => {
              log('🔍 验证新闻是否出现在列表中...', 'info')
              testNewsList()
            }, 1000)
          } else {
            log(`❌ 创建新闻失败: ${data.message}`, 'error')
          }
        } catch (error) {
          log(`❌ 新闻创建错误: ${error.message}`, 'error')
        }
      }

      async function testFullWorkflow() {
        log('🚀 开始完整工作流程测试...', 'info')
        log('================================================', 'info')

        await testLogin()
        await new Promise(resolve => setTimeout(resolve, 500))

        await testCategories()
        await new Promise(resolve => setTimeout(resolve, 500))

        await testNewsList()
        await new Promise(resolve => setTimeout(resolve, 500))

        await testCreateNews()

        log('================================================', 'info')
        log('🎉 完整工作流程测试完成!', 'success')
      }

      // 页面加载时自动开始测试
      window.onload = function () {
        log('🧪 CMS API 测试工具已就绪', 'success')
        log('点击按钮开始测试，或点击 "完整测试" 运行全部测试', 'info')
      }
    </script>
  </body>
</html>
