# 登录401问题排查 - 行动计划

## 当前状态

✅ 本地登录功能正常  
✅ 后端代码已添加详细调试日志  
✅ 打包文件已准备完成：`server-deploy.zip`  
✅ 调试工具已准备完成：`aliyun-debug-tools.zip`  
❌ 线上环境登录返回401错误

## 需要上传到阿里云服务器的文件

1. **server-deploy.zip** - 包含调试版本的后端代码
2. **aliyun-debug-tools.zip** - 包含调试和修复脚本

## 阿里云服务器操作步骤

### 第一步：上传文件

```bash
# 将以下文件上传到阿里云服务器根目录
- server-deploy.zip
- aliyun-debug-tools.zip
```

### 第二步：解压调试工具

```bash
ssh root@你的阿里云IP
cd ~
unzip aliyun-debug-tools.zip
chmod +x aliyun-tools/*.sh
```

### 第三步：设置环境变量（关键步骤）

```bash
# 编辑环境变量文件
nano /etc/environment

# 添加以下内容（请替换为实际值）
MONGODB_URI="mongodb+srv://用户名:密码@cluster.mongodb.net/数据库名"
JWT_SECRET="你的JWT密钥"
FRONTEND_URL="https://你的GitHub用户名.github.io/sdszk-redesign"
NODE_ENV="production"

# 重新加载环境变量
source /etc/environment

# 验证环境变量
echo $MONGODB_URI
echo $JWT_SECRET
echo $FRONTEND_URL
```

### 第四步：部署后端服务

```bash
# 创建部署目录
mkdir -p /var/www/sdszk-backend
cd /var/www/sdszk-backend

# 解压后端代码
unzip ~/server-deploy.zip

# 启动服务
npm start
```

### 第五步：运行调试脚本

```bash
# 进入后端目录
cd /var/www/sdszk-backend

# 运行调试脚本
~/aliyun-tools/aliyun-debug.sh
```

### 第六步：如果需要重置admin密码

```bash
cd /var/www/sdszk-backend
~/aliyun-tools/aliyun-reset-password.sh
```

## 重点检查项目

### 1. 环境变量配置

- **MONGODB_URI**: 确保连接字符串正确，包含正确的用户名、密码和数据库名
- **JWT_SECRET**: 确保与本地开发环境一致
- **FRONTEND_URL**: 确保是GitHub Pages的正确地址

### 2. MongoDB数据库

- 检查admin用户是否存在
- 检查密码哈希是否正确
- 检查用户状态是否为激活

### 3. 网络连接

- 确保服务器可以访问MongoDB Atlas
- 确保前端可以访问后端API
- 检查CORS配置

## 可能的问题和解决方案

### 问题1：环境变量未正确设置

**症状**: 调试脚本显示环境变量为"未设置"  
**解决**: 重新设置环境变量并重启服务

### 问题2：MongoDB连接失败

**症状**: 调试脚本显示"MongoDB连接失败"  
**解决**: 检查MONGODB_URI格式，确保网络可达

### 问题3：admin用户不存在或密码错误

**症状**: 调试脚本显示"未找到admin用户"或登录失败  
**解决**: 运行密码重置脚本

### 问题4：CORS错误

**症状**: 前端显示CORS错误  
**解决**: 检查FRONTEND_URL环境变量

## 调试日志分析重点

运行调试脚本后，特别关注以下输出：

1. **环境变量部分** - 确保所有必需的环境变量都已设置
2. **MongoDB连接部分** - 确保连接成功
3. **Admin用户部分** - 确保用户存在且数据正确
4. **API测试部分** - 查看具体的错误响应
5. **应用日志部分** - 查看详细的调试日志

## 预期结果

执行以上步骤后，应该能够：

1. 确定401错误的具体原因
2. 修复相关配置问题
3. 恢复正常的登录功能

## 紧急情况联系

如果遇到无法解决的问题，请：

1. 保存调试脚本的完整输出
2. 截图错误信息
3. 联系技术支持

---

**下一步操作**: 请按照上述步骤在阿里云服务器上执行调试，并提供调试脚本的输出结果。
