# 数据库同步说明

本文档说明如何在开发环境和生产环境之间同步 MongoDB 数据。

## 📋 概述

项目提供了三种数据库同步方式：

1. **快速同步** - 一键从生产环境同步数据到本地
2. **完整同步工具** - 提供多种同步和备份选项的交互式工具
3. **SSH隧道连接** - 直接连接生产环境数据库进行查看

## 🚀 快速开始

### 方式一：快速同步（推荐）

最简单的方式，一条命令完成数据同步：

```bash
npm run db:sync
```

或者直接运行脚本：

```bash
./scripts/quick-sync.sh
```

**功能：**
- 自动备份本地数据（安全措施）
- 从生产环境下载最新数据
- 清空并恢复本地数据库
- 自动清除Redis缓存
- 提供详细的同步日志

### 方式二：完整同步工具

提供更多选项的交互式工具：

```bash
npm run db:sync-full
```

**功能菜单：**
1. 从生产环境备份数据到本地
2. 将生产环境数据同步到本地开发环境
3. 备份本地数据
4. 恢复本地数据（从备份文件）
5. 通过SSH隧道连接生产环境
6. 查看备份文件列表
7. 清理旧备份文件

### 方式三：SSH隧道连接

直接连接生产环境数据库（只读查看）：

```bash
npm run db:tunnel
```

连接成功后，可以使用以下连接字符串在 MongoDB Compass 中查看生产数据：
```
mongodb://localhost:27018/sdszk
```

## 🛠️ 环境要求

### 必需软件

1. **MongoDB Tools**
   ```bash
   # macOS
   brew install mongodb/brew/mongodb-database-tools

   # Ubuntu/Debian
   sudo apt-get install mongodb-database-tools

   # CentOS/RHEL
   sudo yum install mongodb-database-tools
   ```

2. **SSH 访问权限**
   - 确保已配置到生产服务器的SSH密钥
   - 测试SSH连接：`ssh root@60.205.124.67`

3. **本地 MongoDB 服务**
   - 确保本地MongoDB服务正在运行
   - 默认端口：27017

### 网络要求

- 能够SSH连接到生产服务器 (60.205.124.67)
- 生产服务器能够访问其本地MongoDB服务

## 📁 文件结构

```
sdszk-redesign/
├── scripts/
│   ├── quick-sync.sh          # 快速同步脚本
│   ├── sync-database.sh       # 完整同步工具
│   └── mongodb-tunnel.sh      # SSH隧道脚本
├── database-backups/          # 备份文件存储目录
│   ├── local-backup-*.tar.gz  # 本地数据备份
│   └── production-backup-*.tar.gz # 生产环境备份
└── 数据库同步说明.md          # 本文档
```

## 🔧 详细使用说明

### 快速同步流程

1. **检查依赖** - 验证所需工具是否安装
2. **测试连接** - 验证SSH连接到生产服务器
3. **用户确认** - 显示将要执行的操作，等待确认
4. **备份本地** - 自动备份当前本地数据
5. **导出生产数据** - 从生产环境导出数据库
6. **下载数据** - 将数据下载到本地
7. **清空本地库** - 删除本地数据库内容
8. **恢复数据** - 将生产数据恢复到本地
9. **清除缓存** - 清空Redis缓存
10. **清理临时文件** - 删除同步过程中的临时文件

### 备份策略

- **自动备份**：每次同步前自动备份本地数据
- **命名规则**：`{type}-backup-{timestamp}.tar.gz`
- **存储位置**：`database-backups/` 目录
- **保留策略**：建议保留最近5-10个备份文件

### 安全考虑

1. **数据备份**：同步前自动备份本地数据
2. **用户确认**：危险操作需要用户明确确认
3. **SSH密钥**：使用SSH密钥而非密码认证
4. **临时文件**：自动清理同步过程中的临时文件

## 🎯 常见使用场景

### 场景1：开发环境数据过时
```bash
npm run db:sync
```

### 场景2：需要查看生产环境数据
```bash
npm run db:tunnel
# 然后使用 MongoDB Compass 连接 localhost:27018
```

### 场景3：备份管理
```bash
npm run db:sync-full
# 选择选项 6 查看备份列表
# 选择选项 7 清理旧备份
```

### 场景4：恢复到特定备份
```bash
npm run db:sync-full
# 选择选项 4 恢复本地数据
```

## ⚠️ 注意事项

1. **数据替换**：同步操作会完全替换本地数据库内容
2. **服务重启**：同步后建议重启开发服务器以清除缓存
3. **备份保留**：定期清理旧备份文件以节省磁盘空间
4. **网络稳定**：确保网络连接稳定，大数据传输可能需要较长时间
5. **权限检查**：确保对本地MongoDB数据库有读写权限

## 🚨 故障排除

### SSH连接失败
```bash
# 测试SSH连接
ssh root@60.205.124.67

# 检查SSH密钥
ssh-add -l

# 生成新的SSH密钥（如果需要）
ssh-keygen -t rsa -b 4096 -C "your-email@example.com"
```

### MongoDB工具未安装
```bash
# macOS
brew install mongodb/brew/mongodb-database-tools

# 验证安装
mongodump --version
mongorestore --version
```

### 本地MongoDB连接失败
```bash
# 检查MongoDB服务状态
brew services list | grep mongodb

# 启动MongoDB服务
brew services start mongodb-community

# 测试连接
mongosh sdszk
```

### 磁盘空间不足
```bash
# 检查可用空间
df -h

# 清理旧备份
npm run db:sync-full
# 选择选项 7
```

## 📞 技术支持

如果遇到问题，请检查：

1. **日志输出**：脚本会提供详细的执行日志
2. **网络连接**：确保能够访问生产服务器
3. **权限设置**：确保有足够的文件系统权限
4. **服务状态**：确保MongoDB服务正常运行

---

**最后更新**：2025-08-29
**维护者**：开发团队
