# 用户管理系统问题诊断清单

生成时间: 2025-09-13
完成时间: 2025-09-13
状态: ✅ 已修复

## 1. User 模型问题 (`server/models/User.js`)

### 🚫 重复的 pre save 钩子

- **位置**: 第130-137行 和 第352-356行
- **问题**: 两个钩子都在处理 `active` 和 `status` 字段同步，会导致冲突和不一致
- **影响**: 用户状态更新可能不生效或产生意外结果

### 🚫 权限结构不一致

- **位置**: 权限定义（第52-89行）和权限设置（第252-348行）
- **问题**:
  - Schema定义中没有 `system` 权限模块，但在角色权限设置中使用了
  - 某些权限字段结构不匹配（如 `system.setting` vs `system.manage`）

### ⚠️ 密码哈希处理

- **位置**: 第144-157行
- **状态**: 目前看起来正确，但需要验证是否与其他钩子冲突

### ✅ 索引定义

- **状态**: 看起来正确，包括稀疏索引和复合索引

## 2. UserController 问题 (`server/controllers/userController.js`)

### 🚫 缺失的导入

- **问题**: 导入了一些可能不存在或路径错误的模块
- **需要验证**:
  - `createSendToken` 从 `authController.js`
  - `logError, logInfo` 从 `utils/logger.js`

### 🚫 缺失的函数实现

- **位置**: 路由中引用但可能未实现的函数
- **需要检查**:
  - `createUser`
  - `updateUserStatus`
  - `resetUserPassword`
  - `batchDeleteUsers`

### 🚫 响应格式不一致

- **问题**: 不同函数使用了不同的响应结构
- **影响**: 前端调用可能因格式不一致而出错

## 3. 路由配置问题 (`server/routes/users.js`)

### 🚫 路由冲突

- **问题**: 同一路径可能被多次定义或冲突
- **需要检查**: RESTful 路由的正确性

### 🚫 中间件配置

- **问题**: 权限控制中间件可能配置不当
- **影响**: 安全性和访问控制问题

## 4. 认证相关问题

### ⚠️ JWT 认证

- **需要验证**: Token 生成、验证和刷新逻辑
- **文件**: `server/controllers/authController.js`

### ⚠️ 权限检查

- **需要验证**: RBAC (基于角色的访问控制) 是否正确实现

## 修复优先级

1. **高优先级 (🚫)**:
   - 修复 User 模型的重复钩子
   - 统一权限结构定义
   - 实现缺失的控制器函数
   - 解决路由冲突

2. **中优先级 (⚠️)**:
   - 验证认证逻辑
   - 统一响应格式
   - 完善错误处理

3. **低优先级 (✅)**:
   - 优化性能
   - 添加文档注释
   - 代码重构优化

## 修复计划

1. 备份现有代码
2. 创建修复分支
3. 按优先级逐一修复问题
4. 在开发环境测试验证
5. 创建回滚方案
6. 提交修复

---

_此文档将在修复过程中持续更新_
