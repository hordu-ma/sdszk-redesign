# ç”¨æˆ·ç®¡ç†ç³»ç»Ÿä¿®å¤ - å›æ»šæ–¹æ¡ˆ

**æ–‡æ¡£åˆ›å»ºæ—¶é—´**: 2025-09-13
**ä¿®å¤åˆ†æ”¯**: `fix/user-management-system`
**åŸºå‡†åˆ†æ”¯**: `main`

## ğŸ¯ æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›ç”¨æˆ·ç®¡ç†ç³»ç»Ÿä¿®å¤çš„å®Œæ•´å›æ»šæ–¹æ¡ˆï¼Œç¡®ä¿åœ¨å‡ºç°é—®é¢˜æ—¶èƒ½å¤Ÿå¿«é€Ÿã€å®‰å…¨åœ°æ¢å¤åˆ°ç¨³å®šçŠ¶æ€ã€‚

## ğŸ“‹ ä¿®æ”¹æ–‡ä»¶æ¸…å•

### ä¸»è¦ä¿®å¤æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„                               | ä¿®æ”¹ç±»å‹ | å¤‡ä»½ä½ç½®                                       | è¯´æ˜                                 |
| -------------------------------------- | -------- | ---------------------------------------------- | ------------------------------------ |
| `server/models/User.js`                | é‡æ„     | `backups/models.backup/User.js`                | ä¿®å¤æƒé™ç»“æ„ã€ç§»é™¤é‡å¤é’©å­ã€æ·»åŠ æ–¹æ³• |
| `server/controllers/userController.js` | ä¿®å¤     | `backups/controllers.backup/userController.js` | ä¿®å¤å¯¼å…¥é”™è¯¯ã€å®ç°ç¼ºå¤±å‡½æ•°           |
| `server/routes/users.js`               | ä¼˜åŒ–     | `backups/routes.backup/users.js`               | æ·»åŠ æ³¨é‡Šã€ç¡®è®¤è·¯ç”±ç»“æ„               |

### æ–°å¢æ–‡æ¡£æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„                             | ç±»å‹     | è¯´æ˜         |
| ------------------------------------ | -------- | ------------ |
| `docs/archive/user-system-issues.md` | è¯Šæ–­æ–‡æ¡£ | é—®é¢˜åˆ†ææ¸…å• |
| `docs/archive/rollback-plan.md`      | å›æ»šæ–‡æ¡£ | æœ¬æ–‡æ¡£       |
| `backups/`                           | å¤‡ä»½ç›®å½• | åŸå§‹æ–‡ä»¶å¤‡ä»½ |

## ğŸ”„ å›æ»šç­–ç•¥

### ç­–ç•¥ A: Git å›æ»šï¼ˆæ¨èï¼‰

**é€‚ç”¨åœºæ™¯**: ä»£ç é—®é¢˜ï¼Œéœ€è¦å®Œå…¨å›æ»šåˆ°ä¿®å¤å‰çŠ¶æ€

```bash
# 1. æŸ¥çœ‹å½“å‰åˆ†æ”¯å’Œæäº¤çŠ¶æ€
git status
git log --oneline -10

# 2. åˆ‡æ¢åˆ°ä¸»åˆ†æ”¯
git checkout main

# 3. åˆ é™¤ä¿®å¤åˆ†æ”¯ï¼ˆå¦‚æœéœ€è¦é‡æ–°å¼€å§‹ï¼‰
git branch -D fix/user-management-system

# 4. å¼ºåˆ¶æ¨é€ï¼ˆå¦‚æœå·²æ¨é€åˆ°è¿œç¨‹ï¼‰
# æ³¨æ„ï¼šè¿™æ˜¯å±é™©æ“ä½œï¼Œç¡®ä¿å›¢é˜Ÿæ²Ÿé€š
git push origin main --force-with-lease

# 5. éªŒè¯å›æ»šçŠ¶æ€
git status
git log --oneline -5
```

### ç­–ç•¥ B: æ–‡ä»¶çº§å›æ»šï¼ˆç²¾ç¡®æ§åˆ¶ï¼‰

**é€‚ç”¨åœºæ™¯**: åªéœ€è¦å›æ»šç‰¹å®šæ–‡ä»¶ï¼Œä¿ç•™å…¶ä»–ä¿®æ”¹

```bash
# 1. ä»å¤‡ä»½æ¢å¤æ ¸å¿ƒæ–‡ä»¶
cp backups/models.backup/User.js server/models/User.js
cp backups/controllers.backup/userController.js server/controllers/userController.js
cp backups/routes.backup/users.js server/routes/users.js

# 2. åˆ é™¤æ–°å¢çš„æ–‡æ¡£ï¼ˆå¯é€‰ï¼‰
rm docs/archive/user-system-issues.md
rm docs/archive/rollback-plan.md
rm -rf backups/

# 3. æ£€æŸ¥è¯­æ³•
node -c server/models/User.js
node -c server/controllers/userController.js
node -c server/routes/users.js

# 4. æäº¤å›æ»š
git add -A
git commit -m "rollback: å›æ»šç”¨æˆ·ç®¡ç†ç³»ç»Ÿä¿®å¤

- æ¢å¤ User æ¨¡å‹åˆ°ä¿®å¤å‰çŠ¶æ€
- æ¢å¤ userController åˆ°ä¿®å¤å‰çŠ¶æ€
- æ¢å¤ users è·¯ç”±åˆ°ä¿®å¤å‰çŠ¶æ€
- ç§»é™¤ç›¸å…³æ–‡æ¡£å’Œå¤‡ä»½"
```

### ç­–ç•¥ C: æ¸è¿›å¼å›æ»šï¼ˆéƒ¨åˆ†å›æ»šï¼‰

**é€‚ç”¨åœºæ™¯**: åªå›æ»šæœ‰é—®é¢˜çš„éƒ¨åˆ†ï¼Œä¿ç•™æ­£ç¡®çš„ä¿®å¤

```bash
# é€‰æ‹©æ€§æ¢å¤æ–‡ä»¶
# ä¾‹å¦‚ï¼šåªå›æ»š User æ¨¡å‹
cp backups/models.backup/User.js server/models/User.js

# æµ‹è¯•ç‰¹å®šåŠŸèƒ½
npm test -- --grep "ç”¨æˆ·æ¨¡å‹"

# å¦‚æœæµ‹è¯•é€šè¿‡ï¼Œæäº¤éƒ¨åˆ†å›æ»š
git add server/models/User.js
git commit -m "partial rollback: å›æ»šUseræ¨¡å‹åˆ°ç¨³å®šç‰ˆæœ¬"
```

## ğŸ—„ï¸ æ•°æ®åº“å›æ»š

### ç”¨æˆ·æ•°æ®ä¿æŠ¤

**è­¦å‘Š**: ä»¥ä¸‹æ“ä½œå°†å½±å“æ•°æ®åº“æ•°æ®ï¼Œè¯·è°¨æ…æ“ä½œï¼

```bash
# 1. å¤‡ä»½å½“å‰æ•°æ®åº“
mongodump --db sdszk --out backup_$(date +%Y%m%d_%H%M%S)

# 2. æ£€æŸ¥ç”¨æˆ·æ•°æ®ç»“æ„å˜åŒ–
mongo sdszk --eval "db.users.findOne()"

# 3. å¦‚æœæƒé™ç»“æ„æœ‰é‡å¤§å˜åŒ–ï¼Œå¯èƒ½éœ€è¦æ•°æ®è¿ç§»
# ç¤ºä¾‹ï¼šç§»é™¤æ–°å¢çš„ system æƒé™å­—æ®µ
mongo sdszk --eval "
  db.users.updateMany(
    { 'permissions.system': { \$exists: true } },
    { \$unset: { 'permissions.system': '' } }
  )
"

# 4. éªŒè¯æ•°æ®è¿ç§»ç»“æœ
mongo sdszk --eval "
  db.users.findOne(
    { 'permissions.system': { \$exists: true } }
  )
"
```

## ğŸš¨ ç´§æ€¥å›æ»šç¨‹åº

**ç´§æ€¥æƒ…å†µ**: ç”Ÿäº§ç¯å¢ƒå‡ºç°ä¸¥é‡é—®é¢˜éœ€è¦ç«‹å³å›æ»š

```bash
#!/bin/bash
# ç´§æ€¥å›æ»šè„šæœ¬ (emergency-rollback.sh)

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

echo "âš ï¸  å¼€å§‹ç´§æ€¥å›æ»šç¨‹åº..."

# 1. åœæ­¢æœåŠ¡
./scripts/development/dev-stop.sh || true

# 2. åˆ‡æ¢åˆ°ç¨³å®šåˆ†æ”¯
git checkout main

# 3. å¼ºåˆ¶é‡ç½®åˆ°æœ€åå·²çŸ¥ç¨³å®šæäº¤
git reset --hard HEAD~1  # æ ¹æ®éœ€è¦è°ƒæ•´æ•°é‡

# 4. ä»å¤‡ä»½æ¢å¤å…³é”®æ–‡ä»¶
if [ -d "backups/" ]; then
    cp -r backups/models.backup/* server/models/
    cp -r backups/controllers.backup/* server/controllers/
    cp -r backups/routes.backup/* server/routes/
    echo "âœ… æ–‡ä»¶å·²ä»å¤‡ä»½æ¢å¤"
fi

# 5. é‡å¯æœåŠ¡
echo "ğŸ”„ é‡å¯æœåŠ¡..."
./scripts/development/dev-start.sh

echo "âœ… ç´§æ€¥å›æ»šå®Œæˆ"
```

## ğŸ“ è”ç³»å’Œå‡çº§

### å†…éƒ¨è”ç³»

- **å¼€å‘è´Ÿè´£äºº**: [ç»´æŠ¤å›¢é˜Ÿè”ç³»æ–¹å¼]
- **ç³»ç»Ÿç®¡ç†å‘˜**: [è¿ç»´å›¢é˜Ÿè”ç³»æ–¹å¼]

### å‡çº§è·¯å¾„

å¦‚æœå›æ»šåä»æœ‰é—®é¢˜ï¼š

1. **é—®é¢˜éš”ç¦»**: ç¡®å®šæ˜¯ä»£ç é—®é¢˜è¿˜æ˜¯ç¯å¢ƒé—®é¢˜
2. **æ—¥å¿—åˆ†æ**: æŸ¥çœ‹ `backend.log` å’Œåº”ç”¨æ—¥å¿—
3. **æ•°æ®åº“æ£€æŸ¥**: éªŒè¯æ•°æ®å®Œæ•´æ€§
4. **æœåŠ¡é‡å¯**: å®Œå…¨é‡å¯æ‰€æœ‰ç›¸å…³æœåŠ¡
5. **å¯»æ±‚æ”¯æŒ**: è”ç³»æŠ€æœ¯è´Ÿè´£äºº

## âœ… å›æ»šéªŒè¯æ¸…å•

å®Œæˆå›æ»šåï¼Œè¯·æ‰§è¡Œä»¥ä¸‹æ£€æŸ¥ï¼š

- [ ] **æœåŠ¡çŠ¶æ€**: å‰ç«¯å’Œåç«¯æœåŠ¡æ­£å¸¸å¯åŠ¨
- [ ] **æ•°æ®åº“è¿æ¥**: MongoDB å’Œ Redis è¿æ¥æ­£å¸¸
- [ ] **åŸºç¡€åŠŸèƒ½**: ç”¨æˆ·ç™»å½•ã€æ³¨å†ŒåŠŸèƒ½æ­£å¸¸
- [ ] **æƒé™ç³»ç»Ÿ**: ç”¨æˆ·æƒé™æ£€æŸ¥æ­£å¸¸
- [ ] **APIå“åº”**: å…³é”®APIæ¥å£å“åº”æ­£å¸¸
- [ ] **æ—¥å¿—æ¸…ç†**: æ¸…é™¤é”™è¯¯æ—¥å¿—å’Œä¸´æ—¶æ–‡ä»¶
- [ ] **ç‰ˆæœ¬æ§åˆ¶**: Gitå†å²è®°å½•æ¸…æ™°ï¼Œåˆ†æ”¯çŠ¶æ€æ­£ç¡®

## ğŸ“ å›æ»šè®°å½•æ¨¡æ¿

```
å›æ»šè®°å½•
---------
æ—¶é—´: [æ‰§è¡Œæ—¶é—´]
æ‰§è¡Œäºº: [æ“ä½œäººå‘˜]
å›æ»šç­–ç•¥: [A/B/C]
å›æ»šèŒƒå›´: [å…·ä½“æ–‡ä»¶/åŠŸèƒ½]
å›æ»šåŸå› : [é—®é¢˜æè¿°]
éªŒè¯ç»“æœ: [æµ‹è¯•ç»“æœ]
å¤‡æ³¨: [å…¶ä»–é‡è¦ä¿¡æ¯]
```

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [ç”¨æˆ·ç³»ç»Ÿé—®é¢˜è¯Šæ–­](./user-system-issues.md)
- [å¼€å‘ç¯å¢ƒè®¾ç½®æŒ‡å—](../DEV_GUIDE.md)
- [APIæµ‹è¯•æŒ‡å—](../E2E_TESTING_GUIDE.md)

---

âš ï¸ **é‡è¦æé†’**:

- åœ¨ç”Ÿäº§ç¯å¢ƒæ‰§è¡Œå›æ»šå‰ï¼Œè¯·åŠ¡å¿…é€šçŸ¥ç›¸å…³å›¢é˜Ÿ
- æ‰€æœ‰å›æ»šæ“ä½œéƒ½åº”è¯¥æœ‰ç›¸åº”çš„å¤‡ä»½å’Œæµ‹è¯•
- è®°å½•æ‰€æœ‰å›æ»šæ“ä½œï¼Œä¾¿äºåç»­åˆ†æå’Œæ”¹è¿›
