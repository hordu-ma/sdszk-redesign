# å¼€å‘ç¯å¢ƒåˆ°ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æŒ‡å—

> æœ¬æŒ‡å—ç”¨äºå°†å¼€å‘ç¯å¢ƒçš„ä»£ç ä¿®æ”¹å’Œä¼˜åŒ–æ›´æ–°åˆ°é˜¿é‡Œäº‘ç”Ÿäº§ç¯å¢ƒ

## 1. éƒ¨ç½²å‰å‡†å¤‡

### 1.1 æ£€æŸ¥æœ¬åœ°ä»£ç çŠ¶æ€

```bash
# æ£€æŸ¥GitçŠ¶æ€ï¼Œç¡®ä¿æ‰€æœ‰ä¿®æ”¹å·²æäº¤
git status

# å¦‚æœ‰æœªæäº¤çš„ä¿®æ”¹ï¼Œå…ˆæäº¤
git add .
git commit -m "æè¿°ä½ çš„ä¿®æ”¹"

# æ¨é€åˆ°è¿œç¨‹ä»“åº“
git push origin main
```

### 1.2 ç¡®è®¤ç›®æ ‡ç¯å¢ƒ

- **ç”Ÿäº§æœåŠ¡å™¨**ï¼š60.205.124.67
- **å‰ç«¯è·¯å¾„**ï¼š/var/www/frontend
- **åç«¯è·¯å¾„**ï¼š/var/www/sdszk-backend
- **ç½‘ç«™åŸŸå**ï¼šhttps://horsduroot.com
- **æ•°æ®åº“åç§°**ï¼šsdszkï¼ˆå¼€å‘å’Œç”Ÿäº§ç¯å¢ƒç»Ÿä¸€ï¼‰

## 2. æ•°æ®åº“åŒæ­¥ï¼ˆå¦‚éœ€è¦ï¼‰

### 2.1 å»ºç«‹SSHéš§é“è¿æ¥ç”Ÿäº§æ•°æ®åº“

```bash
# å»ºç«‹SSHéš§é“
ssh -L 27018:localhost:27017 root@60.205.124.67 -f -N

# éªŒè¯éš§é“è¿æ¥
lsof -i :27018
```

### 2.2 å¤‡ä»½ç”Ÿäº§ç¯å¢ƒæ•°æ®

```bash
# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p database-backups/production-backup-$(date +%Y%m%d-%H%M%S)

# å¤‡ä»½å…³é”®é›†åˆ
mongoexport --uri="mongodb://localhost:27018/sdszk" --collection=resources --out="database-backups/production-backup-$(date +%Y%m%d-%H%M%S)/resources.json"
mongoexport --uri="mongodb://localhost:27018/sdszk" --collection=news --out="database-backups/production-backup-$(date +%Y%m%d-%H%M%S)/news.json"
mongoexport --uri="mongodb://localhost:27018/sdszk" --collection=newscategories --out="database-backups/production-backup-$(date +%Y%m%d-%H%M%S)/newscategories.json"
mongoexport --uri="mongodb://localhost:27018/sdszk" --collection=resourcecategories --out="database-backups/production-backup-$(date +%Y%m%d-%H%M%S)/resourcecategories.json"
```

### 2.3 åŒæ­¥æœ¬åœ°æ•°æ®åˆ°ç”Ÿäº§ç¯å¢ƒ

```bash
# å¯¼å‡ºæœ¬åœ°æ•°æ®
mkdir -p database-backups/local-export-$(date +%Y%m%d-%H%M%S)
mongoexport --uri="mongodb://localhost:27017/sdszk" --collection=resources --out="database-backups/local-export-$(date +%Y%m%d-%H%M%S)/resources.json"

# å¯¼å…¥åˆ°ç”Ÿäº§ç¯å¢ƒï¼ˆupsertæ¨¡å¼ï¼‰
mongoimport --uri="mongodb://localhost:27018/sdszk" --collection=resources --file="database-backups/local-export-$(date +%Y%m%d-%H%M%S)/resources.json" --upsert --upsertFields="_id"

# å…³é—­SSHéš§é“
pkill -f "ssh -L 27018:localhost:27017"
```

### 2.4 éªŒè¯æ•°æ®åº“URLé…ç½®

å¦‚æœåŒæ­¥äº†åŒ…å«localhost URLçš„æ•°æ®ï¼Œéœ€è¦æ›´æ–°ä¸ºç”Ÿäº§åŸŸåï¼š

```bash
# å»ºç«‹SSHéš§é“
ssh -L 27018:localhost:27017 root@60.205.124.67 -f -N

# æ›´æ–°ç¼©ç•¥å›¾URL
mongosh "mongodb://localhost:27018/sdszk" --eval "
db.resources.updateMany(
  { thumbnail: { \$regex: '^http://localhost:3000' } },
  [{ \$set: { thumbnail: { \$replaceAll: { input: '\$thumbnail', find: 'http://localhost:3000', replacement: 'https://horsduroot.com' } } } }]
);"

# æ›´æ–°æ–‡ä»¶URL
mongosh "mongodb://localhost:27018/sdszk" --eval "
db.resources.updateMany(
  { fileUrl: { \$regex: 'localhost:3000' } },
  [{ \$set: { fileUrl: { \$replaceAll: { input: '\$fileUrl', find: 'http://localhost:3000', replacement: 'https://horsduroot.com' } } } }]
);"

# å…³é—­SSHéš§é“
pkill -f "ssh -L 27018:localhost:27017"
```

## 3. æ–‡ä»¶åŒæ­¥ï¼ˆå¦‚éœ€è¦ï¼‰

### 3.1 åŒæ­¥ä¸Šä¼ æ–‡ä»¶

```bash
# åŒæ­¥å›¾ç‰‡æ–‡ä»¶
rsync -avz --progress server/uploads/images/ root@60.205.124.67:/var/www/sdszk-backend/uploads/images/

# åŒæ­¥è§†é¢‘æ–‡ä»¶
rsync -avz --progress server/uploads/videos/ root@60.205.124.67:/var/www/sdszk-backend/uploads/videos/

# åŒæ­¥æ–‡æ¡£æ–‡ä»¶
rsync -avz --progress server/uploads/documents/ root@60.205.124.67:/var/www/sdszk-backend/uploads/documents/
```

### 3.2 éªŒè¯æ–‡ä»¶è®¿é—®

```bash
# æµ‹è¯•å›¾ç‰‡è®¿é—®
curl -I https://horsduroot.com/uploads/images/sample.png

# æµ‹è¯•æ–‡ä»¶æœåŠ¡
ssh root@60.205.124.67 "ls -la /var/www/sdszk-backend/uploads/"
```

## 4. åç«¯éƒ¨ç½²

### 4.1 æ‰§è¡Œåç«¯éƒ¨ç½²è„šæœ¬

```bash
# è¿è¡Œåç«¯éƒ¨ç½²è„šæœ¬
chmod +x scripts/deploy-backend.sh
./scripts/deploy-backend.sh
```

### 4.2 éªŒè¯åç«¯æœåŠ¡

```bash
# æµ‹è¯•APIå¥åº·æ£€æŸ¥
curl https://horsduroot.com/api/health

# æµ‹è¯•ç™»å½•æ¥å£
curl -X POST \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}' \
  https://horsduroot.com/api/auth/login

# æµ‹è¯•ä¸Šä¼ APIè·¯å¾„
curl -s https://horsduroot.com/api/uploads/resource | grep -v "404" && echo "âœ… ä¸Šä¼ è·¯å¾„æ­£ç¡®" || echo "âŒ ä¸Šä¼ è·¯å¾„éœ€è¦æ£€æŸ¥"
```

## 5. å‰ç«¯éƒ¨ç½²

### 5.1 æ‰§è¡Œå‰ç«¯éƒ¨ç½²è„šæœ¬

```bash
# è¿è¡Œå‰ç«¯éƒ¨ç½²è„šæœ¬ï¼ˆä½¿ç”¨é˜¿é‡Œäº‘ç”Ÿäº§ç¯å¢ƒé…ç½®ï¼‰
chmod +x scripts/deploy.sh
./scripts/deploy.sh
```

### 5.2 éªŒè¯å‰ç«¯æœåŠ¡

```bash
# æµ‹è¯•ç½‘ç«™è®¿é—®
curl -f -s --max-time 10 "https://horsduroot.com"

# æµ‹è¯•APIæ¥å£
curl -f -s --max-time 10 "https://horsduroot.com/api/news?limit=5"
```

## 6. éƒ¨ç½²éªŒè¯

### 6.1 å®Œæ•´éªŒè¯æ¸…å•

```bash
# 1. æ£€æŸ¥ç½‘ç«™ä¸»é¡µè®¿é—®
curl -f -s --max-time 10 "https://horsduroot.com" > /dev/null && echo "âœ… ç½‘ç«™è®¿é—®æ­£å¸¸" || echo "âŒ ç½‘ç«™è®¿é—®å¤±è´¥"

# 2. æ£€æŸ¥APIå¥åº·çŠ¶æ€
curl -s "https://horsduroot.com/api/health" | grep '"status":"ok"' > /dev/null && echo "âœ… APIå¥åº·æ£€æŸ¥é€šè¿‡" || echo "âŒ APIå¥åº·æ£€æŸ¥å¤±è´¥"

# 3. æµ‹è¯•ç™»å½•åŠŸèƒ½
curl -X POST -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}' \
  https://horsduroot.com/api/auth/login | grep '"status":"success"' > /dev/null && echo "âœ… ç™»å½•åŠŸèƒ½æ­£å¸¸" || echo "âŒ ç™»å½•åŠŸèƒ½å¼‚å¸¸"

# 4. æµ‹è¯•æ–°é—»API
curl -s "https://horsduroot.com/api/news?limit=5" | grep '"success":true' > /dev/null && echo "âœ… æ–°é—»APIæ­£å¸¸" || echo "âŒ æ–°é—»APIå¼‚å¸¸"

# 5. æµ‹è¯•èµ„æºAPI
curl -s "https://horsduroot.com/api/resources?limit=5" | grep '"success":true' > /dev/null && echo "âœ… èµ„æºAPIæ­£å¸¸" || echo "âŒ èµ„æºAPIå¼‚å¸¸"

# 6. æµ‹è¯•æ–‡ä»¶ä¸Šä¼ è·¯å¾„
curl -s -o /dev/null -w "%{http_code}" "https://horsduroot.com/uploads/" | grep -E "(200|404)" > /dev/null && echo "âœ… æ–‡ä»¶æœåŠ¡è·¯å¾„é…ç½®æ­£ç¡®" || echo "âŒ æ–‡ä»¶æœåŠ¡è·¯å¾„éœ€è¦æ£€æŸ¥"
```

### 6.2 æµè§ˆå™¨éªŒè¯

è®¿é—®ä»¥ä¸‹é¡µé¢ç¡®è®¤åŠŸèƒ½æ­£å¸¸ï¼š

- **ä¸»é¡µ**ï¼šhttps://horsduroot.com
- **æ–°é—»é¡µé¢**ï¼šhttps://horsduroot.com/news
- **èµ„æºé¡µé¢**ï¼šhttps://horsduroot.com/resources
- **ç®¡ç†åå°**ï¼šhttps://horsduroot.com/admin

### 6.3 åŠŸèƒ½éªŒè¯é‡ç‚¹

ç‰¹åˆ«æ£€æŸ¥ä»¥ä¸‹åŠŸèƒ½ï¼š

- âœ… èµ„æºç¼©ç•¥å›¾æ­£å¸¸æ˜¾ç¤º
- âœ… æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½æ­£å¸¸
- âœ… å›¾ç‰‡/è§†é¢‘/æ–‡æ¡£ä¸‹è½½æ­£å¸¸
- âœ… å†…å®¹ç®¡ç†åŠŸèƒ½æ­£å¸¸
- âœ… æ•°æ®åº“è¿æ¥ç¨³å®š

## 7. å¸¸è§é—®é¢˜å¿«é€Ÿæ’æŸ¥

### 7.1 å‰ç«¯é—®é¢˜

```bash
# æ£€æŸ¥nginxçŠ¶æ€
ssh root@60.205.124.67 "systemctl status nginx"

# é‡å¯nginxæœåŠ¡
ssh root@60.205.124.67 "systemctl reload nginx"

# æ£€æŸ¥å‰ç«¯æ–‡ä»¶
ssh root@60.205.124.67 "ls -la /var/www/frontend"
```

### 7.2 åç«¯é—®é¢˜

```bash
# æ£€æŸ¥PM2è¿›ç¨‹çŠ¶æ€
ssh root@60.205.124.67 "pm2 status"

# æŸ¥çœ‹åç«¯æ—¥å¿—
ssh root@60.205.124.67 "pm2 logs sdszk-backend --lines 50"

# é‡å¯åç«¯æœåŠ¡
ssh root@60.205.124.67 "pm2 restart sdszk-backend"
```

### 7.3 æ•°æ®åº“è¿æ¥é—®é¢˜

```bash
# æµ‹è¯•MongoDBè¿æ¥
ssh root@60.205.124.67 "cd /var/www/sdszk-backend && node -e \"
const mongoose = require('mongoose');
mongoose.connect(process.env.MONGODB_URI)
  .then(() => console.log('âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ'))
  .catch(err => console.log('âŒ æ•°æ®åº“è¿æ¥å¤±è´¥:', err.message));
\""

# æ£€æŸ¥æ•°æ®åº“åç§°ç»Ÿä¸€
ssh root@60.205.124.67 "cd /var/www/sdszk-backend && node -e \"
console.log('æ•°æ®åº“URI:', process.env.MONGODB_URI);
\""
```

### 7.4 æ–‡ä»¶ä¸Šä¼ é—®é¢˜

```bash
# æ£€æŸ¥uploadsç›®å½•æƒé™
ssh root@60.205.124.67 "ls -la /var/www/sdszk-backend/uploads/"

# æ£€æŸ¥nginx uploadsè·¯å¾„é…ç½®
ssh root@60.205.124.67 "nginx -t && grep -A 5 'location /uploads' /etc/nginx/sites-enabled/sdszk"

# æµ‹è¯•æ–‡ä»¶æœåŠ¡
ssh root@60.205.124.67 "curl -I http://localhost:3000/uploads/"
```

### 7.5 APIè·¯å¾„é—®é¢˜

```bash
# æ£€æŸ¥APIè·¯ç”±é…ç½®
ssh root@60.205.124.67 "cd /var/www/sdszk-backend && grep -n 'uploads' app.js"

# æµ‹è¯•APIç«¯ç‚¹
curl -s https://horsduroot.com/api/uploads/ | head -5
```

## 8. éƒ¨ç½²å®Œæˆç¡®è®¤

éƒ¨ç½²æˆåŠŸçš„æ ‡å¿—ï¼š

- âœ… å‰ç«¯é¡µé¢æ­£å¸¸è®¿é—®
- âœ… APIå¥åº·æ£€æŸ¥é€šè¿‡
- âœ… ç™»å½•åŠŸèƒ½æ­£å¸¸
- âœ… æ•°æ®æ¥å£å“åº”æ­£å¸¸
- âœ… ç®¡ç†åå°å¯æ­£å¸¸ä½¿ç”¨
- âœ… æ–‡ä»¶ä¸Šä¼ å’Œæ˜¾ç¤ºæ­£å¸¸
- âœ… èµ„æºç¼©ç•¥å›¾æ­£å¸¸æ˜¾ç¤º
- âœ… æ•°æ®åº“è¿æ¥ç¨³å®š

---

## ğŸ“ éƒ¨ç½²è®°å½•æ¨¡æ¿

```
éƒ¨ç½²æ—¶é—´ï¼š${DATE}
éƒ¨ç½²å†…å®¹ï¼š${FEATURES}
æ•°æ®åº“åŒæ­¥ï¼šâœ…/âŒ/è·³è¿‡
æ–‡ä»¶åŒæ­¥ï¼šâœ…/âŒ/è·³è¿‡
å‰ç«¯çŠ¶æ€ï¼šâœ…/âŒ
åç«¯çŠ¶æ€ï¼šâœ…/âŒ
éªŒè¯ç»“æœï¼šâœ…/âŒ
ç‰¹æ®Šè¯´æ˜ï¼š${NOTES}
```

## ğŸ”— ç›¸å…³é“¾æ¥

- **ç”Ÿäº§ç½‘ç«™**ï¼šhttps://horsduroot.com
- **éƒ¨ç½²è„šæœ¬ä½ç½®**ï¼š`scripts/deploy.sh`ã€`scripts/deploy-backend.sh`
- **æœåŠ¡å™¨**ï¼š60.205.124.67
- **MongoDBè¿æ¥æŒ‡å—**ï¼š`dev-docs/MongoDBè¿œç¨‹è¿æ¥æ“ä½œæŒ‡å—.md`

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **æ•°æ®åº“åŒæ­¥**ï¼šè¯¦è§ `dev-docs/MongoDBè¿œç¨‹è¿æ¥æ“ä½œæŒ‡å—.md`
- **APIé—®é¢˜æ’æŸ¥**ï¼šæ£€æŸ¥ `src/api/modules/` ä¸‹çš„ç›¸å…³æ¨¡å—
- **ä¸Šä¼ æ–‡ä»¶é…ç½®**ï¼šæ£€æŸ¥ `server/app.js` ä¸­çš„é™æ€æ–‡ä»¶æœåŠ¡é…ç½®
