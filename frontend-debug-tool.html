<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å‰ç«¯çŠ¶æ€è°ƒè¯•å·¥å…·</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 8px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .test-section {
        margin-bottom: 24px;
        padding: 16px;
        border: 1px solid #e8e8e8;
        border-radius: 6px;
      }
      .test-section h3 {
        margin: 0 0 12px 0;
        color: #333;
      }
      .status {
        padding: 4px 8px;
        border-radius: 4px;
        font-weight: 500;
        margin-right: 8px;
      }
      .success {
        background: #f6ffed;
        color: #52c41a;
        border: 1px solid #b7eb8f;
      }
      .error {
        background: #fff2f0;
        color: #ff4d4f;
        border: 1px solid #ffccc7;
      }
      .warning {
        background: #fffbe6;
        color: #faad14;
        border: 1px solid #ffe58f;
      }
      .info {
        background: #e6f7ff;
        color: #1890ff;
        border: 1px solid #91d5ff;
      }
      button {
        background: #1890ff;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 8px;
        margin-bottom: 8px;
      }
      button:hover {
        background: #40a9ff;
      }
      button:disabled {
        background: #d9d9d9;
        cursor: not-allowed;
      }
      .log-area {
        background: #f8f8f8;
        padding: 12px;
        border-radius: 4px;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 12px;
        line-height: 1.4;
        max-height: 200px;
        overflow-y: auto;
        white-space: pre-wrap;
        margin-top: 8px;
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }
      .result-item {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ”§ å‰ç«¯çŠ¶æ€è°ƒè¯•å·¥å…·</h1>
      <p>æ£€æŸ¥CMSæ–°é—»ç®¡ç†ç³»ç»Ÿçš„å‰ç«¯çŠ¶æ€å’Œé—®é¢˜</p>

      <div class="grid">
        <div class="test-section">
          <h3>ğŸ”‘ è®¤è¯çŠ¶æ€æ£€æŸ¥</h3>
          <button onclick="checkAuthStatus()">æ£€æŸ¥è®¤è¯çŠ¶æ€</button>
          <button onclick="clearAuthCache()">æ¸…é™¤è®¤è¯ç¼“å­˜</button>
          <div id="auth-results"></div>
        </div>

        <div class="test-section">
          <h3>ğŸŒ ç½‘ç»œè¯·æ±‚æµ‹è¯•</h3>
          <button onclick="testNetworkRequests()">æµ‹è¯•ç½‘ç»œè¯·æ±‚</button>
          <button onclick="testDirectAPI()">ç›´æ¥APIæµ‹è¯•</button>
          <div id="network-results"></div>
        </div>
      </div>

      <div class="test-section">
        <h3>ğŸ“¦ æµè§ˆå™¨å­˜å‚¨æ£€æŸ¥</h3>
        <button onclick="checkBrowserStorage()">æ£€æŸ¥å­˜å‚¨çŠ¶æ€</button>
        <button onclick="clearAllStorage()">æ¸…é™¤æ‰€æœ‰å­˜å‚¨</button>
        <div id="storage-results"></div>
      </div>

      <div class="test-section">
        <h3>ğŸ”— å‰ç«¯åº”ç”¨çŠ¶æ€</h3>
        <button onclick="checkFrontendApp()">æ£€æŸ¥åº”ç”¨çŠ¶æ€</button>
        <button onclick="navigateToNewsList()">è·³è½¬åˆ°æ–°é—»åˆ—è¡¨</button>
        <button onclick="forceRefresh()">å¼ºåˆ¶åˆ·æ–°</button>
        <div id="app-results"></div>
      </div>

      <div class="test-section">
        <h3>ğŸ“ å®æ—¶æ—¥å¿—</h3>
        <button onclick="clearLogs()">æ¸…é™¤æ—¥å¿—</button>
        <div id="logs" class="log-area"></div>
      </div>
    </div>

    <script>
      const BASE_URL = 'http://localhost:3000'
      const FRONTEND_URL = 'http://localhost:5173'

      function log(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString()
        const logArea = document.getElementById('logs')
        const prefix =
          type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸'
        logArea.textContent += `[${timestamp}] ${prefix} ${message}\n`
        logArea.scrollTop = logArea.scrollHeight
        console.log(`[${type.toUpperCase()}]`, message)
      }

      function showResult(containerId, status, message, details = '') {
        const container = document.getElementById(containerId)
        const statusClass =
          status === 'success'
            ? 'success'
            : status === 'error'
              ? 'error'
              : status === 'warning'
                ? 'warning'
                : 'info'
        container.innerHTML = `
                <div class="result-item">
                    <span class="status ${statusClass}">${status.toUpperCase()}</span>
                    <span>${message}</span>
                </div>
                ${details ? `<div class="log-area">${details}</div>` : ''}
            `
      }

      async function checkAuthStatus() {
        log('å¼€å§‹æ£€æŸ¥è®¤è¯çŠ¶æ€...')

        try {
          // æ£€æŸ¥localStorageä¸­çš„token
          const token = localStorage.getItem('token')
          const sessionToken = sessionStorage.getItem('token')

          if (!token && !sessionToken) {
            showResult('auth-results', 'error', 'æœªæ‰¾åˆ°è®¤è¯ä»¤ç‰Œ', 'è¯·å…ˆç™»å½•')
            log('æœªæ‰¾åˆ°è®¤è¯ä»¤ç‰Œ', 'error')
            return
          }

          const currentToken = token || sessionToken
          log(`æ‰¾åˆ°ä»¤ç‰Œ: ${currentToken.substring(0, 20)}...`)

          // éªŒè¯tokenæ˜¯å¦æœ‰æ•ˆ
          const response = await fetch(`${BASE_URL}/api/auth/me`, {
            headers: {
              Authorization: `Bearer ${currentToken}`,
              'Content-Type': 'application/json',
            },
          })

          if (response.ok) {
            const userData = await response.json()
            showResult('auth-results', 'success', 'è®¤è¯çŠ¶æ€æ­£å¸¸', JSON.stringify(userData, null, 2))
            log('è®¤è¯çŠ¶æ€æ­£å¸¸', 'success')
          } else {
            showResult(
              'auth-results',
              'error',
              `è®¤è¯å¤±è´¥: ${response.status}`,
              await response.text()
            )
            log(`è®¤è¯å¤±è´¥: ${response.status}`, 'error')
          }
        } catch (error) {
          showResult('auth-results', 'error', 'è®¤è¯æ£€æŸ¥å‡ºé”™', error.message)
          log(`è®¤è¯æ£€æŸ¥å‡ºé”™: ${error.message}`, 'error')
        }
      }

      async function testNetworkRequests() {
        log('å¼€å§‹æµ‹è¯•ç½‘ç»œè¯·æ±‚...')

        try {
          const token = localStorage.getItem('token') || sessionStorage.getItem('token')
          if (!token) {
            showResult('network-results', 'error', 'éœ€è¦å…ˆç™»å½•')
            return
          }

          // æµ‹è¯•æ–°é—»åˆ—è¡¨API
          const response = await fetch(`${BASE_URL}/api/admin/news?page=1&limit=5`, {
            headers: {
              Authorization: `Bearer ${token}`,
              'Content-Type': 'application/json',
            },
          })

          if (response.ok) {
            const data = await response.json()
            const newsCount = data.data?.data?.length || 0
            const total = data.data?.pagination?.total || 0
            showResult(
              'network-results',
              'success',
              `APIè¯·æ±‚æˆåŠŸ`,
              `è¿”å› ${newsCount} æ¡è®°å½•ï¼Œæ€»è®¡ ${total} æ¡`
            )
            log(`APIè¯·æ±‚æˆåŠŸ: ${newsCount}/${total} æ¡è®°å½•`, 'success')
          } else {
            showResult(
              'network-results',
              'error',
              `APIè¯·æ±‚å¤±è´¥: ${response.status}`,
              await response.text()
            )
            log(`APIè¯·æ±‚å¤±è´¥: ${response.status}`, 'error')
          }
        } catch (error) {
          showResult('network-results', 'error', 'ç½‘ç»œè¯·æ±‚å‡ºé”™', error.message)
          log(`ç½‘ç»œè¯·æ±‚å‡ºé”™: ${error.message}`, 'error')
        }
      }

      async function testDirectAPI() {
        log('å¼€å§‹ç›´æ¥APIæµ‹è¯•...')

        try {
          // å…ˆç™»å½•è·å–æ–°token
          const loginResponse = await fetch(`${BASE_URL}/api/auth/login`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              username: 'admin',
              password: 'admin123',
            }),
          })

          if (!loginResponse.ok) {
            throw new Error(`ç™»å½•å¤±è´¥: ${loginResponse.status}`)
          }

          const loginData = await loginResponse.json()
          const newToken = loginData.token
          log(`è·å¾—æ–°token: ${newToken.substring(0, 20)}...`)

          // æµ‹è¯•æ–°é—»åˆ—è¡¨
          const newsResponse = await fetch(`${BASE_URL}/api/admin/news?page=1&limit=5`, {
            headers: {
              Authorization: `Bearer ${newToken}`,
              'Content-Type': 'application/json',
            },
          })

          if (newsResponse.ok) {
            const newsData = await newsResponse.json()
            const newsCount = newsData.data?.data?.length || 0
            const total = newsData.data?.pagination?.total || 0

            // æ›´æ–°æœ¬åœ°token
            localStorage.setItem('token', newToken)

            showResult(
              'network-results',
              'success',
              `ç›´æ¥APIæµ‹è¯•æˆåŠŸ`,
              `è¿”å› ${newsCount} æ¡è®°å½•ï¼Œæ€»è®¡ ${total} æ¡\nå·²æ›´æ–°æœ¬åœ°token`
            )
            log(`ç›´æ¥APIæµ‹è¯•æˆåŠŸ: ${newsCount}/${total} æ¡è®°å½•`, 'success')
          } else {
            throw new Error(`æ–°é—»APIè¯·æ±‚å¤±è´¥: ${newsResponse.status}`)
          }
        } catch (error) {
          showResult('network-results', 'error', 'ç›´æ¥APIæµ‹è¯•å¤±è´¥', error.message)
          log(`ç›´æ¥APIæµ‹è¯•å¤±è´¥: ${error.message}`, 'error')
        }
      }

      function checkBrowserStorage() {
        log('æ£€æŸ¥æµè§ˆå™¨å­˜å‚¨...')

        try {
          const localStorage_data = {
            token: localStorage.getItem('token'),
            userInfo: localStorage.getItem('userInfo'),
            keys: Object.keys(localStorage),
          }

          const sessionStorage_data = {
            token: sessionStorage.getItem('token'),
            userInfo: sessionStorage.getItem('userInfo'),
            keys: Object.keys(sessionStorage),
          }

          const storageInfo = {
            localStorage: localStorage_data,
            sessionStorage: sessionStorage_data,
            cookies: document.cookie,
          }

          showResult(
            'storage-results',
            'info',
            'æµè§ˆå™¨å­˜å‚¨çŠ¶æ€',
            JSON.stringify(storageInfo, null, 2)
          )
          log('æµè§ˆå™¨å­˜å‚¨æ£€æŸ¥å®Œæˆ', 'success')
        } catch (error) {
          showResult('storage-results', 'error', 'å­˜å‚¨æ£€æŸ¥å¤±è´¥', error.message)
          log(`å­˜å‚¨æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error')
        }
      }

      function clearAllStorage() {
        log('æ¸…é™¤æ‰€æœ‰æµè§ˆå™¨å­˜å‚¨...')

        try {
          localStorage.clear()
          sessionStorage.clear()

          // æ¸…é™¤cookies (å°½å¯èƒ½)
          document.cookie.split(';').forEach(function (c) {
            document.cookie = c
              .replace(/^ +/, '')
              .replace(/=.*/, '=;expires=' + new Date().toUTCString() + ';path=/')
          })

          showResult('storage-results', 'success', 'å·²æ¸…é™¤æ‰€æœ‰å­˜å‚¨', 'è¯·é‡æ–°ç™»å½•')
          log('å­˜å‚¨æ¸…é™¤å®Œæˆ', 'success')
        } catch (error) {
          showResult('storage-results', 'error', 'å­˜å‚¨æ¸…é™¤å¤±è´¥', error.message)
          log(`å­˜å‚¨æ¸…é™¤å¤±è´¥: ${error.message}`, 'error')
        }
      }

      function checkFrontendApp() {
        log('æ£€æŸ¥å‰ç«¯åº”ç”¨çŠ¶æ€...')

        try {
          const currentUrl = window.location.href
          const isVueApp = window.Vue !== undefined
          const hasRouter = window.__VUE_ROUTER__ !== undefined

          const appInfo = {
            currentUrl,
            isVueApp,
            hasRouter,
            userAgent: navigator.userAgent,
            localTime: new Date().toLocaleString(),
          }

          showResult('app-results', 'info', 'å‰ç«¯åº”ç”¨çŠ¶æ€', JSON.stringify(appInfo, null, 2))
          log('å‰ç«¯åº”ç”¨æ£€æŸ¥å®Œæˆ', 'success')
        } catch (error) {
          showResult('app-results', 'error', 'åº”ç”¨æ£€æŸ¥å¤±è´¥', error.message)
          log(`åº”ç”¨æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error')
        }
      }

      function navigateToNewsList() {
        log('è·³è½¬åˆ°æ–°é—»åˆ—è¡¨é¡µé¢...')
        window.open(`${FRONTEND_URL}/admin/news/list`, '_blank')
      }

      function forceRefresh() {
        log('å¼ºåˆ¶åˆ·æ–°é¡µé¢...')
        window.location.reload(true)
      }

      function clearAuthCache() {
        log('æ¸…é™¤è®¤è¯ç¼“å­˜...')
        localStorage.removeItem('token')
        sessionStorage.removeItem('token')
        localStorage.removeItem('userInfo')
        sessionStorage.removeItem('userInfo')
        showResult('auth-results', 'success', 'è®¤è¯ç¼“å­˜å·²æ¸…é™¤', 'è¯·é‡æ–°ç™»å½•')
        log('è®¤è¯ç¼“å­˜æ¸…é™¤å®Œæˆ', 'success')
      }

      function clearLogs() {
        document.getElementById('logs').textContent = ''
      }

      // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
      window.onload = function () {
        log('è°ƒè¯•å·¥å…·å·²åŠ è½½ï¼Œç‚¹å‡»æŒ‰é’®å¼€å§‹æ£€æŸ¥')
      }
    </script>
  </body>
</html>
