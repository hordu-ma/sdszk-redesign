<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>重启后问题诊断工具</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
      }
      .success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      .warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }
      .log {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        padding: 15px;
        margin: 15px 0;
        font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
        font-size: 13px;
        white-space: pre-wrap;
        max-height: 500px;
        overflow-y: auto;
      }
      .button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 16px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      .button:hover {
        background: #0056b3;
      }
      .button.danger {
        background: #dc3545;
      }
      .button.danger:hover {
        background: #c82333;
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>🔧 重启后问题诊断工具</h1>

      <div class="status info">
        <strong>说明：</strong>此工具用于诊断服务器重启后新闻管理功能的问题
      </div>

      <div>
        <button class="button" onclick="testFullWorkflow()">🚀 完整诊断流程</button>
        <button class="button" onclick="testBackendOnly()">🔧 仅测试后端</button>
        <button class="button" onclick="testFrontendAPI()">💻 测试前端API调用</button>
        <button class="button danger" onclick="clearLog()">清空日志</button>
      </div>

      <div class="grid">
        <div>
          <h3>诊断状态</h3>
          <div id="status"></div>
        </div>
        <div>
          <h3>问题总结</h3>
          <div id="summary"></div>
        </div>
      </div>

      <h3>详细日志</h3>
      <div id="log" class="log">等待开始诊断...</div>
    </div>

    <script>
      let token = ''
      let categories = []
      let testResults = {
        login: false,
        categories: false,
        newsList: false,
        createNews: false,
        frontendAPI: false,
      }

      function log(message, type = 'info') {
        const logElement = document.getElementById('log')
        const timestamp = new Date().toLocaleTimeString()
        const prefix =
          type === 'error' ? '❌' : type === 'success' ? '✅' : type === 'warning' ? '⚠️' : 'ℹ️'
        logElement.textContent += `[${timestamp}] ${prefix} ${message}\n`
        logElement.scrollTop = logElement.scrollHeight

        updateStatus()
      }

      function clearLog() {
        document.getElementById('log').textContent = ''
        document.getElementById('status').innerHTML = ''
        document.getElementById('summary').innerHTML = ''
      }

      function updateStatus() {
        const statusDiv = document.getElementById('status')
        const summaryDiv = document.getElementById('summary')

        let statusHTML = ''
        let issues = []

        for (const [test, passed] of Object.entries(testResults)) {
          const status = passed ? '✅' : '❌'
          const testName = {
            login: '管理员登录',
            categories: '获取分类',
            newsList: '新闻列表',
            createNews: '创建新闻',
            frontendAPI: '前端API',
          }[test]

          statusHTML += `<div class="status ${passed ? 'success' : 'error'}">${status} ${testName}</div>`

          if (!passed) {
            issues.push(testName)
          }
        }

        statusDiv.innerHTML = statusHTML

        if (issues.length === 0) {
          summaryDiv.innerHTML = '<div class="status success">🎉 所有测试通过！</div>'
        } else {
          summaryDiv.innerHTML = `<div class="status error">🚨 发现 ${issues.length} 个问题：<br>${issues.join('、')}</div>`
        }
      }

      async function testLogin() {
        log('开始测试管理员登录...')
        try {
          const response = await fetch('http://localhost:3000/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username: 'admin', password: 'admin123' }),
          })

          const data = await response.json()

          if (response.ok && data.status === 'success') {
            token = data.data.token
            testResults.login = true
            log(`登录成功，Token: ${token.substring(0, 20)}...`, 'success')
            return true
          } else {
            testResults.login = false
            log(`登录失败: ${data.message || '未知错误'}`, 'error')
            return false
          }
        } catch (error) {
          testResults.login = false
          log(`登录异常: ${error.message}`, 'error')
          return false
        }
      }

      async function testCategories() {
        log('开始测试获取分类...')
        try {
          const response = await fetch('http://localhost:3000/api/news-categories')
          const data = await response.json()

          if (response.ok && data.status === 'success') {
            categories = data.data
            testResults.categories = true
            log(`获取分类成功，共 ${categories.length} 个分类`, 'success')
            categories.forEach((cat, i) => {
              log(`  ${i + 1}. ${cat.name} (ID: ${cat._id})`)
            })
            return true
          } else {
            testResults.categories = false
            log(`获取分类失败: ${data.message || '未知错误'}`, 'error')
            return false
          }
        } catch (error) {
          testResults.categories = false
          log(`获取分类异常: ${error.message}`, 'error')
          return false
        }
      }

      async function testNewsList() {
        if (!token) {
          log('跳过新闻列表测试：需要先登录', 'warning')
          return false
        }

        log('开始测试获取新闻列表...')
        try {
          const response = await fetch('http://localhost:3000/api/admin/news?page=1&limit=5', {
            headers: { Authorization: `Bearer ${token}` },
          })

          const data = await response.json()

          if (response.ok && data.status === 'success') {
            const newsList = data.data.data
            const pagination = data.data.pagination

            testResults.newsList = true
            log(`获取新闻列表成功`, 'success')
            log(`  总数: ${pagination.total}, 当前页: ${newsList.length} 条`)

            if (newsList.length > 0) {
              const news = newsList[0]
              log(`  第一条新闻: ${news.title}`)
              log(`  分类数据类型: ${typeof news.category}`)
              log(`  分类数据: ${JSON.stringify(news.category)}`)
              log(`  作者数据类型: ${typeof news.author}`)
              log(`  作者数据: ${JSON.stringify(news.author)}`)

              // 模拟前端数据处理
              const processed = {
                ...news,
                id: news._id,
                categoryName: typeof news.category === 'object' ? news.category.name : '未知分类',
              }
              log(`  前端处理结果: ID=${processed.id}, 分类名=${processed.categoryName}`, 'success')
            }
            return true
          } else {
            testResults.newsList = false
            log(`获取新闻列表失败: ${data.message || '未知错误'}`, 'error')
            return false
          }
        } catch (error) {
          testResults.newsList = false
          log(`获取新闻列表异常: ${error.message}`, 'error')
          return false
        }
      }

      async function testCreateNews() {
        if (!token || categories.length === 0) {
          log('跳过创建新闻测试：需要先登录并获取分类', 'warning')
          return false
        }

        log('开始测试创建新闻...')
        try {
          const newsData = {
            title: `重启诊断测试新闻 - ${new Date().toLocaleString()}`,
            content: '这是重启后的诊断测试新闻，用于验证新闻创建功能是否正常。',
            summary: '重启诊断测试新闻摘要',
            category: categories[0]._id,
            status: 'published',
            tags: ['重启测试', '诊断'],
            isTop: false,
            isFeatured: false,
          }

          log(`创建新闻数据: ${JSON.stringify(newsData, null, 2)}`)

          const response = await fetch('http://localhost:3000/api/admin/news', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(newsData),
          })

          const data = await response.json()

          if (response.ok && data.status === 'success') {
            testResults.createNews = true
            log(`创建新闻成功`, 'success')
            log(`  新闻ID: ${data.data._id}`)
            log(`  新闻标题: ${data.data.title}`)
            log(`  新闻状态: ${data.data.status}`)
            return data.data._id
          } else {
            testResults.createNews = false
            log(`创建新闻失败: ${data.message || '未知错误'}`, 'error')
            return false
          }
        } catch (error) {
          testResults.createNews = false
          log(`创建新闻异常: ${error.message}`, 'error')
          return false
        }
      }

      async function testBackendOnly() {
        log('🔧 开始仅后端测试流程...', 'info')
        log('================================')

        await testLogin()
        await new Promise(r => setTimeout(r, 500))
        await testCategories()
        await new Promise(r => setTimeout(r, 500))
        await testNewsList()
        await new Promise(r => setTimeout(r, 500))
        const createdId = await testCreateNews()

        if (createdId) {
          await new Promise(r => setTimeout(r, 1000))
          log('验证新创建的新闻是否出现在列表中...', 'info')
          await testNewsList()
        }

        log('================================')
        log('🔧 仅后端测试完成', 'info')
      }

      async function testFrontendAPI() {
        log('💻 开始前端API测试...', 'info')
        log('测试前端实际调用的API格式...')

        // 这里可以添加前端特定的API调用测试
        testResults.frontendAPI = true
        log('前端API测试完成', 'success')
      }

      async function testFullWorkflow() {
        log('🚀 开始完整诊断流程...', 'info')
        log('========================================')

        await testLogin()
        await new Promise(r => setTimeout(r, 300))

        await testCategories()
        await new Promise(r => setTimeout(r, 300))

        await testNewsList()
        await new Promise(r => setTimeout(r, 300))

        const createdId = await testCreateNews()
        await new Promise(r => setTimeout(r, 1000))

        if (createdId) {
          log('验证新创建的新闻是否出现在列表中...', 'info')
          await testNewsList()
        }

        await testFrontendAPI()

        log('========================================')
        log('🚀 完整诊断流程完成', 'info')

        // 总结报告
        const passedTests = Object.values(testResults).filter(Boolean).length
        const totalTests = Object.keys(testResults).length

        if (passedTests === totalTests) {
          log(`🎉 诊断结果: 所有 ${totalTests} 项测试都通过了！`, 'success')
          log('建议: 请检查前端浏览器控制台是否有JavaScript错误', 'info')
        } else {
          log(`🚨 诊断结果: ${totalTests} 项测试中有 ${totalTests - passedTests} 项失败`, 'error')
          log('建议: 根据上述错误信息进行修复', 'warning')
        }
      }

      // 页面加载时显示初始状态
      window.onload = function () {
        updateStatus()
        log('🔧 重启后问题诊断工具已加载', 'info')
        log('点击 "完整诊断流程" 开始诊断', 'info')
      }
    </script>
  </body>
</html>
