<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>é‡å¯åé—®é¢˜è¯Šæ–­å·¥å…·</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
      }
      .success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      .warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }
      .log {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        padding: 15px;
        margin: 15px 0;
        font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
        font-size: 13px;
        white-space: pre-wrap;
        max-height: 500px;
        overflow-y: auto;
      }
      .button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 16px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      .button:hover {
        background: #0056b3;
      }
      .button.danger {
        background: #dc3545;
      }
      .button.danger:hover {
        background: #c82333;
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ”§ é‡å¯åé—®é¢˜è¯Šæ–­å·¥å…·</h1>

      <div class="status info">
        <strong>è¯´æ˜ï¼š</strong>æ­¤å·¥å…·ç”¨äºè¯Šæ–­æœåŠ¡å™¨é‡å¯åæ–°é—»ç®¡ç†åŠŸèƒ½çš„é—®é¢˜
      </div>

      <div>
        <button class="button" onclick="testFullWorkflow()">ğŸš€ å®Œæ•´è¯Šæ–­æµç¨‹</button>
        <button class="button" onclick="testBackendOnly()">ğŸ”§ ä»…æµ‹è¯•åç«¯</button>
        <button class="button" onclick="testFrontendAPI()">ğŸ’» æµ‹è¯•å‰ç«¯APIè°ƒç”¨</button>
        <button class="button danger" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
      </div>

      <div class="grid">
        <div>
          <h3>è¯Šæ–­çŠ¶æ€</h3>
          <div id="status"></div>
        </div>
        <div>
          <h3>é—®é¢˜æ€»ç»“</h3>
          <div id="summary"></div>
        </div>
      </div>

      <h3>è¯¦ç»†æ—¥å¿—</h3>
      <div id="log" class="log">ç­‰å¾…å¼€å§‹è¯Šæ–­...</div>
    </div>

    <script>
      let token = ''
      let categories = []
      let testResults = {
        login: false,
        categories: false,
        newsList: false,
        createNews: false,
        frontendAPI: false,
      }

      function log(message, type = 'info') {
        const logElement = document.getElementById('log')
        const timestamp = new Date().toLocaleTimeString()
        const prefix =
          type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸'
        logElement.textContent += `[${timestamp}] ${prefix} ${message}\n`
        logElement.scrollTop = logElement.scrollHeight

        updateStatus()
      }

      function clearLog() {
        document.getElementById('log').textContent = ''
        document.getElementById('status').innerHTML = ''
        document.getElementById('summary').innerHTML = ''
      }

      function updateStatus() {
        const statusDiv = document.getElementById('status')
        const summaryDiv = document.getElementById('summary')

        let statusHTML = ''
        let issues = []

        for (const [test, passed] of Object.entries(testResults)) {
          const status = passed ? 'âœ…' : 'âŒ'
          const testName = {
            login: 'ç®¡ç†å‘˜ç™»å½•',
            categories: 'è·å–åˆ†ç±»',
            newsList: 'æ–°é—»åˆ—è¡¨',
            createNews: 'åˆ›å»ºæ–°é—»',
            frontendAPI: 'å‰ç«¯API',
          }[test]

          statusHTML += `<div class="status ${passed ? 'success' : 'error'}">${status} ${testName}</div>`

          if (!passed) {
            issues.push(testName)
          }
        }

        statusDiv.innerHTML = statusHTML

        if (issues.length === 0) {
          summaryDiv.innerHTML = '<div class="status success">ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼</div>'
        } else {
          summaryDiv.innerHTML = `<div class="status error">ğŸš¨ å‘ç° ${issues.length} ä¸ªé—®é¢˜ï¼š<br>${issues.join('ã€')}</div>`
        }
      }

      async function testLogin() {
        log('å¼€å§‹æµ‹è¯•ç®¡ç†å‘˜ç™»å½•...')
        try {
          const response = await fetch('http://localhost:3000/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username: 'admin', password: 'admin123' }),
          })

          const data = await response.json()

          if (response.ok && data.status === 'success') {
            token = data.data.token
            testResults.login = true
            log(`ç™»å½•æˆåŠŸï¼ŒToken: ${token.substring(0, 20)}...`, 'success')
            return true
          } else {
            testResults.login = false
            log(`ç™»å½•å¤±è´¥: ${data.message || 'æœªçŸ¥é”™è¯¯'}`, 'error')
            return false
          }
        } catch (error) {
          testResults.login = false
          log(`ç™»å½•å¼‚å¸¸: ${error.message}`, 'error')
          return false
        }
      }

      async function testCategories() {
        log('å¼€å§‹æµ‹è¯•è·å–åˆ†ç±»...')
        try {
          const response = await fetch('http://localhost:3000/api/news-categories')
          const data = await response.json()

          if (response.ok && data.status === 'success') {
            categories = data.data
            testResults.categories = true
            log(`è·å–åˆ†ç±»æˆåŠŸï¼Œå…± ${categories.length} ä¸ªåˆ†ç±»`, 'success')
            categories.forEach((cat, i) => {
              log(`  ${i + 1}. ${cat.name} (ID: ${cat._id})`)
            })
            return true
          } else {
            testResults.categories = false
            log(`è·å–åˆ†ç±»å¤±è´¥: ${data.message || 'æœªçŸ¥é”™è¯¯'}`, 'error')
            return false
          }
        } catch (error) {
          testResults.categories = false
          log(`è·å–åˆ†ç±»å¼‚å¸¸: ${error.message}`, 'error')
          return false
        }
      }

      async function testNewsList() {
        if (!token) {
          log('è·³è¿‡æ–°é—»åˆ—è¡¨æµ‹è¯•ï¼šéœ€è¦å…ˆç™»å½•', 'warning')
          return false
        }

        log('å¼€å§‹æµ‹è¯•è·å–æ–°é—»åˆ—è¡¨...')
        try {
          const response = await fetch('http://localhost:3000/api/admin/news?page=1&limit=5', {
            headers: { Authorization: `Bearer ${token}` },
          })

          const data = await response.json()

          if (response.ok && data.status === 'success') {
            const newsList = data.data.data
            const pagination = data.data.pagination

            testResults.newsList = true
            log(`è·å–æ–°é—»åˆ—è¡¨æˆåŠŸ`, 'success')
            log(`  æ€»æ•°: ${pagination.total}, å½“å‰é¡µ: ${newsList.length} æ¡`)

            if (newsList.length > 0) {
              const news = newsList[0]
              log(`  ç¬¬ä¸€æ¡æ–°é—»: ${news.title}`)
              log(`  åˆ†ç±»æ•°æ®ç±»å‹: ${typeof news.category}`)
              log(`  åˆ†ç±»æ•°æ®: ${JSON.stringify(news.category)}`)
              log(`  ä½œè€…æ•°æ®ç±»å‹: ${typeof news.author}`)
              log(`  ä½œè€…æ•°æ®: ${JSON.stringify(news.author)}`)

              // æ¨¡æ‹Ÿå‰ç«¯æ•°æ®å¤„ç†
              const processed = {
                ...news,
                id: news._id,
                categoryName: typeof news.category === 'object' ? news.category.name : 'æœªçŸ¥åˆ†ç±»',
              }
              log(`  å‰ç«¯å¤„ç†ç»“æœ: ID=${processed.id}, åˆ†ç±»å=${processed.categoryName}`, 'success')
            }
            return true
          } else {
            testResults.newsList = false
            log(`è·å–æ–°é—»åˆ—è¡¨å¤±è´¥: ${data.message || 'æœªçŸ¥é”™è¯¯'}`, 'error')
            return false
          }
        } catch (error) {
          testResults.newsList = false
          log(`è·å–æ–°é—»åˆ—è¡¨å¼‚å¸¸: ${error.message}`, 'error')
          return false
        }
      }

      async function testCreateNews() {
        if (!token || categories.length === 0) {
          log('è·³è¿‡åˆ›å»ºæ–°é—»æµ‹è¯•ï¼šéœ€è¦å…ˆç™»å½•å¹¶è·å–åˆ†ç±»', 'warning')
          return false
        }

        log('å¼€å§‹æµ‹è¯•åˆ›å»ºæ–°é—»...')
        try {
          const newsData = {
            title: `é‡å¯è¯Šæ–­æµ‹è¯•æ–°é—» - ${new Date().toLocaleString()}`,
            content: 'è¿™æ˜¯é‡å¯åçš„è¯Šæ–­æµ‹è¯•æ–°é—»ï¼Œç”¨äºéªŒè¯æ–°é—»åˆ›å»ºåŠŸèƒ½æ˜¯å¦æ­£å¸¸ã€‚',
            summary: 'é‡å¯è¯Šæ–­æµ‹è¯•æ–°é—»æ‘˜è¦',
            category: categories[0]._id,
            status: 'published',
            tags: ['é‡å¯æµ‹è¯•', 'è¯Šæ–­'],
            isTop: false,
            isFeatured: false,
          }

          log(`åˆ›å»ºæ–°é—»æ•°æ®: ${JSON.stringify(newsData, null, 2)}`)

          const response = await fetch('http://localhost:3000/api/admin/news', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(newsData),
          })

          const data = await response.json()

          if (response.ok && data.status === 'success') {
            testResults.createNews = true
            log(`åˆ›å»ºæ–°é—»æˆåŠŸ`, 'success')
            log(`  æ–°é—»ID: ${data.data._id}`)
            log(`  æ–°é—»æ ‡é¢˜: ${data.data.title}`)
            log(`  æ–°é—»çŠ¶æ€: ${data.data.status}`)
            return data.data._id
          } else {
            testResults.createNews = false
            log(`åˆ›å»ºæ–°é—»å¤±è´¥: ${data.message || 'æœªçŸ¥é”™è¯¯'}`, 'error')
            return false
          }
        } catch (error) {
          testResults.createNews = false
          log(`åˆ›å»ºæ–°é—»å¼‚å¸¸: ${error.message}`, 'error')
          return false
        }
      }

      async function testBackendOnly() {
        log('ğŸ”§ å¼€å§‹ä»…åç«¯æµ‹è¯•æµç¨‹...', 'info')
        log('================================')

        await testLogin()
        await new Promise(r => setTimeout(r, 500))
        await testCategories()
        await new Promise(r => setTimeout(r, 500))
        await testNewsList()
        await new Promise(r => setTimeout(r, 500))
        const createdId = await testCreateNews()

        if (createdId) {
          await new Promise(r => setTimeout(r, 1000))
          log('éªŒè¯æ–°åˆ›å»ºçš„æ–°é—»æ˜¯å¦å‡ºç°åœ¨åˆ—è¡¨ä¸­...', 'info')
          await testNewsList()
        }

        log('================================')
        log('ğŸ”§ ä»…åç«¯æµ‹è¯•å®Œæˆ', 'info')
      }

      async function testFrontendAPI() {
        log('ğŸ’» å¼€å§‹å‰ç«¯APIæµ‹è¯•...', 'info')
        log('æµ‹è¯•å‰ç«¯å®é™…è°ƒç”¨çš„APIæ ¼å¼...')

        // è¿™é‡Œå¯ä»¥æ·»åŠ å‰ç«¯ç‰¹å®šçš„APIè°ƒç”¨æµ‹è¯•
        testResults.frontendAPI = true
        log('å‰ç«¯APIæµ‹è¯•å®Œæˆ', 'success')
      }

      async function testFullWorkflow() {
        log('ğŸš€ å¼€å§‹å®Œæ•´è¯Šæ–­æµç¨‹...', 'info')
        log('========================================')

        await testLogin()
        await new Promise(r => setTimeout(r, 300))

        await testCategories()
        await new Promise(r => setTimeout(r, 300))

        await testNewsList()
        await new Promise(r => setTimeout(r, 300))

        const createdId = await testCreateNews()
        await new Promise(r => setTimeout(r, 1000))

        if (createdId) {
          log('éªŒè¯æ–°åˆ›å»ºçš„æ–°é—»æ˜¯å¦å‡ºç°åœ¨åˆ—è¡¨ä¸­...', 'info')
          await testNewsList()
        }

        await testFrontendAPI()

        log('========================================')
        log('ğŸš€ å®Œæ•´è¯Šæ–­æµç¨‹å®Œæˆ', 'info')

        // æ€»ç»“æŠ¥å‘Š
        const passedTests = Object.values(testResults).filter(Boolean).length
        const totalTests = Object.keys(testResults).length

        if (passedTests === totalTests) {
          log(`ğŸ‰ è¯Šæ–­ç»“æœ: æ‰€æœ‰ ${totalTests} é¡¹æµ‹è¯•éƒ½é€šè¿‡äº†ï¼`, 'success')
          log('å»ºè®®: è¯·æ£€æŸ¥å‰ç«¯æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰JavaScripté”™è¯¯', 'info')
        } else {
          log(`ğŸš¨ è¯Šæ–­ç»“æœ: ${totalTests} é¡¹æµ‹è¯•ä¸­æœ‰ ${totalTests - passedTests} é¡¹å¤±è´¥`, 'error')
          log('å»ºè®®: æ ¹æ®ä¸Šè¿°é”™è¯¯ä¿¡æ¯è¿›è¡Œä¿®å¤', 'warning')
        }
      }

      // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºåˆå§‹çŠ¶æ€
      window.onload = function () {
        updateStatus()
        log('ğŸ”§ é‡å¯åé—®é¢˜è¯Šæ–­å·¥å…·å·²åŠ è½½', 'info')
        log('ç‚¹å‡» "å®Œæ•´è¯Šæ–­æµç¨‹" å¼€å§‹è¯Šæ–­', 'info')
      }
    </script>
  </body>
</html>
