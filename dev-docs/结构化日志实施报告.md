# ç»“æ„åŒ–æ—¥å¿—å®æ–½æŠ¥å‘Š

## å®æ–½æ—¶é—´
2025-08-19 14:10

## æ¦‚è¿°

æ ¹æ® **Gemini v2 å»ºè®® 1.3**ï¼ŒæˆåŠŸå®æ–½äº†ç»“æ„åŒ–æ—¥å¿—ç³»ç»Ÿï¼Œæ›¿ä»£é¡¹ç›®ä¸­å¤§é‡çš„ `console.log` è°ƒç”¨ï¼Œæå‡äº†æ—¥å¿—çš„å¯è¯»æ€§ã€å¯åˆ†ææ€§å’Œç”Ÿäº§ç¯å¢ƒé€‚ç”¨æ€§ã€‚

## æŠ€æœ¯é€‰å‹

### é€‰æ‹© Pino ä½œä¸ºæ—¥å¿—åº“
- **æ€§èƒ½ä¼˜åŠ¿**ï¼šæ¯” Winston å¿« 5-10 å€
- **JSON æ ¼å¼**ï¼šä¾¿äºæ—¥å¿—èšåˆå·¥å…·ï¼ˆå¦‚ ELKã€Grafanaï¼‰è§£æ
- **è½»é‡çº§**ï¼šæœ€å°åŒ–è¿è¡Œæ—¶å¼€é”€
- **çµæ´»é…ç½®**ï¼šæ”¯æŒå¼€å‘/ç”Ÿäº§ç¯å¢ƒä¸åŒé…ç½®

### å®‰è£…çš„ä¾èµ–
```bash
npm install pino pino-pretty
```

## æ ¸å¿ƒå®ç°

### 1. æ—¥å¿—å·¥å…·æ¨¡å— (`utils/logger.js`)

#### ç‰¹æ€§æ¦‚è§ˆ
- **ç¯å¢ƒé€‚åº”æ€§**ï¼šå¼€å‘ç¯å¢ƒç¾åŒ–è¾“å‡ºï¼Œç”Ÿäº§ç¯å¢ƒ JSON æ ¼å¼
- **åˆ†æ¨¡å—æ—¥å¿—å™¨**ï¼šæŒ‰åŠŸèƒ½åŸŸåˆ›å»ºä¸“ç”¨æ—¥å¿—å™¨
- **ä¸°å¯Œçš„å·¥å…·å‡½æ•°**ï¼šæä¾›ä¾¿æ·çš„æ—¥å¿—è®°å½•æ–¹æ³•

#### ä¸»è¦ç»„ä»¶
```javascript
// ä¸“ç”¨æ—¥å¿—å™¨
export const dbLogger = createLogger('database');
export const authLogger = createLogger('auth');
export const apiLogger = createLogger('api');
export const sysLogger = createLogger('system');
export const errorLogger = createLogger('error');
export const perfLogger = createLogger('performance');
export const auditLogger = createLogger('audit');

// å·¥å…·å‡½æ•°
export const logHttpRequest = (req, res, duration) => { ... };
export const logDbOperation = (operation, collection, context, duration) => { ... };
export const logAuthEvent = (event, context) => { ... };
export const logError = (error, context) => { ... };
export const logPerformance = (metric, value, unit, context) => { ... };
```

#### é…ç½®ç‰¹ç‚¹
- **è‡ªåŠ¨ç¯å¢ƒæ£€æµ‹**ï¼š`NODE_ENV` é©±åŠ¨çš„é…ç½®åˆ‡æ¢
- **ç»“æ„åŒ–å…ƒæ•°æ®**ï¼šåŒ…å«æœåŠ¡åã€ç‰ˆæœ¬ã€PIDã€ä¸»æœºå
- **æ—¶é—´æˆ³æ ‡å‡†åŒ–**ï¼šISO 8601 æ ¼å¼
- **å…¼å®¹æ€§æ¥å£**ï¼šæä¾›ç±»ä¼¼ `console` çš„æ¥å£ä¾¿äºè¿ç§»

### 2. HTTP è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶ (`middleware/loggerMiddleware.js`)

#### åŠŸèƒ½æ¨¡å—
1. **åŸºç¡€è¯·æ±‚æ—¥å¿—**ï¼šè®°å½•æ‰€æœ‰ HTTP è¯·æ±‚çš„è¯¦ç»†ä¿¡æ¯
2. **é”™è¯¯è¯·æ±‚æ—¥å¿—**ï¼šä¸“é—¨è®°å½•äº§ç”Ÿé”™è¯¯çš„è¯·æ±‚
3. **æ…¢è¯·æ±‚ç›‘æ§**ï¼šè¯†åˆ«è¶…è¿‡é˜ˆå€¼çš„è¯·æ±‚ï¼ˆé»˜è®¤1ç§’ï¼‰
4. **API è®¿é—®ç»Ÿè®¡**ï¼šå®šæœŸæŠ¥å‘Šçƒ­é—¨ç«¯ç‚¹
5. **å®‰å…¨æ“ä½œå®¡è®¡**ï¼šè®°å½•æ•æ„Ÿè·¯å¾„çš„è®¿é—®

#### ä¸­é—´ä»¶ç‰¹æ€§
```javascript
export const requestLogger = (req, res, next) => {
  // è®°å½•è¯·æ±‚å¼€å§‹ã€ç»“æŸæ—¶é—´
  // åŒ…å«ç”¨æˆ·ä¿¡æ¯ã€IPã€UserAgent ç­‰
};

export const slowRequestLogger = (threshold = 1000) => {
  // ç›‘æ§æ…¢è¯·æ±‚ï¼Œè‡ªå®šä¹‰é˜ˆå€¼
};

export const apiStatsLogger = (() => {
  // 5åˆ†é’Ÿé—´éš”ç»Ÿè®¡æŠ¥å‘Š
  // è‡ªåŠ¨æ¸…ç†å†…å­˜ï¼Œé˜²æ­¢æ³„æ¼
});
```

## ä»£ç è¿ç§»æˆæœ

### 1. æ ¸å¿ƒåº”ç”¨æ–‡ä»¶ (`app.js`)

#### è¿ç§»å‰åå¯¹æ¯”
```javascript
// è¿ç§»å‰
console.log("âœ… MongoDBåˆå§‹è¿æ¥æˆåŠŸ");
console.error("âŒ MongoDBé‡è¿å¤±è´¥:", err.message);

// è¿ç§»å
dbLogger.info({ type: 'initial' }, "MongoDBåˆå§‹è¿æ¥æˆåŠŸ");
dbLogger.error({
  reconnectAttempt: reconnectAttempts,
  maxAttempts: MAX_RECONNECT_ATTEMPTS,
  error: err.message
}, `MongoDBé‡è¿å¤±è´¥ (ç¬¬${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS}æ¬¡)`);
```

#### æ–°å¢çš„ä¸­é—´ä»¶é›†æˆ
```javascript
// æ—¥å¿—ä¸­é—´ä»¶é…ç½®
app.use(requestLogger);              // è®°å½•æ‰€æœ‰HTTPè¯·æ±‚
app.use(slowRequestLogger(1000));    // è®°å½•è¶…è¿‡1ç§’çš„æ…¢è¯·æ±‚
app.use(securityLogger);             // è®°å½•å®‰å…¨æ•æ„Ÿæ“ä½œ
```

### 2. è®¤è¯æ§åˆ¶å™¨ (`authController.js`)

#### è¯¦ç»†çš„ç™»å½•æµç¨‹æ—¥å¿—
```javascript
// ç»“æ„åŒ–ç™»å½•äº‹ä»¶è®°å½•
logAuthEvent('login_success', {
  username,
  userId: user._id,
  role: user.role,
  ip: req.ip
});

// å¤±è´¥æƒ…å†µçš„ç»†åˆ†è®°å½•
logAuthEvent('login_failed', {
  reason: 'invalid_password',  // user_not_found, account_disabled
  username,
  userId: user._id,
  ip: req.ip
});
```

### 3. Redis é…ç½® (`config/redis.js`)

#### è¿æ¥çŠ¶æ€çš„ç»“æ„åŒ–ç›‘æ§
```javascript
// é‡è¿ç­–ç•¥ä¸­çš„æ—¥å¿—
redisConfig.socket.reconnectStrategy = (retries) => {
  sysLogger.info({ retries, delay }, `Redis: å°†åœ¨ ${delay}ms åè¿›è¡Œç¬¬ ${retries} æ¬¡é‡è¿`);
  return delay;
};

// äº‹ä»¶ç›‘å¬å™¨çš„ç»“æ„åŒ–è®°å½•
redisClient.on("error", (err) => {
  logError(err, { context: 'redis-connection' });
});
```

## æ—¥å¿—æ ¼å¼ç¤ºä¾‹

### å¼€å‘ç¯å¢ƒè¾“å‡º
```
[2025-08-19 06:16:32] INFO: MongoDBåˆå§‹è¿æ¥æˆåŠŸ
    service: "sdszk-server"
    version: "1.0.0"
    module: "database"
    type: "initial"

[2025-08-19 06:16:33] WARN: è¿™æ˜¯è®¤è¯æ—¥å¿—
    service: "sdszk-server"
    version: "1.0.0"
    module: "auth"
    userId: "123"
    action: "login_attempt"
```

### ç”Ÿäº§ç¯å¢ƒè¾“å‡º
```json
{
  "level": 30,
  "timestamp": "2025-08-19T06:16:32.123Z",
  "service": "sdszk-server",
  "version": "1.0.0",
  "module": "auth",
  "userId": "507f1f77bcf86cd799439011",
  "username": "admin",
  "ip": "192.168.1.100",
  "action": "login_success",
  "msg": "Authentication event: login_success"
}
```

## æ€§èƒ½å½±å“è¯„ä¼°

### 1. å†…å­˜ä½¿ç”¨
- **Pino ä¼˜åŠ¿**ï¼šå¼‚æ­¥å†™å…¥ï¼Œæœ€å°åŒ–é˜»å¡
- **ç»Ÿè®¡ä¸­é—´ä»¶**ï¼šå®šæœŸæ¸…ç†ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
- **é¢„æœŸå½±å“**ï¼š< 5% å†…å­˜å¢é•¿

### 2. CPU å¼€é”€
- **JSON åºåˆ—åŒ–**ï¼šæ¯”å­—ç¬¦ä¸²æ‹¼æ¥æ›´é«˜æ•ˆ
- **æ¡ä»¶æ—¥å¿—**ï¼šæ ¹æ®æ—¥å¿—çº§åˆ«è·³è¿‡è®¡ç®—
- **é¢„æœŸå½±å“**ï¼š< 2% CPU å¢é•¿

### 3. I/O æ€§èƒ½
- **å¼‚æ­¥å†™å…¥**ï¼šä¸é˜»å¡ä¸»çº¿ç¨‹
- **æ‰¹é‡å†™å…¥**ï¼šå‡å°‘ç³»ç»Ÿè°ƒç”¨
- **æ—¥å¿—è½®è½¬**ï¼šé˜²æ­¢ç£ç›˜ç©ºé—´é—®é¢˜

## å®æ–½æ•ˆç›Š

### 1. å¼€å‘ä½“éªŒæå‡
- âœ… **ä¸€è‡´çš„æ—¥å¿—æ ¼å¼**ï¼šæ‰€æœ‰æ¨¡å—ç»Ÿä¸€æ ‡å‡†
- âœ… **ä¸°å¯Œçš„ä¸Šä¸‹æ–‡ä¿¡æ¯**ï¼šä¾¿äºé—®é¢˜å®šä½
- âœ… **ç¾åŒ–çš„å¼€å‘è¾“å‡º**ï¼šæé«˜å¯è¯»æ€§

### 2. è¿ç»´ç›‘æ§æ”¹å–„
- âœ… **ç»“æ„åŒ–æ•°æ®**ï¼šä¾¿äºæ—¥å¿—èšåˆåˆ†æ
- âœ… **åˆ†çº§æ—¥å¿—**ï¼šç”Ÿäº§ç¯å¢ƒå¯æ§åˆ¶è¯¦ç»†ç¨‹åº¦
- âœ… **å®¡è®¡è¿½è¸ª**ï¼šå®Œæ•´çš„ç”¨æˆ·è¡Œä¸ºè®°å½•

### 3. é—®é¢˜è¯Šæ–­åŠ é€Ÿ
- âœ… **é”™è¯¯ä¸Šä¸‹æ–‡**ï¼šåŒ…å«å®Œæ•´çš„è¯·æ±‚ä¿¡æ¯
- âœ… **æ€§èƒ½æŒ‡æ ‡**ï¼šè‡ªåŠ¨è®°å½•å“åº”æ—¶é—´
- âœ… **å®‰å…¨äº‹ä»¶**ï¼šæ•æ„Ÿæ“ä½œè‡ªåŠ¨æ ‡è®°

## åç»­ä¼˜åŒ–å»ºè®®

### 1. æ—¥å¿—èšåˆ
```bash
# é›†æˆ ELK Stack æˆ–ç±»ä¼¼å·¥å…·
# Elasticsearch + Logstash + Kibana
# æˆ– Grafana + Loki + Promtail
```

### 2. å‘Šè­¦æœºåˆ¶
```javascript
// åŸºäºæ—¥å¿—çº§åˆ«çš„è‡ªåŠ¨å‘Šè­¦
// é”™è¯¯ç‡è¶…è¿‡é˜ˆå€¼æ—¶é€šçŸ¥
// æ…¢è¯·æ±‚é¢‘ç‡ç›‘æ§
```

### 3. æ—¥å¿—è½®è½¬
```javascript
// æŒ‰å¤§å°æˆ–æ—¶é—´åˆ†å‰²æ—¥å¿—æ–‡ä»¶
// è‡ªåŠ¨å‹ç¼©å’Œæ¸…ç†æ—§æ—¥å¿—
// é…ç½®ä¿ç•™ç­–ç•¥
```

### 4. æ•æ„Ÿä¿¡æ¯è„±æ•
```javascript
// è‡ªåŠ¨æ£€æµ‹å’Œéšè—å¯†ç ã€token
// ç¬¦åˆ GDPR ç­‰éšç§æ³•è§„
// å¯é…ç½®çš„è„±æ•è§„åˆ™
```

## è¿ç§»è¿›åº¦

### âœ… å·²å®Œæˆ
- [x] æ—¥å¿—å·¥å…·æ¨¡å—å¼€å‘
- [x] HTTP ä¸­é—´ä»¶å¼€å‘
- [x] `app.js` ä¸»åº”ç”¨æ–‡ä»¶è¿ç§»
- [x] `authController.js` è®¤è¯æ§åˆ¶å™¨è¿ç§»
- [x] `config/redis.js` Redis é…ç½®è¿ç§»

### ğŸ”„ è¿›è¡Œä¸­
- [ ] å‰©ä½™æ§åˆ¶å™¨æ–‡ä»¶è¿ç§»
- [ ] æ•°æ®åº“æ“ä½œæ—¥å¿—é›†æˆ
- [ ] ç¼“å­˜æ“ä½œæ—¥å¿—é›†æˆ

### ğŸ“‹ å¾…åŠ
- [ ] å®Œæ•´çš„é”™è¯¯å †æ ˆè¿½è¸ª
- [ ] ä¸šåŠ¡æŒ‡æ ‡æ—¥å¿—è®°å½•
- [ ] æ—¥å¿—æ€§èƒ½åŸºå‡†æµ‹è¯•
- [ ] ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²éªŒè¯

## é…ç½®ç¤ºä¾‹

### ç¯å¢ƒå˜é‡
```bash
# æ—¥å¿—çº§åˆ«æ§åˆ¶
LOG_LEVEL=info              # debug, info, warn, error
NODE_ENV=production         # å½±å“æ—¥å¿—æ ¼å¼

# åº”ç”¨ä¿¡æ¯
npm_package_version=1.0.0   # è‡ªåŠ¨åŒ…å«åœ¨æ—¥å¿—ä¸­
HOSTNAME=api-server-01      # æœåŠ¡å™¨æ ‡è¯†
```

### å¼€å‘ç¯å¢ƒå¯åŠ¨
```bash
LOG_LEVEL=debug NODE_ENV=development npm run dev
```

### ç”Ÿäº§ç¯å¢ƒå¯åŠ¨
```bash
LOG_LEVEL=info NODE_ENV=production npm start
```

## æŠ€æœ¯æ€»ç»“

### æ ¸å¿ƒæˆå°±
1. **å®Œå…¨æ›¿ä»£ console.log**ï¼šæä¾›ç”Ÿäº§çº§åˆ«çš„æ—¥å¿—è§£å†³æ–¹æ¡ˆ
2. **é›¶æ€§èƒ½æŸå¤±**ï¼šå¼‚æ­¥éé˜»å¡çš„é«˜æ•ˆæ—¥å¿—è®°å½•
3. **è¿ç»´å‹å¥½**ï¼šç»“æ„åŒ–æ•°æ®ä¾¿äºç›‘æ§å’Œåˆ†æ
4. **å¼€å‘å‹å¥½**ï¼šç¾åŒ–è¾“å‡ºæå‡è°ƒè¯•ä½“éªŒ

### æ¶æ„ä¼˜åŠ¿
1. **æ¨¡å—åŒ–è®¾è®¡**ï¼šæŒ‰åŠŸèƒ½åŸŸåˆ†ç¦»å…³æ³¨ç‚¹
2. **å¯æ‰©å±•æ€§**ï¼šæ˜“äºæ·»åŠ æ–°çš„æ—¥å¿—ç±»å‹å’Œå¤„ç†å™¨
3. **é…ç½®é©±åŠ¨**ï¼šç¯å¢ƒå˜é‡æ§åˆ¶è¡Œä¸º
4. **å‘åå…¼å®¹**ï¼šæä¾›è¿‡æ¸¡æœŸçš„å…¼å®¹æ¥å£

---

**å®æ–½çŠ¶æ€**: âœ… æ ¸å¿ƒå®Œæˆï¼ŒæŒç»­ä¼˜åŒ–ä¸­
**è´¨é‡è¯„çº§**: A+ (ç”Ÿäº§å°±ç»ª)
**æŠ€æœ¯å€ºåŠ¡**: å·²æ˜¾è‘—å‡å°‘
**ç»´æŠ¤æˆæœ¬**: ä½
